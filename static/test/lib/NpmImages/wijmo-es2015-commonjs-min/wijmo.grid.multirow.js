/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_grid_1=require("wijmo/wijmo.grid"),wijmo_1=require("wijmo/wijmo"),selfModule=require("wijmo/wijmo.grid.multirow");class _Cell extends wijmo_grid_1.Column{constructor(e){super(),this._row=this._col=0,this._rowspan=this._colspan=1,e&&wijmo_1.copy(this,e)}get colspan(){return this._colspan}set colspan(e){this._colspan=wijmo_1.asInt(e,!1,!0),wijmo_1.assert(this._colspan>0,"colspan must be >= 1")}get rowspan(){return this._rowspan}set rowspan(e){this._rowspan=wijmo_1.asInt(e,!1,!0),wijmo_1.assert(this._rowspan>0,"colspan must be >= 1")}}exports._Cell=_Cell;class _MultiRow extends wijmo_grid_1.Row{constructor(e,t,l){super(e),this._idxData=t,this._idxRecord=l}get recordIndex(){return this._idxRecord}get dataIndex(){return this._idxData}}exports._MultiRow=_MultiRow;class _CellGroup extends _Cell{constructor(e,t){if(super(),this._colstart=0,this._g=e,t&&wijmo_1.copy(this,t),!this._cells)throw"Cell group with no cells?";let l=0,s=0,o=0,i=1,r=0;this._cells.forEach((e,t)=>{if(s>0&&s+e.colspan>this._colspan){for(let e=o;e<t;e++)this._cells[e].rowspan=i;l+=i,s=0,o=t,i=e.rowspan}e._row=l,e._col=s,s+=e.colspan,i=Math.max(i,e.rowspan),r+=e.colspan}),this._rowspan=l+1,this._colspan>r&&(this._colspan=r);for(let e=0;e<this._cells.length;e++){let t=this._cells[e];(e==this._cells.length-1||this._cells[e+1]._row>t._row)&&(s=t._col,t._colspan=this._colspan-s)}}_copy(e,t){return"cells"==e&&(this._cells=[],wijmo_1.isArray(t)&&t.forEach(e=>{let t=new _Cell(e);!e.header&&t.binding&&(t.header=wijmo_1.toHeaderCase(t.binding)),this._cells.push(t),this._colspan=Math.max(this._colspan,t.colspan)}),!0)}get cells(){return this._cells}closeGroup(e){if(e>this._rowspan){for(let t=0;t<this._cells.length;t++){let l=this._cells[t];l._row==this._rowspan-1&&(l._rowspan=e-l._row)}this._rowspan=e}this._cols=new wijmo_grid_1.ColumnCollection(this._g,this._g.columns.defaultSize),this._rng=new Array(e*this._colspan);for(let e=0;e<this._cells.length;e++){let t=this._cells[e];for(let e=0;e<t._rowspan;e++)for(let l=0;l<t._colspan;l++){let s=(t._row+e)*this._colspan+t._col+l;this._cols.setAt(s,t);let o=new wijmo_grid_1.CellRange(0-e,0-l,0-e+t._rowspan-1,0-l+t._colspan-1);o.isSingleCell||(this._rng[s]=o)}}this._rng[-1]=new wijmo_grid_1.CellRange(0,this._colstart,0,this._colstart+this._colspan-1)}getColumnWidth(e){for(let t=0;t<this._cells.length;t++){let l=this._cells[t];if(l._col==e&&1==l.colspan)return l.width}return null}getMergedRange(e,t,l){if(t<0)return this._rng[-1];let s=e.rows[t],o=null!=s.recordIndex?s.recordIndex:t%this._rowspan,i=l-this._colstart,r=this._rng[o*this._colspan+i];return e.cellType==wijmo_grid_1.CellType.ColumnHeader&&t++,r?new wijmo_grid_1.CellRange(t+r.row,l+r.col,t+r.row2,l+r.col2):null}getBindingColumn(e,t,l){if(t<0)return this;let s=e.rows[t],o=s&&null!=s.recordIndex?s.recordIndex:t%this._rowspan,i=l-this._colstart;return this._cols[o*this._colspan+i]}getColumn(e){return this._cols.getColumn(e)}}exports._CellGroup=_CellGroup;class _MergeManager extends wijmo_grid_1.MergeManager{getMergedRange(e,t,l,s=!0){let o=e.grid;switch(e.cellType){case wijmo_grid_1.CellType.Cell:case wijmo_grid_1.CellType.RowHeader:if(e.rows[t]instanceof wijmo_grid_1.GroupRow)return super.getMergedRange(e,t,l,s)}switch(e.cellType){case wijmo_grid_1.CellType.Cell:case wijmo_grid_1.CellType.ColumnHeader:let s=o._cellGroupsByColumn[l];wijmo_1.assert(s instanceof _CellGroup,"Failed to get the group!");let i=e.cellType==wijmo_grid_1.CellType.ColumnHeader?s.getMergedRange(e,t-1,l):s.getMergedRange(e,t,l),r=e.columns.frozen;r&&i&&i.columnSpan>1&&i.col<r&&i.col2>=r&&(i=i.clone(),l<r?i.col2=r-1:i.col=r);let n=e.rows.frozen;return n&&i&&i.rowSpan>1&&e.cellType==wijmo_grid_1.CellType.Cell&&i.row<n&&i.row2>=n&&(i=i.clone(),t<n?i.row2=n-1:i.row=n),i;case wijmo_grid_1.CellType.RowHeader:let a=o._rowsPerItem,_=t-e.rows[t].recordIndex,d=Math.min(_+a-1,e.rows.length-1);return new wijmo_grid_1.CellRange(_,0,d,e.columns.length-1);case wijmo_grid_1.CellType.TopLeft:return new wijmo_grid_1.CellRange(0,0,e.rows.length-1,e.columns.length-1)}return null}}exports._MergeManager=_MergeManager;class MultiRow extends wijmo_grid_1.FlexGrid{constructor(e,t){super(e),this._rowsPerItem=1,this._cellBindingGroups=[],this._centerVert=!0,this._collapsedHeaders=!1,this.collapsedHeadersChanging=new wijmo_1.Event,this.collapsedHeadersChanged=new wijmo_1.Event,wijmo_1.addClass(this.hostElement,"wj-multirow");let l=this.columnHeaders.hostElement.parentElement,s=wijmo_1.createElement('<div class="wj-hdr-collapse"><span></span></div>');s.style.display="none",l.appendChild(s),this._btnCollapse=s,this._updateButtonGlyph(),this.addEventListener(s,"mousedown",e=>{switch(this.collapsedHeaders){case null:case!1:this._collapsedHeadersWasNull=null==this.collapsedHeaders,this.collapsedHeaders=!0;break;case!0:this.collapsedHeaders=!!this._collapsedHeadersWasNull&&null}e.preventDefault(),this.focus()},!0),this.autoGenerateColumns=!1,this.mergeManager=new _MergeManager(this);let o=this.hostElement;this.removeEventListener(o,"dragover"),this.removeEventListener(o,"dragleave"),this.removeEventListener(o,"dragdrop"),this._addHdl=new _MultiRowAddNewHandler(this),this.formatItem.addHandler(this._formatItem,this),this.addEventListener(this.rowHeaders.hostElement,"click",e=>{if(!e.defaultPrevented&&this.selectionMode!=wijmo_grid_1.SelectionMode.None){let t=this.hitTest(e);if(t.panel==this.rowHeaders&&t.row>-1){let t=this.selection,l=this.rows[t.topRow],s=this.selectionMode!=wijmo_grid_1.SelectionMode.Row?this.rows[t.bottomRow]:l;if(l&&null!=l.recordIndex){let o=l.index-l.recordIndex,i=s.index-s.recordIndex+this.rowsPerItem-1,r=this.columns.length-1,n=t.row!=t.topRow?new wijmo_grid_1.CellRange(i,0,o,r):new wijmo_grid_1.CellRange(o,0,i,r);this.select(n),e.preventDefault()}}}},!0),this.initialize(t)}_getProductInfo(){return"H87K,MultiRow"}get layoutDefinition(){return this._layoutDef}set layoutDefinition(e){this._layoutDef=wijmo_1.asArray(e),this._rowsPerItem=1,this._cellBindingGroups=this._parseCellGroups(this._layoutDef),this._cellBindingGroups.forEach(e=>{this._rowsPerItem=Math.max(this._rowsPerItem,e._rowspan)}),this._bindGrid(!0)}get rowsPerItem(){return this._rowsPerItem}getBindingColumn(e,t,l){return this._getBindingColumn(e,t,e.columns[l])}getColumn(e){if(wijmo_1.isString(e)){let t=this._cellBindingGroups,l=null;for(let s=0;s<t.length&&!l;s++)l=t[s].getColumn(e);return l}return super.getColumn(e)}get centerHeadersVertically(){return this._centerVert}set centerHeadersVertically(e){e!=this._centerVert&&(this._centerVert=wijmo_1.asBoolean(e),this.invalidate())}get collapsedHeaders(){return this._collapsedHeaders}set collapsedHeaders(e){if(e!=this._collapsedHeaders){let t=new wijmo_1.CancelEventArgs;this.onCollapsedHeadersChanging(t)&&(this._collapsedHeaders=wijmo_1.asBoolean(e,!0),this._updateCollapsedHeaders(),this._updateButtonGlyph(),this.onCollapsedHeadersChanged(t))}}get showHeaderCollapseButton(){return""==this._btnCollapse.style.display}set showHeaderCollapseButton(e){e!=this.showHeaderCollapseButton&&(this._btnCollapse.style.display=wijmo_1.asBoolean(e)?"":"none")}onCollapsedHeadersChanging(e){return this.collapsedHeadersChanging.raise(this,e),!e.cancel}onCollapsedHeadersChanged(e){this.collapsedHeadersChanged.raise(this,e)}_getQuickAutoSize(){return wijmo_1.isBoolean(this.quickAutoSize)?this.quickAutoSize:this.formatItem.handlerCount<=1&&null==this.itemFormatter}_addBoundRow(e,t){let l=e[t];for(let e=0;e<this._rowsPerItem;e++)this.rows.push(new _MultiRow(l,t,e))}_addNode(e,t,l){this._addBoundRow(e,t)}_bindColumns(){let e=this.columnHeaders.rows,t=this._rowsPerItem+1;for(;e.length>t;)e.removeAt(e.length-1);for(;e.length<t;)e.push(new wijmo_grid_1.Row);this._updateCollapsedHeaders(),this.columns.clear(),this._cellGroupsByColumn={};let l=null,s=this.collectionView;if(s&&s.sourceCollection&&s.sourceCollection.length&&(l=s.sourceCollection[0]),this._cellBindingGroups)for(let e=0;e<this._cellBindingGroups.length;e++){let t=this._cellBindingGroups[e];for(let e=0;e<t._colspan;e++){this._cellGroupsByColumn[this.columns.length]=t;let l=new wijmo_grid_1.Column;for(let s=0;s<t.cells.length;s++){let o=t.cells[s],i="width,minWidth,maxWidth,binding,header,format,dataMap,name,aggregate".split(",");if(o._col==e){i.forEach(e=>{null!=o[e]&&(l[e]=o[e])});break}}this.columns.push(l)}}}_updateCollapsedHeaders(){let e=this.columnHeaders.rows,t=this.collapsedHeaders;e[0].visible=0!=t;for(let l=1;l<e.length;l++)e[l].visible=1!=t}_updateColumnTypes(){super._updateColumnTypes();let e=this.collectionView;if(wijmo_1.hasItems(e)){let t=e.items[0];for(let e=0;e<this._cellBindingGroups.length;e++){let l=this._cellBindingGroups[e];for(let e=0;e<l._cols.length;e++){let s=l._cols[e];null==s.dataType&&s._binding&&(s.dataType=wijmo_1.getType(s._binding.getValue(t)))}}}}_getBindingColumn(e,t,l){if(e==this.cells||e==this.columnHeaders){let s=this._cellGroupsByColumn[l.index];e==this.columnHeaders&&t--,l=s.getBindingColumn(e,t,l.index)}return l}_cvCollectionChanged(e,t){if(this.autoGenerateColumns&&0==this.columns.length)this._bindGrid(!0);else{let e=wijmo_1.NotifyCollectionChangedAction;switch(t.action){case e.Change:this.invalidate();break;case e.Add:if(t.index==this.collectionView.items.length-1){let e=this.rows.length;for(;e>0&&this.rows[e-1]instanceof wijmo_grid_1._NewRowTemplate;)e--;for(let l=0;l<this._rowsPerItem;l++)this.rows.insert(e+l,new _MultiRow(t.item,t.index,l));return}wijmo_1.assert(!1,"added item should be the last one.");break;default:this._bindGrid(!1)}}}_parseCellGroups(e){let t=[],l=1;if(e){for(let s=0,o=0;s<e.length;s++){let i=new _CellGroup(this,e[s]);i._colstart=o,o+=i._colspan,l=Math.max(l,i._rowspan),t.push(i)}for(let e=0;e<t.length;e++)t[e].closeGroup(l)}return t}_formatItem(e,t){let l=this._rowsPerItem,s=t.panel.cellType,o=t.panel.rows[t.range.row],i=t.panel.rows[t.range.row2],r=t.cell;if(s==wijmo_grid_1.CellType.ColumnHeader&&wijmo_1.toggleClass(r,"wj-group-header",0==t.range.row),s==wijmo_grid_1.CellType.Cell||s==wijmo_grid_1.CellType.ColumnHeader){let e=this._cellGroupsByColumn[t.col];wijmo_1.assert(e instanceof _CellGroup,"Failed to get the group!"),wijmo_1.toggleClass(r,"wj-group-start",e._colstart==t.range.col),wijmo_1.toggleClass(r,"wj-group-end",e._colstart+e._colspan-1==t.range.col2)}l>1&&(s!=wijmo_grid_1.CellType.Cell&&s!=wijmo_grid_1.CellType.RowHeader||(wijmo_1.toggleClass(r,"wj-record-start",o instanceof _MultiRow&&0==o.recordIndex),wijmo_1.toggleClass(r,"wj-record-end",i instanceof _MultiRow&&i.recordIndex==l-1)));let n=this.alternatingRowStep;if(n){let e=!1;o instanceof _MultiRow&&(e=o.dataIndex%(n+1)==0,1==n&&(e=!e)),wijmo_1.toggleClass(r,"wj-alt",e)}if(this._centerVert&&!r.getAttribute("wj-state-measuring")){let e=!1;if(r.innerHTML&&t.range.rowSpan>1)if(e=!0,0==r.childElementCount)r.innerHTML="<div>"+r.innerHTML+"</div>";else{let e=document.createElement("div"),t=document.createRange();t.selectNodeContents(r),t.surroundContents(e)}wijmo_1.toggleClass(r,"wj-center-vert",e)}}_updateButtonGlyph(){let e=this._btnCollapse.querySelector("span");e instanceof HTMLElement&&(e.className=this.collapsedHeaders?"wj-glyph-left":"wj-glyph-down-left")}_getError(e,t,l){if(wijmo_1.isFunction(this.itemValidator)&&e==this.rowHeaders)for(let e=0;e<this._rowsPerItem;e++)for(l=0;l<this.columns.length;l++){let s=this.itemValidator(t+e,l);if(s)return s}return super._getError(e,t,l)}}exports.MultiRow=MultiRow;class _MultiRowAddNewHandler extends wijmo_grid_1._AddNewHandler{constructor(e){e._addHdl._detach(),super(e)}updateNewRowTemplate(){let e=this._g.editableCollectionView,t=this._g,l=t.rows,s=e&&e.canAddNew&&t.allowAddNew&&!t.isReadOnly,o=-1;for(let e=0;e<l.length;e+=t.rowsPerItem)if(l[e]instanceof _MultiRowNewRowTemplate){o=e;break}if(s&&o>-1&&(this._top&&o>0||!this._top&&0==o)&&(o=-1,this._removeNewRowTemplate()),s&&o<0)for(let e=0;e<t.rowsPerItem;e++){let t=new _MultiRowNewRowTemplate(e);this._top?l.insert(e,t):l.push(t)}!s&&o>-1&&this._removeNewRowTemplate()}_keydown(e){super._keydown(e),e.defaultPrevented||e.keyCode!=wijmo_1.Key.Escape||this._copyNewDataItem()}_rowEditEnded(e,t){super._rowEditEnded(e,t),this._copyNewDataItem()}_beginningEdit(e,t){super._beginningEdit(e,t),this._top&&!e.rows[0].dataItem&&this._copyNewDataItem()}_copyNewDataItem(){if(this._top){let e=this._g,t=e.rows;for(let l=0;l<e.rowsPerItem;l++)t[l]instanceof wijmo_grid_1._NewRowTemplate&&(t[l].dataItem=this._nrt.dataItem)}}_removeNewRowTemplate(){for(let e=0,t=this._g.rows;e<t.length;e++)t[e]instanceof wijmo_grid_1._NewRowTemplate&&(t.removeAt(e),e--)}}exports._MultiRowAddNewHandler=_MultiRowAddNewHandler;class _MultiRowNewRowTemplate extends wijmo_grid_1._NewRowTemplate{constructor(e){super(),this._idxRecord=e}get recordIndex(){return this._idxRecord}}wijmo_1._registerModule("wijmo.grid.multirow",selfModule);