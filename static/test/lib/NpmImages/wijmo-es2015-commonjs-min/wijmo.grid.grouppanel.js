/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),wijmo_grid_filter_1=require("wijmo/wijmo.grid.filter"),selfModule=require("wijmo/wijmo.grid.grouppanel");class GroupPanel extends wijmo_1.Control{constructor(e,t){super(e),this._hideGroupedCols=!0,this._showDragGlyphs=!0,this._maxGroups=6,this._hiddenCols=[];let i=this.getTemplate();this.applyTemplate("wj-grouppanel wj-control",i,{_divMarkers:"div-markers",_divPH:"div-ph"});let r=this.hostElement;this.addEventListener(r,"dragstart",this._dragStart.bind(this)),this.addEventListener(r,"dragover",this._dragOver.bind(this)),this.addEventListener(r,"drop",this._drop.bind(this)),this.addEventListener(r,"dragend",this._dragEnd.bind(this)),this.addEventListener(r,"click",this._click.bind(this)),this.initialize(t)}get hideGroupedColumns(){return this._hideGroupedCols}set hideGroupedColumns(e){e!=this._hideGroupedCols&&(this._hideGroupedCols=wijmo_1.asBoolean(e))}get showDragGlyphs(){return this._showDragGlyphs}set showDragGlyphs(e){e!=this._showDragGlyphs&&(this._showDragGlyphs=wijmo_1.asBoolean(e),this.refresh())}get maxGroups(){return this._maxGroups}set maxGroups(e){if(e!=this._maxGroups){this._maxGroups=wijmo_1.asNumber(e);let t=this._gds,i=this._maxGroups;t&&i>-1&&i<t.length&&t.splice(i,t.length-i)}}get placeholder(){return this._divPH.textContent}set placeholder(e){this._divPH.textContent=e}get grid(){return this._g}set grid(e){if((e=wijmo_1.asType(e,wijmo_grid_1.FlexGrid,!0))!=this._g){let t=this._g;t&&(t.draggingColumn.removeHandler(this._draggingColumn),t.itemsSourceChanging.removeHandler(this._itemsSourceChanging),t.itemsSourceChanged.removeHandler(this._itemsSourceChanged),t.columns.collectionChanged.removeHandler(this._itemsSourceChanged)),t=this._g=e,this._hiddenCols=[],t&&(t.draggingColumn.addHandler(this._draggingColumn,this),t.itemsSourceChanging.addHandler(this._itemsSourceChanging,this),t.itemsSourceChanged.addHandler(this._itemsSourceChanged,this),t.columns.collectionChanged.addHandler(this._itemsSourceChanged,this)),this._itemsSourceChanged(t,null)}}get filter(){return this._filter}set filter(e){if((e=wijmo_1.asType(e,wijmo_grid_filter_1.FlexGridFilter,!0))!=this._filter){let t=this._filter;t&&t.filterApplied.removeHandler(this.refresh,this),(t=this._filter=e)&&t.filterApplied.addHandler(this.refresh,this),this.refresh()}}refresh(){if(super.refresh(),this._divMarkers.innerHTML="",this._dragMarker=this._dragCol=null,this._gds){let t=this._g,i=t.columnHeaders;for(let r=0;r<this._gds.length;r++){let s=this._gds[r],l=-1,o=-1;for(let e=i.rows.length-1;e>=0&&o<0;e--)for(let r=0;r<i.columns.length&&o<0;r++){let n=t._getBindingColumn(i,e,i.columns[r]);if(n&&n.binding==s.propertyName){o=r,l=e;break}}if(o>-1&&l>-1){let r=document.createElement("div");if(t.cellFactory.updateCell(this._g.columnHeaders,l,o,r),r.setAttribute("class","wj-cell wj-header wj-groupmarker"),wijmo_1.setCss(r,{position:"static",display:"inline-block",verticalAlign:"top",left:"",top:"",right:"",height:"auto",width:"auto"}),this.showDragGlyphs){var e=wijmo_1.createElement('<span class="wj-glyph-drag"></span>');r.insertBefore(e,r.firstChild)}let s=r.querySelector(".wj-elem-filter");s&&wijmo_1.removeChild(s);let n=this._getColumnFilter(i.columns[o]);n&&(s=wijmo_1.createElement('<span class="wj-filter wj-glyph-filter"></span>',r),wijmo_1.toggleClass(s,"wj-filter-on",n.isActive),wijmo_1.toggleClass(s,"wj-filter-off",!n.isActive)),wijmo_1.createElement('<span class="wj-remove">&times;</span>',r),this._divMarkers.appendChild(r)}}let r=this._divMarkers.children.length>0;this._divPH.style.display=r?"none":"",this._divMarkers.style.display=r?"":"none"}}_getColumnFilter(e){let t=this._filter,i=null;return t&&(i=t.filterColumns&&t.filterColumns.indexOf(e.binding)<0?null:t.getColumnFilter(e)),i}_editFilter(e){let t=this._gds,i=this._getElementIndex(e),r=t&&i>-1?t[i]:null,s=r?r.propertyName:null,l=s?this._g.columns.getColumn(s):null;l&&this._filter.editColumnFilter(l,null,e)}_addGroup(e,t){let i=this._getIndex(t),r=this._gds,s=this._maxGroups;for(let t=0;t<r.length;t++)if(r[t].propertyName==e.binding){r.removeAt(t),t<i&&i--;break}if(s>-1)for(let e=s-1;e<r.length;e++)this._removeGroup(e,r),e<i&&i--;(s<0||r.length<s)&&(r.deferUpdate(()=>{let t=new wijmo_1.PropertyGroupDescription(e.binding);r.insert(i,t)}),e&&this.hideGroupedColumns&&(e.visible=!1,this._hiddenCols.push(e)))}_moveGroup(e,t){let i=this._gds,r=this._getElementIndex(this._dragMarker),s=this._getIndex(t);s>r&&s--,s>=this._gds.length&&(s=this._gds.length),r!=s&&i.deferUpdate(()=>{let e=i[r];i.removeAt(r),i.insert(s,e)})}_removeGroup(e,t=this._gds){let i=null;t&&e>-1&&(i=t[e],t.removeAt(e));let r=i?i.propertyName:null,s=r?this._g.columns.getColumn(r):null;if(s){s.visible=!0;let e=this._hiddenCols.indexOf(s);e>-1&&this._hiddenCols.splice(e,1)}}_getIndex(e){let t=e.clientX,i=this._divMarkers.children;for(let e=0;e<i.length;e++){let r=i[e].getBoundingClientRect();if((t-r.left)*(t-r.right)<0)return e}return i.length}_getElementIndex(e){if(e&&e.parentElement){let t=e.parentElement.children;for(let i=0;i<t.length;i++)if(t[i]==e)return i}return-1}_draggingColumn(e,t){let i=this._g,r=i._getBindingColumn(t.panel,t.row,i.columns[t.col]);this._dragCol=r.binding?r:null}_itemsSourceChanging(e,t){this._hiddenCols.forEach(e=>{e.visible=!0}),this._hiddenCols=[]}_itemsSourceChanged(e,t){this._view&&this._view.collectionChanged.removeHandler(this._collectionChanged),this._view=this._g?this._g.collectionView:null,this._gds=this._view?this._view.groupDescriptions:null,this._view&&this._view.collectionChanged.addHandler(this._collectionChanged,this),this.invalidate()}_collectionChanged(e,t){t.action==wijmo_1.NotifyCollectionChangedAction.Reset&&this.invalidate()}_dragStart(e){wijmo_1._startDrag(e.dataTransfer,"move"),this._dragMarker=e.target,this._dragCol=null}_dragOver(e){(this._dragCol||this._dragMarker)&&(e.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation())}_drop(e){this._dragMarker?this._moveGroup(this._dragMarker,e):this._dragCol&&this._addGroup(this._dragCol,e)}_dragEnd(e){this._dragMarker=this._dragCol=null}_click(e){let t=e.target,i=wijmo_1.hasClass(t,"wj-remove"),r=wijmo_1.hasClass(t,"wj-filter"),s=wijmo_1.closest(t,".wj-cell");if(wijmo_1.hasClass(s,"wj-cell")){let t=this._getElementIndex(s),l=this._g.collectionView.sortDescriptions;if(r)this._editFilter(s);else if(i)this._removeGroup(t);else if(e.ctrlKey)l.clear();else{let e=this._gds[t],i=!0;for(let t=0;t<l.length;t++)if(l[t].property==e.propertyName){i=!l[t].ascending;break}let r=new wijmo_1.SortDescription(e.propertyName,i);l.splice(0,l.length,r)}}}}GroupPanel.controlTemplate='<div style="cursor:default;overflow:hidden;height:100%;width:100%;min-height:1em"><div wj-part="div-ph"></div><div wj-part="div-markers"></div></div>',exports.GroupPanel=GroupPanel,wijmo_1._registerModule("wijmo.grid.grouppanel",selfModule);