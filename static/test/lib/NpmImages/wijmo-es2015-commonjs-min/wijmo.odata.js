/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),selfModule=require("wijmo/wijmo.odata");function softGrid(){return wijmo_1._getModule("wijmo.grid")}function softFilter(){return wijmo_1._getModule("wijmo.grid.filter")}exports.softGrid=softGrid,exports.softFilter=softFilter;class ODataCollectionView extends wijmo_1.CollectionView{constructor(t,e,i){super(),this._count=0,this._sortOnServer=!0,this._pageOnServer=!0,this._filterOnServer=!0,this._showDatesAsGmt=!1,this._inferDataTypes=!0,this._reviverBnd=this._reviver.bind(this),this.loading=new wijmo_1.Event,this.loaded=new wijmo_1.Event,this.error=new wijmo_1.Event,this._url=wijmo_1.asString(t,!1),this._tbl=wijmo_1.asString(e),i&&wijmo_1.copy(this,i),this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&this._getData()}),this._getData()}get tableName(){return this._tbl}get fields(){return this._fields}set fields(t){this._fields!=t&&(this._fields=wijmo_1.asArray(t),this._getData())}get requestHeaders(){return this._requestHeaders}set requestHeaders(t){this._requestHeaders=t}get keys(){return this._keys}set keys(t){this._keys=wijmo_1.asArray(t)}get expand(){return this._expand}set expand(t){this._expand=wijmo_1.asString(t)}get jsonReviver(){return this._jsonReviver}set jsonReviver(t){this._jsonReviver=wijmo_1.asFunction(t)}get dataTypes(){return this._dataTypes}set dataTypes(t){this._dataTypes=t}get inferDataTypes(){return this._inferDataTypes}set inferDataTypes(t){t!=this.inferDataTypes&&(this._inferDataTypes=wijmo_1.asBoolean(t),this._getData())}get showDatesAsGmt(){return this._showDatesAsGmt}set showDatesAsGmt(t){t!=this.showDatesAsGmt&&(this._showDatesAsGmt=wijmo_1.asBoolean(t),this._getData())}get sortOnServer(){return this._sortOnServer}set sortOnServer(t){t!=this._sortOnServer&&(this._sortOnServer=wijmo_1.asBoolean(t),this._getData())}get pageOnServer(){return this._pageOnServer}set pageOnServer(t){t!=this._pageOnServer&&(this._pageOnServer=wijmo_1.asBoolean(t),this.pageSize&&this._getData())}get filterOnServer(){return this._filterOnServer}set filterOnServer(t){t!=this._filterOnServer&&(this._filterOnServer=wijmo_1.asBoolean(t),this._getData())}get filterDefinition(){return this._filterDef}set filterDefinition(t){t!=this._filterDef&&(this._filterDef=wijmo_1.asString(t),this._getData())}updateFilterDefinition(t){this.filterOnServer&&softGrid()&&softFilter()&&t instanceof softFilter().FlexGridFilter&&(this.filterDefinition=this._asODataFilter(t))}get oDataVersion(){return this._odv}set oDataVersion(t){this._odv=wijmo_1.asNumber(t)}get isLoading(){return this._loading}onLoading(t){this.loading.raise(this,t)}onLoaded(t){this.loaded.raise(this,t)}load(){this._getData()}onError(t){return this.error.raise(this,t),!t.cancel}commitNew(){let t={Accept:"application/json"};if(this.requestHeaders)for(let e in this.requestHeaders)t[e]=this.requestHeaders[e];let e=this.currentAddItem;if(e){let i=this._getWriteUrl();wijmo_1.httpRequest(i,{method:"POST",requestHeaders:t,data:this._convertToDbFormat(e),success:t=>{let i=JSON.parse(t.responseText,this._reviverBnd);this.keys.forEach(t=>{e[t]=i[t]}),this.refresh()},error:this._error.bind(this)})}super.commitNew()}commitEdit(){let t=this.currentEditItem;if(t&&!this.currentAddItem&&this._getChangedFields(t,this._edtClone)){let e=this._getWriteUrl(this._edtClone);wijmo_1.httpRequest(e,{method:"PUT",requestHeaders:this.requestHeaders,data:this._convertToDbFormat(t),error:this._error.bind(this)})}super.commitEdit()}remove(t){if(t&&t!=this.currentAddItem&&this.items.indexOf(t)>-1){let e=this._getWriteUrl(t);wijmo_1.httpRequest(e,{method:"DELETE",requestHeaders:this.requestHeaders,error:this._error.bind(this)})}super.remove(t)}get totalItemCount(){return this._count}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(t){t!=this._pgSz&&(this._pgSz=wijmo_1.asInt(t),this.pageOnServer?(this._pgIdx=wijmo_1.clamp(this._pgIdx,0,this.pageCount-1),this._getData()):this.refresh())}onPageChanging(t){return super.onPageChanging(t),!t.cancel&&this.pageOnServer&&this._getData(),!t.cancel}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_performRefresh(){let t=this._canFilter,e=this._canSort;this._canFilter=!this._filterOnServer,this._canSort=!this._sortOnServer,super._performRefresh(),this._canFilter=t,this._canSort=e}_storeItems(t,e){e?Array.prototype.push.apply(this.sourceCollection,t):this.sourceCollection=t}_getReadUrl(t){let e=this._url;return"/"!=e[e.length-1]&&(e+="/"),t?e=0==t.indexOf("http")?t:e+t:this._tbl&&(e+=this._tbl),e}_getReadParams(t){let e={$format:"json"};if(this._tbl&&!t){if(this._odv<4?e.$inlinecount="allpages":e.$count=!0,this.fields&&(e.$select=this.fields.join(",")),this.expand&&(e.$expand=this.expand),this.sortOnServer&&this.sortDescriptions.length){let t="";for(let e=0;e<this.sortDescriptions.length;e++){let i=this.sortDescriptions[e];t&&(t+=","),t+=i.property,i.ascending||(t+=" desc")}e.$orderby=t}this.pageOnServer&&this.pageSize>0&&(e.$skip=this.pageIndex*this.pageSize,e.$top=this.pageSize),this.filterDefinition&&(e.$filter=this.filterDefinition)}return e}_getData(t,e){this._toGetData&&clearTimeout(this._toGetData),this._toGetData=setTimeout(()=>{if(null==this._odv)return void this._getSchema();this._loading=!0,this.onLoading();let i=wijmo_1.httpRequest(this._getReadUrl(t),{requestHeaders:this.requestHeaders,data:this._getReadParams(t),success:e=>{let i=JSON.parse(e.responseText,this._reviverBnd),s=i.d?i.d.results:i.value,r=i.d?i.d.__count:i["odata.count"]||i["@odata.count"];if(null!=r&&(this._count=parseInt(r)),this.pageIndex>0&&this.pageIndex>=this.pageCount){let t=this.pageIndex;if(this.moveToLastPage(),this.pageIndex!=t)return}t||this.inferDataTypes&&!this._dataTypesInferred&&(this._dataTypesInferred=this._getInferredDataTypes(s));let a=this.dataTypes?this.dataTypes:this._dataTypesInferred;if(a)for(let t=0;t<s.length;t++)this._convertItem(a,s[t]);this._storeItems(s,null!=t),this.refresh(),(t=i.d?i.d.__next:i["odata.nextLink"]||i["@odata.nextLink"])?this._getData(t):(this._loading=!1,this.onLoaded())},error:t=>{if(this._loading=!1,this.onLoaded(),this.onError(new wijmo_1.RequestErrorEventArgs(t)))throw"HttpRequest Error: "+t.status+" "+t.statusText}});wijmo_1.isFunction(e)&&e(i)},100)}_convertToDbFormat(t){let e={};for(let i in t){let s=t[i];wijmo_1.isDate(s)&&this._showDatesAsGmt?s=new Date(s.getTime()-6e4*s.getTimezoneOffset()):wijmo_1.isNumber(s)&&this._odv<4&&(s=s.toString()),e[i]=s}return e}_reviver(t,e){return"string"==typeof e&&ODataCollectionView._rxDate.test(e)&&(e=0==e.indexOf("/Date(")?new Date(parseInt(e.substr(6))):new Date(e),wijmo_1.isDate(e)&&this._showDatesAsGmt&&(e=new Date(e.getTime()+6e4*e.getTimezoneOffset()))),this._jsonReviver?this._jsonReviver(t,e):e}_convertItem(t,e){for(let i in t){let s=t[i],r=e[i];null!=r&&(r=s==wijmo_1.DataType.Date&&wijmo_1.isString(r)&&0==r.indexOf("/Date(")?new Date(parseInt(r.substr(6))):wijmo_1.changeType(r,s,null),wijmo_1.isDate(r)&&this._showDatesAsGmt&&(r=new Date(r.getTime()+6e4*r.getTimezoneOffset())),e[i]=r)}}_getInferredDataTypes(t){let e=null;if(t.length>0){let i={};for(let e=0;e<t.length&&e<10;e++)this._extend(i,t[e]);for(let t in i){let s=i[t];wijmo_1.isString(s)&&ODataCollectionView._rxDate.test(s)&&(e||(e={}),e[t]=wijmo_1.DataType.Date)}}return e}_getServiceUrl(){let t=this._url;return"/"!=t[t.length-1]&&(t+="/"),t}_getSchema(){let t=this._getServiceUrl()+"$metadata",e=ODataCollectionView._odvCache;this._odv=e[t],this._odv?this._getData():wijmo_1.httpRequest(t,{requestHeaders:this.requestHeaders,success:i=>{let s=i.responseText.match(/<.*Version\s*=\s*"([0-9.]+)"/),r=s?parseFloat(s[1]):4;e[t]=this._odv=r},error:i=>{e[t]=this._odv=4},complete:t=>{this._getData()}})}_getWriteUrl(t){let e=this._getServiceUrl();if(e+=this._tbl,t){wijmo_1.assert(this.keys&&this.keys.length>0,"write operations require keys.");let i=[];this.keys.forEach(e=>{wijmo_1.assert(null!=t[e],"key values cannot be null."),i.push(e+"="+t[e])}),e+="("+i.join(",")+")"}return e}_asODataFilter(t){let e="";for(let i=0;i<t.grid.columns.length;i++){let s=t.grid.columns[i],r=t.getColumnFilter(s,!1);r&&r.isActive&&(e&&(e+=" and "),r.conditionFilter&&r.conditionFilter.isActive?e+=this._asODataConditionFilter(r.conditionFilter):r.valueFilter&&r.valueFilter.isActive&&(e+=this._asODataValueFilter(r.valueFilter)))}return e}_asODataValueFilter(t){let e=t.column,i=e.binding,s=e.dataMap,r=(t._getUniqueValues(e,!1),"");for(let a in t.showValues){let t=wijmo_1.changeType(a,e.dataType,e.format);s&&wijmo_1.isString(t)&&(t=s.getKeyValue(t)),r&&(r+=" or "),r+=this._asEquals(i,t,e.dataType)}return r.length&&(r="("+r+")"),r}_asEquals(t,e,i){return i==wijmo_1.DataType.Date?"("+t+" ge "+this._asODataValue(e,i)+" and "+t+" lt "+this._asODataValue(wijmo_1.DateTime.addDays(e,1),i)+")":"("+t+" eq "+this._asODataValue(e,i)+")"}_asODataConditionFilter(t){let e=this._asODataCondition(t,t.condition1),i=this._asODataCondition(t,t.condition2);return e&&i?"("+e+(t.and?" and ":" or ")+i+")":e?"("+e+")":i?"("+i+")":null}_asODataCondition(t,e){let i=t.column.binding,s=this._asODataValue(e.value,t.column.dataType);switch(e.operator){case 0:return this._asEquals(i,e.value,t.column.dataType);case 1:return i+" ne "+s;case 2:return i+" gt "+s;case 3:return i+" ge "+s;case 4:return i+" lt "+s;case 5:return i+" le "+s;case 6:return"startswith("+i+","+s+")";case 7:return"endswith("+i+","+s+")";case 8:return this._odv>=4?"contains("+i+","+s+")":"substringof("+s.toLowerCase()+", tolower("+i+"))";case 9:return this._odv>=4?"not contains("+i+","+s+")":"not substringof("+s.toLowerCase()+", tolower("+i+"))"}}_asODataValue(t,e){return wijmo_1.isDate(t)?(this._showDatesAsGmt&&(t=new Date(t.getTime()-6e4*t.getTimezoneOffset())),t=t.toJSON(),this._odv<4&&(t="datetime'"+t.substr(0,10)+"'"),t):wijmo_1.isString(t)?"'"+t.replace(/'/g,"''")+"'":null!=t?t.toString():e==wijmo_1.DataType.String?"''":null}_error(t){if(this.onError(new wijmo_1.RequestErrorEventArgs(t)))throw this._getData(),"HttpRequest Error: "+t.status+" "+t.statusText}}ODataCollectionView._odvCache={},ODataCollectionView._rxDate=/^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)/,exports.ODataCollectionView=ODataCollectionView;class ODataVirtualCollectionView extends ODataCollectionView{constructor(t,e,i){null==i&&(i={}),i.pageOnServer=!0,i.sortOnServer=!0,i.canGroup=!1,i.pageSize||(i.pageSize=100),super(t,e,i),this._data=[],this.sourceCollection=this._data,this._skip=0,this.setWindow(0,this.pageSize)}setWindow(t,e){this._toSetWindow&&clearTimeout(this._toSetWindow),this._toSetWindow=setTimeout(()=>{this._toSetWindow=null,this._performSetWindow(t,e)},50)}get pageOnServer(){return!0}set pageOnServer(t){if(!t)throw"ODataVirtualCollectionView requires pageOnServer = true."}get sortOnServer(){return!0}set sortOnServer(t){if(!wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView requires sortOnServer = true."}get filterOnServer(){return!0}set filterOnServer(t){if(!wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView requires filterOnServer = true."}get canGroup(){return this._canGroup}set canGroup(t){if(wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView does not support grouping."}_performRefresh(){this.isLoading||(this._refresh=!0),super._performRefresh()}_getReadParams(t){var e=super._getReadParams(t);return t||(e.$skip=this._skip||0,e.$top=this.pageSize),e}_storeItems(t,e){if(this._refresh||this._data.length!=this.totalItemCount){this._data.length=this.totalItemCount;for(var i=0;i<this._data.length;i++)this._data[i]=null;this._refresh=!1}e||(this.currentPosition<0&&this.moveCurrentToFirst(),this._loadOffset=0);var s=this._loadOffset+(this._skip||0);for(i=0;i<t.length;i++)this._data[i+s]=t[i];this._loadOffset+=t.length}_performSetWindow(t,e){this._pendingRequest&&(this._pendingRequest.abort(),this._pendingRequest=null),t=wijmo_1.asInt(t),e=wijmo_1.asInt(e),wijmo_1.assert(e>=t,"Start must be smaller than end.");var i=wijmo_1.isNumber(this._start)&&t>this._start;this._start=t,this._end=e;for(var s=!1,r=t;r<e&&r<this._data.length&&!s;r++)s=null==this._data[r];if(s){var a=Math.max(0,i?t:e-this.pageSize);for(r=a;r<this._data.length&&null!=this._data[r];r++)a++;this._skip=a,this._getData(null,t=>{this._pendingRequest=t})}}}exports.ODataVirtualCollectionView=ODataVirtualCollectionView,wijmo_1._registerModule("wijmo.odata",selfModule);