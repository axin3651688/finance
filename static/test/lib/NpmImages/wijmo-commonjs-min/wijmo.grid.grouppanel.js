/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),wijmo_grid_filter_1=require("wijmo/wijmo.grid.filter"),selfModule=require("wijmo/wijmo.grid.grouppanel"),GroupPanel=function(e){function t(t,i){var r=e.call(this,t)||this;r._hideGroupedCols=!0,r._showDragGlyphs=!0,r._maxGroups=6,r._hiddenCols=[];var o=r.getTemplate();r.applyTemplate("wj-grouppanel wj-control",o,{_divMarkers:"div-markers",_divPH:"div-ph"});var n=r.hostElement;return r.addEventListener(n,"dragstart",r._dragStart.bind(r)),r.addEventListener(n,"dragover",r._dragOver.bind(r)),r.addEventListener(n,"drop",r._drop.bind(r)),r.addEventListener(n,"dragend",r._dragEnd.bind(r)),r.addEventListener(n,"click",r._click.bind(r)),r.initialize(i),r}return __extends(t,e),Object.defineProperty(t.prototype,"hideGroupedColumns",{get:function(){return this._hideGroupedCols},set:function(e){e!=this._hideGroupedCols&&(this._hideGroupedCols=wijmo_1.asBoolean(e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showDragGlyphs",{get:function(){return this._showDragGlyphs},set:function(e){e!=this._showDragGlyphs&&(this._showDragGlyphs=wijmo_1.asBoolean(e),this.refresh())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxGroups",{get:function(){return this._maxGroups},set:function(e){if(e!=this._maxGroups){this._maxGroups=wijmo_1.asNumber(e);var t=this._gds,i=this._maxGroups;t&&i>-1&&i<t.length&&t.splice(i,t.length-i)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"placeholder",{get:function(){return this._divPH.textContent},set:function(e){this._divPH.textContent=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grid",{get:function(){return this._g},set:function(e){if((e=wijmo_1.asType(e,wijmo_grid_1.FlexGrid,!0))!=this._g){var t=this._g;t&&(t.draggingColumn.removeHandler(this._draggingColumn),t.itemsSourceChanging.removeHandler(this._itemsSourceChanging),t.itemsSourceChanged.removeHandler(this._itemsSourceChanged),t.columns.collectionChanged.removeHandler(this._itemsSourceChanged)),t=this._g=e,this._hiddenCols=[],t&&(t.draggingColumn.addHandler(this._draggingColumn,this),t.itemsSourceChanging.addHandler(this._itemsSourceChanging,this),t.itemsSourceChanged.addHandler(this._itemsSourceChanged,this),t.columns.collectionChanged.addHandler(this._itemsSourceChanged,this)),this._itemsSourceChanged(t,null)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(e){if((e=wijmo_1.asType(e,wijmo_grid_filter_1.FlexGridFilter,!0))!=this._filter){var t=this._filter;t&&t.filterApplied.removeHandler(this.refresh,this),(t=this._filter=e)&&t.filterApplied.addHandler(this.refresh,this),this.refresh()}},enumerable:!0,configurable:!0}),t.prototype.refresh=function(){if(e.prototype.refresh.call(this),this._divMarkers.innerHTML="",this._dragMarker=this._dragCol=null,this._gds){for(var t=this._g,i=t.columnHeaders,r=0;r<this._gds.length;r++){for(var o=this._gds[r],n=-1,s=-1,l=i.rows.length-1;l>=0&&s<0;l--)for(var a=0;a<i.columns.length&&s<0;a++){var d=t._getBindingColumn(i,l,i.columns[a]);if(d&&d.binding==o.propertyName){s=a,n=l;break}}if(s>-1&&n>-1){var h=document.createElement("div");if(t.cellFactory.updateCell(this._g.columnHeaders,n,s,h),h.setAttribute("class","wj-cell wj-header wj-groupmarker"),wijmo_1.setCss(h,{position:"static",display:"inline-block",verticalAlign:"top",left:"",top:"",right:"",height:"auto",width:"auto"}),this.showDragGlyphs){var g=wijmo_1.createElement('<span class="wj-glyph-drag"></span>');h.insertBefore(g,h.firstChild)}var _=h.querySelector(".wj-elem-filter");_&&wijmo_1.removeChild(_);var u=this._getColumnFilter(i.columns[s]);u&&(_=wijmo_1.createElement('<span class="wj-filter wj-glyph-filter"></span>',h),wijmo_1.toggleClass(_,"wj-filter-on",u.isActive),wijmo_1.toggleClass(_,"wj-filter-off",!u.isActive)),wijmo_1.createElement('<span class="wj-remove">&times;</span>',h),this._divMarkers.appendChild(h)}}var p=this._divMarkers.children.length>0;this._divPH.style.display=p?"none":"",this._divMarkers.style.display=p?"":"none"}},t.prototype._getColumnFilter=function(e){var t=this._filter,i=null;return t&&(i=t.filterColumns&&t.filterColumns.indexOf(e.binding)<0?null:t.getColumnFilter(e)),i},t.prototype._editFilter=function(e){var t=this._gds,i=this._getElementIndex(e),r=t&&i>-1?t[i]:null,o=r?r.propertyName:null,n=o?this._g.columns.getColumn(o):null;n&&this._filter.editColumnFilter(n,null,e)},t.prototype._addGroup=function(e,t){for(var i=this._getIndex(t),r=this._gds,o=this._maxGroups,n=0;n<r.length;n++)if(r[n].propertyName==e.binding){r.removeAt(n),n<i&&i--;break}if(o>-1)for(n=o-1;n<r.length;n++)this._removeGroup(n,r),n<i&&i--;(o<0||r.length<o)&&(r.deferUpdate(function(){var t=new wijmo_1.PropertyGroupDescription(e.binding);r.insert(i,t)}),e&&this.hideGroupedColumns&&(e.visible=!1,this._hiddenCols.push(e)))},t.prototype._moveGroup=function(e,t){var i=this._gds,r=this._getElementIndex(this._dragMarker),o=this._getIndex(t);o>r&&o--,o>=this._gds.length&&(o=this._gds.length),r!=o&&i.deferUpdate(function(){var e=i[r];i.removeAt(r),i.insert(o,e)})},t.prototype._removeGroup=function(e,t){void 0===t&&(t=this._gds);var i=null;t&&e>-1&&(i=t[e],t.removeAt(e));var r=i?i.propertyName:null,o=r?this._g.columns.getColumn(r):null;if(o){o.visible=!0;var n=this._hiddenCols.indexOf(o);n>-1&&this._hiddenCols.splice(n,1)}},t.prototype._getIndex=function(e){for(var t=e.clientX,i=this._divMarkers.children,r=0;r<i.length;r++){var o=i[r].getBoundingClientRect();if((t-o.left)*(t-o.right)<0)return r}return i.length},t.prototype._getElementIndex=function(e){if(e&&e.parentElement)for(var t=e.parentElement.children,i=0;i<t.length;i++)if(t[i]==e)return i;return-1},t.prototype._draggingColumn=function(e,t){var i=this._g,r=i._getBindingColumn(t.panel,t.row,i.columns[t.col]);this._dragCol=r.binding?r:null},t.prototype._itemsSourceChanging=function(e,t){this._hiddenCols.forEach(function(e){e.visible=!0}),this._hiddenCols=[]},t.prototype._itemsSourceChanged=function(e,t){this._view&&this._view.collectionChanged.removeHandler(this._collectionChanged),this._view=this._g?this._g.collectionView:null,this._gds=this._view?this._view.groupDescriptions:null,this._view&&this._view.collectionChanged.addHandler(this._collectionChanged,this),this.invalidate()},t.prototype._collectionChanged=function(e,t){t.action==wijmo_1.NotifyCollectionChangedAction.Reset&&this.invalidate()},t.prototype._dragStart=function(e){wijmo_1._startDrag(e.dataTransfer,"move"),this._dragMarker=e.target,this._dragCol=null},t.prototype._dragOver=function(e){(this._dragCol||this._dragMarker)&&(e.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation())},t.prototype._drop=function(e){this._dragMarker?this._moveGroup(this._dragMarker,e):this._dragCol&&this._addGroup(this._dragCol,e)},t.prototype._dragEnd=function(e){this._dragMarker=this._dragCol=null},t.prototype._click=function(e){var t=e.target,i=wijmo_1.hasClass(t,"wj-remove"),r=wijmo_1.hasClass(t,"wj-filter"),o=wijmo_1.closest(t,".wj-cell");if(wijmo_1.hasClass(o,"wj-cell")){var n=this._getElementIndex(o),s=this._g.collectionView.sortDescriptions;if(r)this._editFilter(o);else if(i)this._removeGroup(n);else if(e.ctrlKey)s.clear();else{for(var l=this._gds[n],a=!0,d=0;d<s.length;d++)if(s[d].property==l.propertyName){a=!s[d].ascending;break}var h=new wijmo_1.SortDescription(l.propertyName,a);s.splice(0,s.length,h)}}},t.controlTemplate='<div style="cursor:default;overflow:hidden;height:100%;width:100%;min-height:1em"><div wj-part="div-ph"></div><div wj-part="div-markers"></div></div>',t}(wijmo_1.Control);exports.GroupPanel=GroupPanel,wijmo_1._registerModule("wijmo.grid.grouppanel",selfModule);