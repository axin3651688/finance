/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{isString,isArray,CollectionView,Aggregate,assert,asEnum,Rect,Color,asBoolean,isFunction,Point,Size,isNumber,asNumber,asString,asArray,_registerModule}from"wijmo/wijmo";import{FlexPie,_DataPoint,HitTestInfo,SelectionMode,FlexChartBase,DataLabel,_KeyWords,FlexChart,ChartElement,Series,LabelPosition,DataLabelRenderEventArgs,RenderEventArgs,_RectArea,ChartTooltip,_SvgRenderEngine,Legend,Position}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.hierarchical";export class HierarchicalUtil{static parseDataToHierarchical(t,e,i,r){var s,a=[];return t instanceof CollectionView&&t.groups.length>0?a=HierarchicalUtil.parseGroupCV(t,e):t.length>0&&(isString(i)&&i.indexOf(",")>-1&&(i=i.split(",")),r?a=HierarchicalUtil.parseItems(t,e,i,r):(s=HierarchicalUtil.convertFlatData(t,e,i),a=HierarchicalUtil.parseItems(s,"value",i,"items"))),a}static parseGroupCV(t,e){for(var i=[],r=0,s=t.groups.length;r<s;r++){var a=this.parseGroups(t.groups[r],e);i.push(a)}return i}static parseGroups(t,e){var i={};if(i.name=t.name,i.nameField=t.groupDescription.propertyName,i.item=t.items,t.groups&&t.groups.length){i.items=[];for(var r=0,s=t.groups.length;r<s;r++){var a=this.parseGroups(t.groups[r],e);i.items.push(a)}}else t.isBottomLevel&&(i.value=t.getAggregate(Aggregate.Sum,e));return i}static parseItems(t,e,i,r){var s,a=[],l=t.length;for(s=0;s<l;s++)a.push(HierarchicalUtil.parseItem(t[s],e,i,r));return a}static isFlatItem(t,e){return!isArray(t[e])}static convertFlatData(t,e,i){var r,s,a=[],l={},h=t.length;for(r=0;r<h;r++)s=t[r],HierarchicalUtil.convertFlatItem(l,s,e,isArray(i)?i:[i]);return HierarchicalUtil.convertFlatToHierarchical(a,l),a}static convertFlatToHierarchical(t,e){var i=e.flatDataOrder;i&&i.forEach(i=>{var r,s={},a=e[i];s[e.field]=i,a.flatDataOrder?(r=[],HierarchicalUtil.convertFlatToHierarchical(r,a),s.items=r):s.value=a,t.push(s)})}static convertFlatItem(t,e,i,r){var s,a,l,h;return a=(s=r.slice()).shift(),null!=(l=null==(a=isString(a)?a.trim():a)?i:e[a])&&(0===s.length?(t[l]=e[i]||0,t.flatDataOrder?t.flatDataOrder.push(l):t.flatDataOrder=[l],t.field=a):(null==t[l]&&(t[l]={},t.flatDataOrder?t.flatDataOrder.push(l):t.flatDataOrder=[l],t.field=a),h=t[l],HierarchicalUtil.convertFlatItem(h,e,i,s)||(t[l]=e[i])),!0)}static parseItem(t,e,i,r){var s,a,l,h,o,n={};return isArray(r)?h=(o=r.slice()).length?o.shift().trim():"":(o=r,h=r),isArray(i)?(a=null==(a=(s=i.slice()).shift())?a:a.trim(),n.nameField=null==a?e:a,n.name=null==a?t[e]:t[a],l=t[h],0===s.length?n.value=t[e]:l&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,e,s,o):n.value=t[e]||0):(n.nameField=null==i?e:i,n.name=null==i?t[e]:t[i],null!=(l=t[h])&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,e,i,o):n.value=t[e]),n.item=t,n}static parseFlatItem(t,e,i,r){t.items||(t.items=[])}};export var TreeMapType;!function(t){t[t.Squarified=0]="Squarified",t[t.Horizontal=1]="Horizontal",t[t.Vertical=2]="Vertical"}(TreeMapType||(TreeMapType={}));export class TreeMap extends FlexChartBase{constructor(t,e){super(t,null,!0),this._values=[],this._labels=[],this._areas=[],this._sum=0,this._keywords=new _KeyWords,this._processedData=[],this._depth=1,this._itemIndex=0,this._processedItem=[],this._maxDepth=-1,this._tmItems=[],this._colRowLens=[],this._defPalette=[{titleColor:"#033884",maxColor:"#1450a7",minColor:"#83b3f9"},{titleColor:"#a83100",maxColor:"#dc4a0d",minColor:"#ffb190"},{titleColor:"#006658",maxColor:"#008d7a",minColor:"#7deddf"},{titleColor:"#a10046",maxColor:"#df0061",minColor:"#ff8cbe"},{titleColor:"#784d08",maxColor:"#99681a",minColor:"#efc989"},{titleColor:"#54156f",maxColor:"#722a90",minColor:"#cf95e7"},{titleColor:"#998605",maxColor:"#c2ac19",minColor:"#ffef8b"},{titleColor:"#9a0005",maxColor:"#c80c14",minColor:"#ff888d"}],this.applyTemplate("wj-control wj-flexchart wj-treemap",null,null),this._currentRenderEngine=new _SvgRenderEngine(this.hostElement),this._legend=new Legend(this),this._legend.position=Position.None,this._tooltip=new ChartTooltip,this._tooltip.content="<b>{name}</b><br/>{value}",this._tooltip.showDelay=0,this._lbl=new DataLabel,this._lbl.position=LabelPosition.Center,this._lbl._chart=this,this.hostElement.addEventListener("mousemove",t=>{this.isTouching||this._toogleTooltip(t)}),this.hostElement.addEventListener("click",t=>{var e=!0;if(this.maxDepth>0){var i=this.hitTest(t),r=FlexChart._SELECTION_THRESHOLD;if(this.tooltip&&this.tooltip.threshold&&(r=this.tooltip.threshold),i.distance<=r&&i.pointIndex>=-1&&i.pointIndex<this._areas.length){var s=this._areas[i.pointIndex];this._currentItem!=s.item&&(this._currentItem=s.item,this._refreshChart(),e=!1)}}e&&this.isTouching&&this._toogleTooltip(t)}),this.hostElement.addEventListener("contextmenu",t=>{if(this.maxDepth>0){var e=this.hitTest(t),i=FlexChart._SELECTION_THRESHOLD;this.tooltip&&this.tooltip.threshold&&(i=this.tooltip.threshold),e.distance<=i&&this._rollUp()}return t.preventDefault(),!1}),this.hostElement.addEventListener("mouseleave",()=>{this._hideToolTip()}),this.initialize(e),this.refresh()}_rollUp(){this._currentItem=this._currentItem&&this._currentItem.parent?this._currentItem.parent:null,this._refreshChart()}_toogleTooltip(t){var e=this._tooltip;if(e.content){var i=this.hitTest(t);if(i.distance<=e.threshold){var r=this._getLabelContent(i,this.tooltip.content);this._showToolTip(r,new Rect(t.clientX,t.clientY,5,5))}else this._hideToolTip()}}get selectionMode(){return SelectionMode.None}set selectionMode(t){}get _treeMapItems(){return this._tmItems}get tooltip(){return this._tooltip}get binding(){return this._binding}set binding(t){t!=this._binding&&(this._binding=asString(t,!0),this._bindChart())}get type(){return null==this._type?TreeMapType.Squarified:this._type}set type(t){(t=asEnum(t,TreeMapType))!=this._type&&(this._type=t,this.invalidate())}get bindingName(){return this._bindingName}set bindingName(t){t!=this._bindingName&&(assert(null==t||isArray(t)||isString(t),"bindingName should be an array or a string."),this._bindingName=t,this._bindChart())}get dataLabel(){return this._lbl}set dataLabel(t){t!=this._lbl&&(this._lbl=t,this._lbl&&(this._lbl._chart=this))}get childItemsPath(){return this._childItemsPath}set childItemsPath(t){t!=this._childItemsPath&&(assert(null==t||isArray(t)||isString(t),"childItemsPath should be an array or a string."),this._childItemsPath=t,this._bindChart())}get maxDepth(){return this._maxDepth}set maxDepth(t){t!=this._maxDepth&&(this._maxDepth=asNumber(t,!0),this.invalidate())}get palette(){return this._palette}set palette(t){t!=this._palette&&(this._palette=asArray(t),this._tmItems&&this._tmItems.length>0&&this._calculateColorForItems(this._tmItems),this.invalidate())}_initData(){this._sum=0,this._tmItems=[],this._currentItem=null,this._values=[],this._labels=[],this._processedData=[],this._depth=1,this._processedItem=[]}_performBind(){var t;this._initData(),this._cv&&(t=this._cv.items,this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):t&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(t,this.binding,this.bindingName,this.childItemsPath)),this._processedData&&this._processedData.length&&(this._sum=this._calculateValueAndDepth(this._processedData,1),this._sortData(this._processedData),this._values=[],this._getTMItemsAndLabelsAndValues(this._processedData,this._tmItems,1,null),this._calculateColorForItems(this._tmItems)))}_sortData(t){t.forEach(t=>{t.items&&this._sortData(t.items)}),t.sort((t,e)=>e.value-t.value)}_getTMItemsAndLabelsAndValues(t,e,i,r,s){t&&t.length>0&&t.forEach((t,s)=>{var a,l=new _TreeMapItem;l.items=[],l.parent=r,l.depth=i,t.items&&this._getTMItemsAndLabelsAndValues(t.items,l.items,i+1,l),a=t.name?t.name:t.value.toString(),l.label=a,l.value=t.value,null!=r&&(t.value>r.maxValue&&(r.maxValue=t.value),t.value<r.minValue&&(r.minValue=t.value)),e.push(l),this._labels.push(a),this._values.push(t.value)})}_calculateColorForItems(t,e,i){var r=i;t.forEach((t,i)=>{var s=e;1===t.depth&&(s=this._getColor(i)),t.palette=s;var a=t.palette;if(isString(a)){var l=a,h=this._getLightColor(l);t.titleFill=l,t.titleStroke=l,t.fill=h,t.stroke=l}else if(a.maxColor&&a.minColor&&a.titleColor)if(t.titleFill=a.titleColor,t.titleStroke=a.titleColor,null==t.parent)t.fill=a.maxColor,t.stroke=a.maxColor;else{null==r&&(r=new _ColorConverter(a.minColor,t.minValue,a.maxColor,t.maxValue));let e=r._calculateColorByVal(t.value,!0).toString();t.fill=e,t.stroke=e}if(t.items&&t.items.length>0){var o=new _ColorConverter(a.minColor,t.minValue,a.maxColor,t.maxValue);this._calculateColorForItems(t.items,s,o)}})}_getBindData(t,e,i){var r,s=0;i&&(r=t[i]);s=0;return isNumber(r)?s=asNumber(r):r&&(s=parseFloat(r.toString())),!isNaN(s)&&isFinite(s)?e.push(s):(s=0,e.push(s)),s}_calculateValueAndDepth(t,e){var i=0,r=this._values;return this._depth<e&&(this._depth=e),t.forEach(t=>{var s;t.items?(s=this._calculateValueAndDepth(t.items,e+1),t.value=s,r.push(s)):(s=this._getBindData(t,r,"value"),t.value=s),i+=s}),i}_prepareRender(){this._areas=[]}_renderChart(t,e,i){var r,s,a,l=this._rectChart.clone();new Size(l.width,l.height);this.onRendering(new RenderEventArgs(t));var h=e.width,o=e.height;this._tmGroup=t.startGroup(null,null,!0);var n=this._parseMargin(this.plotMargin);this.dataLabel;isNaN(n.left)&&(n.left=TreeMap._MARGIN),isNaN(n.right)&&(n.right=TreeMap._MARGIN),isNaN(n.top)&&(n.top=TreeMap._MARGIN),isNaN(n.bottom)&&(n.bottom=TreeMap._MARGIN),e.top+=n.top;o=e.height-(n.top+n.bottom);e.height=o>0?o:24,e.left+=n.left;h=e.width-(n.left+n.right);e.width=h>0?h:24,this._plotRect=e,r=this._currentItem?[this._currentItem]:this._tmItems,s=null==this._currentItem||this.maxDepth<1?this.maxDepth:this._currentItem&&this._currentItem.items&&this._currentItem.items.length&&this.maxDepth>1?this.maxDepth:this.maxDepth+1,a=this._currentItem?this._currentItem.value:this._sum,this._renderTreeMap(t,e,this._tmGroup,r,a,s),t.endGroup(),this.dataLabel.content&&this.dataLabel.position!=LabelPosition.None&&this._renderLabels(t),this.onRendered(new RenderEventArgs(t))}_renderTreeMap(t,e,i,r,s,a){s>0&&(this._itemIndex=0,this._resetItemRects(this._tmItems),this._calculateItemRects(e,r,s,1,a),this._renderHierarchicalTreeMapItems(t,i,e,this._tmItems,s,1,a))}_resetItemRects(t){t.forEach(t=>{t.rect=new Rect(0,0,0,0),t.isTitle=!1,t.type=this.type,t.items&&t.items.length&&this._resetItemRects(t.items)})}_calculateItemRects(t,e,i,r,s){switch(this.type){case TreeMapType.Horizontal:_TreeMapUtils.horizontal(e,t,i);break;case TreeMapType.Vertical:_TreeMapUtils.vertical(e,t,i);break;case TreeMapType.Squarified:_TreeMapUtils.squarified(e,t,i)}e.forEach((t,e)=>{t.rect.clone();t.items&&t.items.length&&(r===s||r>s&&s>=1||(t.isTitle=!0,this._calculateItemRects(t.itemsRect,t.items,t.value,r+1,s)))})}_renderHierarchicalTreeMapItems(t,e,i,r,s,a,l){var h,o,n,_,c,d=r.length;this.type;if(0!==d)for(var m=0;m<d;m++)h=t.startGroup(TreeMap._CSS_ITEMDEPTH+a),o=r[m],n=Math.abs(o.value),_=o.rect,o.draw(t),c=new _RectArea(_),o.items&&this._renderHierarchicalTreeMapItems(t,h,o.itemsRect,o.items,n,a+1,l),c.tag=this._itemIndex,c.name=o.label,c.value=n,c.item=o,this._areas.push(c),this._itemIndex++,t.endGroup()}_renderLabels(t){var e,i=this._areas.length,r=this.dataLabel,s=r.position,a=r.connectingLine,l=r.border,h=r.offset||0;t.stroke="null",t.fill="transparent",t.strokeWidth=1,t.startGroup("wj-data-labels");for(var o=0;o<i;o++){var n=this._areas[o];if(n){var _=n.rect,c=new HitTestInfo(this,e);c._setData(null,o);var d=this._getLabelContent(c,r.content);if(e=new Point(_.left+_.width/2,_.top+_.height/2),d&&_.width>0&&_.height>0){var m=new DataLabelRenderEventArgs(t,c,e,d);r.onRendering(m)&&(d=m.text,e=m.point,this._renderLabelAndBorder(t,n,_,d,s,h,e,a,2,l))}}}t.endGroup()}_renderLabelAndBorder(t,e,i,r,s,a,l,h,o,n){var _,c="wj-data-label",d="wj-data-label-line";switch(s){case LabelPosition.Top:h&&t.drawLine(l.x,l.y,l.x,l.y-a,d),l.y-=o+a,_=this._renderText(t,e,i,r,l,1,2,c);break;case LabelPosition.Bottom:h&&t.drawLine(l.x,l.y,l.x,l.y+a,d),l.y+=o+a,_=this._renderText(t,e,i,r,l,1,0,c);break;case LabelPosition.Left:h&&t.drawLine(l.x,l.y,l.x-a,l.y,d),l.x-=o+a,_=this._renderText(t,e,i,r,l,2,1,c);break;case LabelPosition.Right:h&&t.drawLine(l.x,l.y,l.x+a,l.y,d),l.x+=o+a,_=this._renderText(t,e,i,r,l,0,1,c);break;case LabelPosition.Center:_=this._renderText(t,e,i,r,l,1,1,c)}return n&&_&&t.drawRect(_.left-o,_.top-o,_.width+2*o,_.height+2*o,"wj-data-label-border"),_}_renderText(t,e,i,r,s,a,l,h){var o,n=r,_=e.item;return o=t.measureString(r,h),this.type===TreeMapType.Horizontal&&_.isTitle?(o.width>i.height&&(n=this._cutText(r,o.width,i.height)),FlexChart._renderRotatedText(t,n,s,a,l,s,-90,h),null):(o.width>i.width&&(n=this._cutText(r,o.width,i.width)),FlexChart._renderText(t,n,s,a,l,h))}_cutText(t,e,i){var r="",s=t.length,a=Math.floor((1-(e-i)/e)*s);return t.length>0&&(r=t[0]+(a>1?t.substring(1,a-1)+"..":"")),r}_measureLegendItem(t,e){var i=new Size;if(i.width=Series._LEGEND_ITEM_WIDTH,i.height=Series._LEGEND_ITEM_HEIGHT,e){var r=t.measureString(e,FlexChart._CSS_LABEL,FlexChart._CSS_LEGEND);i.width+=r.width,i.height<r.height&&(i.height=r.height)}return i.width+=3*Series._LEGEND_ITEM_MARGIN,i.height+=2*Series._LEGEND_ITEM_MARGIN,i}_getDesiredLegendSize(t,e,i,r){var s=new Size,a=new Size(i,r),l=this._tmItems.length,h=0,o=0;this._colRowLens=[];for(var n=0;n<l;n++){var _=this._measureLegendItem(t,this._tmItems[n].label);e?(o+_.height>r&&(s.height=r,this._colRowLens.push(h),h=0,o=0),h<_.width&&(h=_.width),o+=_.height):(h+_.width>i&&(s.width=i,this._colRowLens.push(o),o=0,h=0),o<_.height&&(o=_.height),h+=_.width)}return e?(s.height<o&&(s.height=o),this._colRowLens.push(h),s.width=this._colRowLens.reduce((t,e)=>t+e,0),s.width>a.width/2&&(s.width=a.width/2)):(s.width<h&&(s.width=h),this._colRowLens.push(o),s.height=this._colRowLens.reduce((t,e)=>t+e,0),s.height>a.height/2&&(s.height=a.height/2)),s}_renderLegend(t,e,i,r,s,a){for(var l,h=this._rectLegend,o=this._tmItems.length,n=0,_=e.clone(),c=0;c<o;c++){l=this._tmItems[c].label;var d=this._measureLegendItem(t,l);r?_.y+d.height>h.top+h.height+1&&(_.x+=this._colRowLens[n],n++,_.y=e.y):_.x+d.width>h.left+h.width+1&&(_.y+=this._colRowLens[n],n++,_.x=e.x);var m=new Rect(_.x,_.y,d.width,d.height);this._drawLegendItem(t,m,c,l),i.push(m),r?_.y+=d.height:_.x+=d.width}}_drawLegendItem(t,e,i,r){t.strokeWidth=1;var s=Series._LEGEND_ITEM_MARGIN,a=this._getColor(i),l=a&&a.maxColor?a.maxColor:a,h=this._getLightColor(l);t.fill=l,t.stroke=h;var o=e.top+.5*e.height,n=Series._LEGEND_ITEM_WIDTH,_=Series._LEGEND_ITEM_HEIGHT;t.drawRect(e.left+s,o-.5*_,n,_,null),r&&FlexChart._renderText(t,r,new Point(e.left+_+2*s,o),0,1,FlexChart._CSS_LABEL)}_getLabelContent(t,e){return isString(e)?this._keywords.replace(e,t):isFunction(e)?e(t):null}hitTest(t,e){var i=this._toControl(t,e),r=new HitTestInfo(this,i),s=null;if(FlexChart._contains(this._rectHeader,i))r._chartElement=ChartElement.Header;else if(FlexChart._contains(this._rectFooter,i))r._chartElement=ChartElement.Footer;else if(FlexChart._contains(this._rectLegend,i))r._chartElement=ChartElement.Legend,null!==(s=this.legend._hitTest(i))&&s>=0&&s<this._areas.length&&r._setData(null,s);else if(FlexChart._contains(this._rectChart,i)){for(var a,l=this._areas.length,h=NaN,o=0;o<l;o++){var n=i.clone(),_=this._areas[o];_.contains(n)&&(r._setData(null,_.tag),r._dist=0);var c=_.distance(n);void 0!==c&&(isNaN(h)||c<h)&&(h=c,a=_)}0!==r._dist&&null!=a&&(r._setData(null,a.tag),r._dist=h),r._chartElement=ChartElement.ChartArea}else r._chartElement=ChartElement.None;return r}_getHitTestItem(t){var e=null,i=null;return(e=null!=this._cv?this._cv.items:this.itemsSource)&&t<e.length&&(i=e[t]),i}_getHitTestValue(t){return this._values[t]}_getHitTestLabel(t){return this._labels[t]}};TreeMap._CSS_ITEMDEPTH="wj-treemap-item-depth",TreeMap._MARGIN=0;class _TreeMapItem{constructor(){this.items=[],this.maxValue=Number.MIN_VALUE,this.minValue=Number.MAX_VALUE}draw(t){var e=this.rect;t.strokeWidth=0,this.isTitle?(t.fill=this.titleFill,t.stroke=this.titleStroke):(t.fill=this.fill,t.stroke=this.stroke),t.drawRect(e.left,e.top,e.width,e.height,_TreeMapItem._CLASSNAME)}get itemsRect(){var t=this.rect,e=this._rect,i=1===this.depth?2:.5;return this.isTitle?this.type===TreeMapType.Horizontal?new Rect(t.left+t.width+1,t.top,e.width-t.width-2*i,t.height+1):new Rect(t.left,t.top+t.height+1,t.width+1,e.height-t.height-2*i):new Rect(0,0,0,0)}get rect(){var t=this._rect,e=1===this.depth?2:.5,i=t.width,r=t.height,s=t.left,a=t.top;return this.isTitle?(this.type===TreeMapType.Horizontal?(i=t.width>20?20:i,i=Math.max(20,i-2*e),r=r>2*e?r-2*e:0):(r=t.height>20?20:r,r=Math.max(20,r-2*e),i=i>2*e?i-2*e:0),s+=e,a+=e):(i=i>2*e?i-2*e:0,r=r>2*e?r-2*e:0),new Rect(s,a,i,r)}set rect(t){t!=this._rect&&(this._rect=t)}get isTitle(){return this._isTitle}set isTitle(t){var e=asBoolean(t,!0);e!==this._isTitle&&(this._isTitle=e)}}_TreeMapItem._CLASSNAME="wj-treemap-item";class _ColorConverter{constructor(t,e,i,r,s,a){this.minColor=new Color(t),this.minColorValue=e,this.maxColor=new Color(i),this.maxColorValue=r,this.midColorValue=this.originalMidColorValue=a,this._calculateMidColorValue(),this.midColor=this.originalMidColor=new Color(s),this._calculateMidColor()}_resetminColor(t){this.minColor=new Color(t),this._calculateMidColor()}_resetmidColor(t){this.midColor=this.originalMidColor=new Color(t),this._calculateMidColor()}_resetmaxColor(t){this.maxColor=new Color(t),this._calculateMidColor()}_resetminColorValue(t){this.minColorValue=t,this._calculateMidColorValue()}_resetmidColorValue(t){this.midColorValue=this.originalMidColorValue=t,this._calculateMidColorValue()}_resetmaxColorValue(t){this.maxColorValue=t,this._calculateMidColorValue()}_calculateMidColorValue(){null==this.originalMidColorValue&&(this.midColorValue=(this.maxColorValue+this.minColorValue)/2)}_calculateMidColor(){null==this.originalMidColor&&(this.midColor=this._calculateColorByVal(this.midColorValue,!0))}_calculateColorByVal(t,e=!1){var i=this.maxColor,r=this.minColor,s=this.maxColorValue,a=this.minColorValue;if(t>=this.maxColorValue)return new Color(i.toString());if(t<=this.minColorValue)return new Color(r.toString());if(!e){if(t===this.midColorValue)return new Color(this.midColor.toString());t<this.midColorValue?(i=this.midColor,s=this.midColorValue):(r=this.midColor,a=this.midColorValue)}return this._getColor(t,i,s,r,a)}_getColor(t,e,i,r,s){return Color.fromRgba(this._getValueByRatio(t,e.r,i,r.r,s),this._getValueByRatio(t,e.g,i,r.g,s),this._getValueByRatio(t,e.b,i,r.b,s),this._getValueByRatio(t,e.a,i,r.a,s))}_getValueByRatio(t,e,i,r,s){return Math.abs(r+Math.round((t-s)*(e-r)/(i-s)))}}class _TreeMapUtils{static squarified(t,e,i){var r=t.slice(),s=e.clone(),a=s.width*s.height/i;do{var l=_TreeMapUtils.getRowedItems(r,s,a);_TreeMapUtils.layoutRowedItems(e,l,s,s.width>s.height)}while(r.length)}static horizontal(t,e,i){var r=e.clone();t.forEach(t=>{var s=[{item:t,val:t.value*e.width*e.height/i}];_TreeMapUtils.layoutRowedItems(e,s,r,!1)})}static vertical(t,e,i){var r=e.clone();t.forEach(t=>{var s=[{item:t,val:t.value*e.width*e.height/i}];_TreeMapUtils.layoutRowedItems(e,s,r,!0)})}static getNarrowLen(t){return Math.min(t.width,t.height)}static getRowedItem(t,e,i){return{item:t,val:i*t.value}}static getRowedItems(t,e,i){var r=t.shift(),s=[],a=[],l=_TreeMapUtils.getNarrowLen(e),h=_TreeMapUtils.getRowedItem(r,e,i);if(s.push(h),a.push(h),t.length>0)do{if(a.push(_TreeMapUtils.getRowedItem(t[0],e,i)),!(_TreeMapUtils.worst(s,l)>_TreeMapUtils.worst(a,l)))break;s=a.slice(),t.shift()}while(t.length);return s}static layoutRowedItems(t,e,i,r){var s,a=i.left,l=i.top,h=a+i.width,o=l+i.height,n=_TreeMapUtils.sumRowedArray(e);r?(s=0===i.height?0:n/i.height,a+s>=h&&(s=h-a),e.forEach((t,i)=>{var r=0===s?0:t.val/s;(l+r>o||i===e.length-1)&&(r=o-l);var h=new Rect(a,l,s,r);t.item.rect=h,l+=r}),i.left+=s,i.width-=s):(s=0===i.width?0:n/i.width,l+s>=o&&(s=o-l),e.forEach((t,i)=>{var r=0===s?0:t.val/s;(a+r>h||i===e.length-1)&&(r=h-a);var o=new Rect(a,l,r,s);t.item.rect=o,a+=r}),i.top+=s,i.height-=s)}static sumRowedArray(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=t[r].val;return e}static worst(t,e){var i,r,s=_TreeMapUtils.sumRowedArray(t),a=s*s,l=e*e;return i=r=t[0].val,t.forEach((t,e)=>{t.val>i?i=t.val:t.val<r&&(r=t.val)}),Math.max(l*i/a,a/(l*r))}}export class Sunburst extends FlexPie{constructor(t,e){super(t,e),this._selectionIndex=0,this.applyTemplate("wj-sunburst",null,null),this.initialize(e),this.refresh()}get bindingName(){return this._bindName}set bindingName(t){t!=this._bindName&&(assert(null==t||isArray(t)||isString(t),"bindingName should be an array or a string."),this._bindName=t,this._bindChart())}get childItemsPath(){return this._childItemsPath}set childItemsPath(t){t!=this._childItemsPath&&(assert(null==t||isArray(t)||isString(t),"childItemsPath should be an array or a string."),this._childItemsPath=t,this._bindChart())}_initData(){super._initData(),this._processedData=[],this._level=1,this._legendLabels=[],this._processedItem=[],this._values[0]=[]}_performBind(){var t;this._initData(),this._cv&&(t=this._cv.items,this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):t&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(t,this.binding,this.bindingName,this.childItemsPath)),this._processedData&&this._processedData.length&&(this._sums[0]=this._sum=this._calculateValueAndLevel(this._processedData,1),this._processedData.forEach(t=>{this._legendLabels.push(t.name)})))}_calculateValueAndLevel(t,e){var i=0,r=this._values[0],s=this._labels;return this._level<e&&(this._level=e),t.forEach(t=>{var a;t.items?(a=this._calculateValueAndLevel(t.items,e+1),t.value=a,r.push(a),s.push(t.name)):(a=this._getBindData(t,r,s,"value","name"),t.value=a),i+=a}),i}_renderPie(t,e,i,r,s,a){var l=this._getCenter();this._sliceIndex=0,this._parentRef={},this._renderHierarchicalSlices(t,l.x,l.y,this._processedData,this._sum,i,r,s,2*Math.PI,a,1)}_renderHierarchicalSlices(t,e,i,r,s,a,l,h,o,n,_){var c,d,m,u,p,g,v,C,f,w,I=r.length,T=h,b=1==this.reversed;m=(a-l)/this._level,c=a-(this._level-_)*m,d=l+(_-1)*m;for(var x=0;x<I;x++){if(C=e,f=i,v=t.startGroup("wj-slice slice-level"+_),1===_&&(t.fill=this._getColorLight(x),t.stroke=this._getColor(x)),p=r[x],g=Math.abs(p.value),u=Math.abs(g-s)<1e-10?o:o*g/s,w=b?T-.5*u:T+.5*u,n>0&&u<o&&(C+=n*Math.cos(w),f+=n*Math.sin(w)),p.items){let e=this._sliceIndex;for(this._renderHierarchicalSlices(t,C,f,p.items,g,a,l,T,u,0,_+1);e<this._sliceIndex;e++)null==this._parentRef[e]&&(this._parentRef[e]=this._sliceIndex)}this._renderSlice(t,C,f,w,0,this._sliceIndex,c,d,T,u,o),this._processedItem.push(p.item),this._sliceIndex++,b?T-=u:T+=u,t.endGroup(),this._pels.push(v)}}_getLabelsForLegend(){return this._legendLabels||[]}_highlightCurrent(){this.selectionMode!=SelectionMode.None&&this._highlight(!0,this._selectionIndex)}hitTest(t,e){var i=super.hitTest(t,e),r=this._toControl(t,e);if(FlexChartBase._contains(this._rectChart,r)){var s=i.pointIndex,a=this._processedItem[s],l=new _DataPoint(null,s,null,null);l.item=a,i._setDataPoint(l)}return i}_getSelectedItemOffset(t,e){var i=0,r=0,s=0;if(this.selectedItemOffset>0)if(t==this.selectedIndex)s=this.selectedItemOffset;else{let i=this._getSelectedParentIndex(t);if(null!=i){let t=this._areas[i];this.dataLabel.position;s=this.selectedItemOffset,e=((e=t.langle+this._rotationAngles[0])%360+360)%360,e*=Math.PI/180}}return s>0&&(i=Math.cos(e)*s*this._radius,r=Math.sin(e)*s*this._radius),{x:i,y:r}}_getSelectedParentIndex(t){let e=this._parentRef[t];return null!=e?e===this.selectedIndex?e:this._getSelectedParentIndex(e):null}};_registerModule("wijmo.chart.hierarchical",selfModule);