/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{Control,asBoolean,asNumber,asType,setCss,toggleClass,createElement,removeChild,_startDrag,hasClass,closest,PropertyGroupDescription,SortDescription,NotifyCollectionChangedAction,_registerModule}from"wijmo/wijmo";import{FlexGrid}from"wijmo/wijmo.grid";import{FlexGridFilter}from"wijmo/wijmo.grid.filter";import*as selfModule from"wijmo/wijmo.grid.grouppanel";export class GroupPanel extends Control{constructor(e,t){super(e),this._hideGroupedCols=!0,this._showDragGlyphs=!0,this._maxGroups=6,this._hiddenCols=[];let i=this.getTemplate();this.applyTemplate("wj-grouppanel wj-control",i,{_divMarkers:"div-markers",_divPH:"div-ph"});let s=this.hostElement;this.addEventListener(s,"dragstart",this._dragStart.bind(this)),this.addEventListener(s,"dragover",this._dragOver.bind(this)),this.addEventListener(s,"drop",this._drop.bind(this)),this.addEventListener(s,"dragend",this._dragEnd.bind(this)),this.addEventListener(s,"click",this._click.bind(this)),this.initialize(t)}get hideGroupedColumns(){return this._hideGroupedCols}set hideGroupedColumns(e){e!=this._hideGroupedCols&&(this._hideGroupedCols=asBoolean(e))}get showDragGlyphs(){return this._showDragGlyphs}set showDragGlyphs(e){e!=this._showDragGlyphs&&(this._showDragGlyphs=asBoolean(e),this.refresh())}get maxGroups(){return this._maxGroups}set maxGroups(e){if(e!=this._maxGroups){this._maxGroups=asNumber(e);let t=this._gds,i=this._maxGroups;t&&i>-1&&i<t.length&&t.splice(i,t.length-i)}}get placeholder(){return this._divPH.textContent}set placeholder(e){this._divPH.textContent=e}get grid(){return this._g}set grid(e){if((e=asType(e,FlexGrid,!0))!=this._g){let t=this._g;t&&(t.draggingColumn.removeHandler(this._draggingColumn),t.itemsSourceChanging.removeHandler(this._itemsSourceChanging),t.itemsSourceChanged.removeHandler(this._itemsSourceChanged),t.columns.collectionChanged.removeHandler(this._itemsSourceChanged)),t=this._g=e,this._hiddenCols=[],t&&(t.draggingColumn.addHandler(this._draggingColumn,this),t.itemsSourceChanging.addHandler(this._itemsSourceChanging,this),t.itemsSourceChanged.addHandler(this._itemsSourceChanged,this),t.columns.collectionChanged.addHandler(this._itemsSourceChanged,this)),this._itemsSourceChanged(t,null)}}get filter(){return this._filter}set filter(e){if((e=asType(e,FlexGridFilter,!0))!=this._filter){let t=this._filter;t&&t.filterApplied.removeHandler(this.refresh,this),(t=this._filter=e)&&t.filterApplied.addHandler(this.refresh,this),this.refresh()}}refresh(){if(super.refresh(),this._divMarkers.innerHTML="",this._dragMarker=this._dragCol=null,this._gds){let t=this._g,i=t.columnHeaders;for(let s=0;s<this._gds.length;s++){let r=this._gds[s],l=-1,n=-1;for(let e=i.rows.length-1;e>=0&&n<0;e--)for(let s=0;s<i.columns.length&&n<0;s++){let o=t._getBindingColumn(i,e,i.columns[s]);if(o&&o.binding==r.propertyName){n=s,l=e;break}}if(n>-1&&l>-1){let s=document.createElement("div");if(t.cellFactory.updateCell(this._g.columnHeaders,l,n,s),s.setAttribute("class","wj-cell wj-header wj-groupmarker"),setCss(s,{position:"static",display:"inline-block",verticalAlign:"top",left:"",top:"",right:"",height:"auto",width:"auto"}),this.showDragGlyphs){var e=createElement('<span class="wj-glyph-drag"></span>');s.insertBefore(e,s.firstChild)}let r=s.querySelector(".wj-elem-filter");r&&removeChild(r);let o=this._getColumnFilter(i.columns[n]);o&&(r=createElement('<span class="wj-filter wj-glyph-filter"></span>',s),toggleClass(r,"wj-filter-on",o.isActive),toggleClass(r,"wj-filter-off",!o.isActive)),createElement('<span class="wj-remove">&times;</span>',s),this._divMarkers.appendChild(s)}}let s=this._divMarkers.children.length>0;this._divPH.style.display=s?"none":"",this._divMarkers.style.display=s?"":"none"}}_getColumnFilter(e){let t=this._filter,i=null;return t&&(i=t.filterColumns&&t.filterColumns.indexOf(e.binding)<0?null:t.getColumnFilter(e)),i}_editFilter(e){let t=this._gds,i=this._getElementIndex(e),s=t&&i>-1?t[i]:null,r=s?s.propertyName:null,l=r?this._g.columns.getColumn(r):null;l&&this._filter.editColumnFilter(l,null,e)}_addGroup(e,t){let i=this._getIndex(t),s=this._gds,r=this._maxGroups;for(let t=0;t<s.length;t++)if(s[t].propertyName==e.binding){s.removeAt(t),t<i&&i--;break}if(r>-1)for(let e=r-1;e<s.length;e++)this._removeGroup(e,s),e<i&&i--;(r<0||s.length<r)&&(s.deferUpdate(()=>{let t=new PropertyGroupDescription(e.binding);s.insert(i,t)}),e&&this.hideGroupedColumns&&(e.visible=!1,this._hiddenCols.push(e)))}_moveGroup(e,t){let i=this._gds,s=this._getElementIndex(this._dragMarker),r=this._getIndex(t);r>s&&r--,r>=this._gds.length&&(r=this._gds.length),s!=r&&i.deferUpdate(()=>{let e=i[s];i.removeAt(s),i.insert(r,e)})}_removeGroup(e,t=this._gds){let i=null;t&&e>-1&&(i=t[e],t.removeAt(e));let s=i?i.propertyName:null,r=s?this._g.columns.getColumn(s):null;if(r){r.visible=!0;let e=this._hiddenCols.indexOf(r);e>-1&&this._hiddenCols.splice(e,1)}}_getIndex(e){let t=e.clientX,i=this._divMarkers.children;for(let e=0;e<i.length;e++){let s=i[e].getBoundingClientRect();if((t-s.left)*(t-s.right)<0)return e}return i.length}_getElementIndex(e){if(e&&e.parentElement){let t=e.parentElement.children;for(let i=0;i<t.length;i++)if(t[i]==e)return i}return-1}_draggingColumn(e,t){let i=this._g,s=i._getBindingColumn(t.panel,t.row,i.columns[t.col]);this._dragCol=s.binding?s:null}_itemsSourceChanging(e,t){this._hiddenCols.forEach(e=>{e.visible=!0}),this._hiddenCols=[]}_itemsSourceChanged(e,t){this._view&&this._view.collectionChanged.removeHandler(this._collectionChanged),this._view=this._g?this._g.collectionView:null,this._gds=this._view?this._view.groupDescriptions:null,this._view&&this._view.collectionChanged.addHandler(this._collectionChanged,this),this.invalidate()}_collectionChanged(e,t){t.action==NotifyCollectionChangedAction.Reset&&this.invalidate()}_dragStart(e){_startDrag(e.dataTransfer,"move"),this._dragMarker=e.target,this._dragCol=null}_dragOver(e){(this._dragCol||this._dragMarker)&&(e.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation())}_drop(e){this._dragMarker?this._moveGroup(this._dragMarker,e):this._dragCol&&this._addGroup(this._dragCol,e)}_dragEnd(e){this._dragMarker=this._dragCol=null}_click(e){let t=e.target,i=hasClass(t,"wj-remove"),s=hasClass(t,"wj-filter"),r=closest(t,".wj-cell");if(hasClass(r,"wj-cell")){let t=this._getElementIndex(r),l=this._g.collectionView.sortDescriptions;if(s)this._editFilter(r);else if(i)this._removeGroup(t);else if(e.ctrlKey)l.clear();else{let e=this._gds[t],i=!0;for(let t=0;t<l.length;t++)if(l[t].property==e.propertyName){i=!l[t].ascending;break}let s=new SortDescription(e.propertyName,i);l.splice(0,l.length,s)}}}};GroupPanel.controlTemplate='<div style="cursor:default;overflow:hidden;height:100%;width:100%;min-height:1em"><div wj-part="div-ph"></div><div wj-part="div-markers"></div></div>',_registerModule("wijmo.grid.grouppanel",selfModule);