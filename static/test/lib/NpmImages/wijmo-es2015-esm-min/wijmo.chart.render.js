/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{Event,Color,isString,Size,Point,_registerModule}from"wijmo/wijmo";import{_SvgRenderEngine,_Spline,FlexChartBase}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.render";export class _CanvasRenderEngine{constructor(t,e=!1){this._strokeWidth=1,this._fontSize=null,this._fontFamily=null,this._applyCanvasClip=function(t,e){var i=this._canvasRect[e];i&&(t.beginPath(),t.rect(i.left,i.top,i.width,i.height),t.clip(),t.closePath())},this._applyCanvasStyles=function(t,e,i,n,s){var l,a,r,o=this._canvas.getContext("2d"),h=this.stroke,p=this.fill,g=this.strokeWidth;e&&void 0!==e.stroke&&(h=e.stroke),e&&void 0!==e.fill&&(p=this._getOpacityColor(e.fill,e["fill-opacity"])),t&&(a=window.getComputedStyle(t),r=t.getBBox()),s?a?(o.fillStyle=a.fill,l=a.fontStyle+" "+a.fontSize+" "+a.fontFamily,o.font=l,o.font.replace(/\"/g,"'")!==l.replace(/\"/g,"'")&&(l=a.fontStyle+" "+a.fontSize+" "+(o.font.split(" ")[1]||"sans-serif"),o.font=l)):this.fontSize?(o.fillStyle=this.textFill,o.font=this.fontSize+" "+(this.fontFamily||"sans-serif")):this._canvasDefaultFont&&(o.fillStyle=this._canvasDefaultFont.textFill,l=this._canvasDefaultFont.fontSize+" "+this._canvasDefaultFont.fontFamily,o.font=l,o.font.replace(/\"/g,"'")!==l.replace(/\"/g,"'")&&(l=this._canvasDefaultFont.fontSize+" "+(o.font.split(" ")[1]||"sans-serif"),o.font=l)):(a&&(h=a.stroke&&"none"!==a.stroke?a.stroke:h,p=a.fill&&"none"!==a.fill?this._getOpacityColor(a.fill,a["fill-opacity"]):p,g=a.strokeWidth?a.strokeWidth:g),"none"!==h&&null!=h&&(this._applyColor("strokeStyle",h,r),o.lineWidth=+g.replace(/px/g,""),o.stroke()),n&&null!=p&&"transparent"!==p&&"none"!==p&&(this._applyColor("fillStyle",p,r),o.fill()))};this._element=t,this._canvas=document.createElement("canvas"),this._svgEngine=new _SvgRenderEngine(t),this._element.appendChild(this._canvas),this._applyCSSStyles=e}beginRender(){var t,e=this._svgEngine.element,i=this._element;this._applyCSSStyles&&(this._svgEngine.beginRender(),i=e),this._element.appendChild(e),this._canvasRect={},t=window.getComputedStyle(i),this._canvasDefaultFont={fontSize:t.fontSize,fontFamily:t.fontFamily,textFill:t.color}}endRender(){this._applyCSSStyles&&this._svgEngine.endRender(),this._svgEngine.element.parentNode.removeChild(this._svgEngine.element)}setViewportSize(t,e){var i,n,s=this._canvas,l=(s.getContext("2d"),this.fill);this._applyCSSStyles&&this._svgEngine.setViewportSize(t,e),s.width=t,s.height=e,i=window.getComputedStyle(this._element).backgroundColor,n=this.stroke,i&&(this.stroke=null,this.fill=i,this.drawRect(0,0,t,e),this.fill=l,this.stroke=n)}get element(){return this._canvas}get fill(){return this._fill}set fill(t){this._svgEngine.fill=t,this._fill=t}get fontSize(){return this._fontSize}set fontSize(t){this._svgEngine.fontSize=t;var e=null==t||isNaN(t)?t:t+"px";this._fontSize=e}get fontFamily(){return this._fontFamily}set fontFamily(t){this._svgEngine.fontFamily=t,this._fontFamily=t}get stroke(){return this._stroke}set stroke(t){this._svgEngine.stroke=t,this._stroke=t}get strokeWidth(){return this._strokeWidth}set strokeWidth(t){this._svgEngine.strokeWidth=t,this._strokeWidth=t}get textFill(){return this._textFill}set textFill(t){this._svgEngine.textFill=t,this._textFill=t}addClipRect(t,e){t&&e&&(this._applyCSSStyles&&this._svgEngine.addClipRect(t,e),this._canvasRect[e]=t.clone())}drawEllipse(t,e,i,n,s,l){var a,r=this._canvas.getContext("2d");return this._applyCSSStyles&&(a=this._svgEngine.drawEllipse(t,e,i,n,s,l)),r.save(),r.beginPath(),r.ellipse?r.ellipse(t,e,i,n,0,0,2*Math.PI):(r.translate(t,e),r.scale(1,n/i),r.translate(-t,-e),r.arc(t,e,i,0,2*Math.PI),r.scale(1,1)),this._applyCanvasStyles(a,l,s,!0),r.restore(),a}drawRect(t,e,i,n,s,l,a){var r,o=this._canvas.getContext("2d");return this._applyCSSStyles&&(r=this._svgEngine.drawRect(t,e,i,n,s,l,a)),o.save(),this._applyCanvasClip(o,a),o.beginPath(),o.rect(t,e,i,n),this._applyCanvasStyles(r,l,s,!0),o.restore(),r}drawLine(t,e,i,n,s,l){var a,r=this._canvas.getContext("2d");return this._applyCSSStyles&&(a=this._svgEngine.drawLine(t,e,i,n,s,l)),r.save(),r.beginPath(),r.moveTo(t,e),r.lineTo(i,n),this._applyCanvasStyles(a,l,s),r.restore(),a}drawLines(t,e,i,n,s){if(t&&e&&0!==t.length&&0!==e.length){var l,a,r=this._canvas.getContext("2d"),o=Math.min(t.length,e.length);for(this._applyCSSStyles&&(l=this._svgEngine.drawLines([0,1],[1,0],i,n,s)),r.save(),this._applyCanvasClip(r,s),r.beginPath(),r.moveTo(t[0],e[0]),a=1;a<o;a++)r.lineTo(t[a],e[a]);return this._applyCanvasStyles(l,n,i),r.restore(),l}}drawSplines(t,e,i,n,s){if(t&&e&&0!==t.length&&0!==e.length){var l,a,r=this._canvas.getContext("2d"),o=new _Spline(t,e).calculate(),h=o.xs,p=o.ys,g=Math.min(h.length,p.length);for(this._applyCSSStyles&&(l=this._svgEngine.drawSplines([0,1],[1,0],i,n,s)),r.save(),this._applyCanvasClip(r,s),r.beginPath(),r.moveTo(h[0],p[0]),a=1;a<g;a++)r.lineTo(h[a],p[a]);return this._applyCanvasStyles(l,n,i),r.restore(),l}}drawPolygon(t,e,i,n,s){if(t&&e&&0!==t.length&&0!==e.length){var l,a,r=this._canvas.getContext("2d"),o=Math.min(t.length,e.length);for(this._applyCSSStyles&&(l=this._svgEngine.drawPolygon(t,e,i,n,s)),r.save(),this._applyCanvasClip(r,s),r.beginPath(),r.moveTo(t[0],e[0]),a=1;a<o;a++)r.lineTo(t[a],e[a]);return r.closePath(),this._applyCanvasStyles(l,n,i,!0),r.restore(),l}}drawPieSegment(t,e,i,n,s,l,a,r){var o,h=this._canvas.getContext("2d"),p=n,g=n+s;return this._applyCSSStyles&&(o=this._svgEngine.drawPieSegment(t,e,i,n,s,l,a,r)),h.save(),this._applyCanvasClip(h,r),h.beginPath(),h.moveTo(t,e),h.arc(t,e,i,p,g,!1),h.lineTo(t,e),this._applyCanvasStyles(o,a,l,!0),h.restore(),o}drawDonutSegment(t,e,i,n,s,l,a,r,o){var h,p,g,y=this._canvas.getContext("2d"),_=s,v=s+l;return this._applyCSSStyles&&(h=this._svgEngine.drawDonutSegment(t,e,i,n,s,l,a,r,o)),(p=new Point(t,e)).x+=n*Math.cos(_),p.y+=n*Math.sin(_),(g=new Point(t,e)).x+=n*Math.cos(v),g.y+=n*Math.sin(v),y.save(),this._applyCanvasClip(y,o),y.beginPath(),y.moveTo(p.x,p.y),y.arc(t,e,i,_,v,!1),y.lineTo(g.x,g.y),y.arc(t,e,n,v,_,!0),this._applyCanvasStyles(h,r,a,!0),y.restore(),h}drawString(t,e,i,n){var s,l=this._canvas.getContext("2d");return this._applyCSSStyles&&(s=this._svgEngine.drawString(t,e,i,n)),l.save(),l.textBaseline="bottom",this._applyCanvasStyles(s,n,i,!0,!0),l.fillText(t,e.x,e.y),l.restore(),s}drawStringRotated(t,e,i,n,s,l){var a,r=this._canvas.getContext("2d");r.measureText(t);return this._applyCSSStyles&&(a=this._svgEngine.drawStringRotated(t,e,i,n,s,l)),r.save(),r.textBaseline="bottom",r.translate(i.x,i.y),r.rotate(Math.PI/180*n),r.translate(-i.x,-i.y),this._applyCanvasStyles(a,l,s,!0,!0),r.fillText(t,e.x,e.y),r.restore(),a}measureString(t,e,i,n){var s,l=l=this._canvas.getContext("2d");return this._applyCSSStyles?this._svgEngine.measureString(t,e,i,n):(this._applyCanvasStyles(null,null,e,!0,!0),s=l.measureText(t).width,new Size(s,1.5*parseInt(l.font)))}startGroup(t,e,i=!1){var n,s=this._canvas.getContext("2d");return this._applyCSSStyles&&(n=this._svgEngine.startGroup(t,e,i)),s.save(),this._applyCanvasClip(s,e),n}endGroup(){this._applyCSSStyles&&this._svgEngine.endGroup(),this._canvas.getContext("2d").restore()}drawImage(t,e,i,n,s){var l,a=this._canvas.getContext("2d"),r=new Image;return this._applyCSSStyles&&(l=this._svgEngine.drawImage(t,e,i,n,s)),r.onload=function(){a.drawImage(r,e,i,n,s)},r.src=t,l}_getOpacityColor(t,e){var i=new Color(t);return t.indexOf("url")>-1?this.fill:t.indexOf("-")>-1?(this.fill=t,t):(null!=e&&1===i.a&&(i.a=isNaN(e)?1:Number(e)),i.toString())}_applyColor(t,e,i){let n=_GradientColorUtil.tryParse(e),s=this._canvas.getContext("2d");if(null!=n)if(isString(n)||null==i)s[t]=n;else{let e;if(null!=n.x1)e=n.relative?s.createLinearGradient(i.x+n.x1*i.width,i.y+n.y1*i.height,i.x+n.x2*i.width,i.y+n.y2*i.height):s.createLinearGradient(n.x1,n.y1,n.x2,n.y2);else if(null!=n.r)if(n.relative){let t=i.x+n.cx*i.width,l=i.y+n.cy*i.height,a=n.r*i.width,r=n.r*i.height/a,o=i.x+(null==n.fx?n.cx:n.fx)*i.width,h=i.y+(null==n.fy?n.cy:n.fy)*i.height,p=(null==n.fr?0:n.fr)*i.width,g=(null==n.fr?0:n.fr)*i.height,y=Math.min(p,g);e=s.createRadialGradient(o,h/r,y,t,l/r,a),s.setTransform(1,0,0,r,0,0)}else e=s.createRadialGradient(null==n.fx?n.cx:n.fx,null==n.fy?n.cy:n.fy,n.fr||0,n.cx,n.cy,n.r);n.colors&&n.colors.length>0&&null!=e&&n.colors.forEach(t=>{let i=new Color("#000000");null!=t.color&&(i=t.color),null!=t.opacity&&(i.a=t.opacity),e.addColorStop(t.offset,i.toString())}),s[t]=e}}};class _GradientColorUtil{static tryParse(t){if(_GradientColorUtil.parsedColor[t])return _GradientColorUtil.parsedColor[t];if(null==t||-1===t.indexOf("-"))return t;var e,i=t.replace(/\s+/g,"").split(/\-/g),n=i[0][0],s=!1,l=i[0].match(/\(\S+\)/)[0].replace(/[\(\\)]/g,"").split(/\,/g);"l"===n||"L"===n?(e={x1:"0",y1:"0",x2:"0",y2:"0",colors:[]},"l"===n&&(s=!0),["x1","y1","x2","y2"].forEach((t,i)=>{null!=l[i]&&(e[t]=+l[i])})):"r"!==n&&"R"!==n||(e={cx:"0",cy:"0",r:"0",colors:[]},"r"===n&&(s=!0),["cx","cy","r","fx","fy","fr"].forEach((t,i)=>{null!=l[i]&&""!==l[i]&&(e[t]=+l[i])})),e.relative=s,_GradientColorUtil.parsedColor[t]=e;var a=i.length-1;return i.forEach((t,i)=>{t.indexOf(")")>-1&&(t=t.match(/\)\S+/)[0].replace(")",""));var n=t.split(":"),s={color:new Color("#000000")};null!=n[0]&&(s.color=Color.fromString(n[0])),null!=n[1]?s.offset=+n[1]:s.offset=i/a,null!=n[2]&&(s.opacity=+n[2]),e.colors.push(s)}),e}}if(_GradientColorUtil.parsedColor={},FlexChartBase&&FlexChartBase.prototype&&FlexChartBase.prototype._exportToImage){var _exportFn=FlexChartBase.prototype._exportToImage;FlexChartBase.prototype._exportToImage=function(t,e){if("svg"!==t){var i,n,s=new _CanvasRenderEngine(this.hostElement,!0),l=this.rendered;this.rendered=new Event,this._render(s,!1),(n=s.element).parentNode.removeChild(n),i=n.toDataURL("image/"+t),e.call(null,i),n=null,s=null,this.rendered=l}else _exportFn.call(this,t,e)}}_registerModule("wijmo.chart.render",selfModule);