/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{Rect,asInt,Size,asNumber,Point,asArray,assert,asString,asEnum,isNumber,isDate,asDate,Globalize,asType,addClass,asBoolean,isObject,_registerModule}from"wijmo/wijmo";import{SeriesBase,ChartType,_DataPoint,_DataInfo,_LinesArea,_CircleArea,_BasePlotter,LabelPosition,DataPoint,FlexChartCore}from"wijmo/wijmo.chart";import{_minimum,_maximum,_avgTrueRng,_range,_stdDeviation,_sma,_average,_ema,_sum}from"wijmo/wijmo.chart.finance";import*as selfModule from"wijmo/wijmo.chart.finance.analytics";function isValid(t){return isFinite(t)&&!isNaN(t)&&isNumber(t)}export class Fibonacci extends SeriesBase{constructor(t){super(),this._levels=[0,23.6,38.2,50,61.8,100],this._uptrend=!0,this._labelPosition=LabelPosition.Left,this.rendering.addHandler(this._render),this.initialize(t)}get low(){return this._low}set low(t){t!=this._low&&(this._low=asNumber(t,!0),this._invalidate())}get high(){return this._high}set high(t){t!=this._high&&(this._high=asNumber(t,!0),this._invalidate())}get labelPosition(){return this._labelPosition}set labelPosition(t){(t=asEnum(t,LabelPosition,!0))!=this._labelPosition&&(this._labelPosition=t,this._invalidate())}get uptrend(){return this._uptrend}set uptrend(t){t!=this._uptrend&&(this._uptrend=asBoolean(t,!0),this._invalidate())}get levels(){return this._levels}set levels(t){t!=this._levels&&(this._levels=asArray(t,!0),this._invalidate())}get minX(){return this._minX}set minX(t){t!=this._minX&&(this._minX=t,this._invalidate())}get maxX(){return this._maxX}set maxX(t){t!=this._maxX&&(this._maxX=t,this._invalidate())}_getMinX(){return isNumber(this._minX)?this._minX:isDate(this._minX)?asDate(this._minX).valueOf():this._getAxisX().actualMin}_getMaxX(){return isNumber(this._maxX)?this._maxX:isDate(this._maxX)?asDate(this._maxX).valueOf():this._getAxisX().actualMax}_updateLevels(){var t=void 0,e=void 0;if(void 0===this._low||void 0===this._high){var s=super.getValues(0),i=super.getValues(1);if(s)for(var a=s.length,l=this._getMinX(),r=this._getMaxX(),h=0;h<a;h++){var n=s[h],o=i?i[h]:h;o<l||o>r||(isNaN(n)||((void 0===t||t>n)&&(t=n),(void 0===e||e<n)&&(e=n)))}}void 0===this._low&&void 0!==t?this._actualLow=t:this._actualLow=this._low,void 0===this._high&&void 0!==e?this._actualHigh=e:this._actualHigh=this._high}_render(t,e){e.cancel=!0;var s=t;s._updateLevels();var i=s._getAxisX(),a=s._getAxisY(),l=e.engine,r=s._getSymbolStroke(s._chart.series.indexOf(s)),h=_BasePlotter.cloneStyle(s.style,["fill"]),n=_BasePlotter.cloneStyle(s.style,["stroke"]),o=s.chart._plotrectId;l.stroke=r,l.strokeWidth=2,l.textFill=r;var _=s._getMinX(),u=s._getMaxX();_<i.actualMin&&(_=i.actualMin),u>i.actualMax&&(u=i.actualMax),l.startGroup(null,o);for(var d=s._levels?s._levels.length:0,c=0;c<d;c++){var g=s._levels[c],p=i.convert(_),m=i.convert(u),V=s.uptrend?a.convert(s._actualLow+.01*g*(s._actualHigh-s._actualLow)):a.convert(s._actualHigh-.01*g*(s._actualHigh-s._actualLow));if(_DataInfo.isValid(p)&&_DataInfo.isValid(m)&&_DataInfo.isValid(V)&&(l.drawLine(p,V,m,V,null,h),s.labelPosition!=LabelPosition.None)){var v=g.toFixed(1)+"%",x=0;switch((s.uptrend&&0==c||!s.uptrend&&c==d-1)&&(x=2),s.labelPosition){case LabelPosition.Left:FlexChartCore._renderText(l,v,new Point(p,V),0,x,null,null,n);break;case LabelPosition.Center:FlexChartCore._renderText(l,v,new Point(.5*(p+m),V),1,x,null,null,n);break;case LabelPosition.Right:FlexChartCore._renderText(l,v,new Point(m,V),2,x,null,null,n)}}}l.stroke=null,l.strokeWidth=null,l.textFill=null,l.endGroup()}_getChartType(){return ChartType.Line}};export class FibonacciArcs extends SeriesBase{constructor(t){super(),this._levels=[38.2,50,61.8],this._labelPosition=LabelPosition.Top,this.rendering.addHandler(this._render,this),this.initialize(t)}get start(){return this._start}set start(t){t!==this.start&&(this._start=asType(t,DataPoint),this._invalidate())}get end(){return this._end}set end(t){t!==this.end&&(this._end=asType(t,DataPoint),this._invalidate())}get levels(){return this._levels}set levels(t){t!==this._levels&&(this._levels=asArray(t,!1),this._invalidate())}get labelPosition(){return this._labelPosition}set labelPosition(t){(t=asEnum(t,LabelPosition))!==this.labelPosition&&(this._labelPosition=t,this._invalidate())}_render(t,e){e.cancel=!0;var s=this._getX(0),i=this._getY(0),a=this._getX(1),l=this._getY(1);if(!(super._getLength()<=1)&&isValid(s)&&isValid(i)&&isValid(a)&&isValid(l)){var r,h=this._getAxisX(),n=this._getAxisY(),o=e.engine,_=this.chart.series.indexOf(this),u=this._getSymbolStroke(_),d=_BasePlotter.cloneStyle(this.style,["fill"]),c=_BasePlotter.cloneStyle(this.style,["stroke"]);o.stroke=u,o.strokeWidth=2,o.textFill=u;var g,p,m,V,v,x,y,f,P,w=this.chart._plotrectId,k=l-i;r=o.startGroup(null,w),addClass(r,"fibonacci-arcs"),isValid(s)&&isValid(i)&&isValid(a)&&isValid(l)&&o.drawLines([h.convert(s),h.convert(a)],[n.convert(i),n.convert(l)],null,d),V=Math.sqrt(Math.pow(h.convert(a)-h.convert(s),2)+Math.pow(n.convert(l)-n.convert(i),2)),x=new Point(a,l);for(var b=0;b<this.levels.length;b++)if(y=.01*this.levels[b],v=Math.abs(V*y),isValid(x.x)&&isValid(x.y)&&isValid(v)&&(g=h.convert(x.x),p=n.convert(x.y),o.drawDonutSegment(g,p,v,v,k>0?0:Math.PI,Math.PI,null,d),this.labelPosition!==LabelPosition.None&&0!==y)){switch(P=Globalize.format(y,"p1"),f=o.measureString(P,null,null,c),m=k<=0?p-v:p+v,this.labelPosition){case LabelPosition.Center:m+=.5*f.height;break;case LabelPosition.Bottom:m+=k<=0?f.height:0;break;default:m+=k<=0?0:f.height}o.drawString(P,new Point(g-.5*f.width,m),null,c)}o.stroke=null,o.strokeWidth=null,o.textFill=null,o.endGroup()}}_getX(t){var e=null;return 0===t&&this.start?e=this.start.x:1===t&&this.end&&(e=this.end.x),isDate(e)&&(e=asDate(e).valueOf()),e}_getY(t){var e=null;return 0===t&&this.start?e=this.start.y:1===t&&this.end&&(e=this.end.y),e}_getChartType(){return ChartType.Line}};export class FibonacciFans extends SeriesBase{constructor(t){super(),this._levels=[0,23.6,38.2,50,61.8,100],this._labelPosition=LabelPosition.Top,this.rendering.addHandler(this._render,this),this.initialize(t)}get start(){return this._start}set start(t){t!==this.start&&(this._start=asType(t,DataPoint),this._invalidate())}get end(){return this._end}set end(t){t!==this.end&&(this._end=asType(t,DataPoint),this._invalidate())}get levels(){return this._levels}set levels(t){t!==this._levels&&(this._levels=asArray(t,!1),this._invalidate())}get labelPosition(){return this._labelPosition}set labelPosition(t){(t=asEnum(t,LabelPosition))!==this.labelPosition&&(this._labelPosition=t,this._invalidate())}_updateLevels(){if(!this.start||!this.end){var t,e,s,i,a=this.chart._getPlotter(this),l=this._getAxisX(),r=super.getValues(0),h=super.getValues(1)||a.dataInfo.getXVals();r&&r.length>0&&(s=_minimum(r),i=_maximum(r)),h&&h.length>0?(t=_minimum(h),e=_maximum(h)):(t=l.actualMin,e=l.actualMax),isValid(t)&&isValid(s)&&isValid(e)&&isValid(i)&&(this.start=new DataPoint(t,s),this.end=new DataPoint(e,i))}}_render(t,e){e.cancel=!0,this._updateLevels();var s=this._getX(0),i=this._getY(0),a=this._getX(1),l=this._getY(1);if(!(super._getLength()<=1)&&isValid(s)&&isValid(i)&&isValid(a)&&isValid(l)){var r=this._getAxisX(),h=this._getAxisY(),n=this.chart.series.indexOf(this),o=e.engine,_=this._getSymbolStroke(n),u=_BasePlotter.cloneStyle(this.style,["fill"]),d=_BasePlotter.cloneStyle(this.style,["stroke"]);o.stroke=_,o.strokeWidth=2,o.textFill=_;var c,g,p,m,V,v,x,y,f,P,w,k,b,L=l-i,X=a-s,M=this.chart._plotrectId;c=s,p=i,m=l;var B=g=a;o.startGroup(null,M);for(var I=0;I<this.levels.length;I++)if(g=X<0?r.actualMin:r.actualMax,m=(y=((m=p+(P=.01*this.levels[I])*L)-p)/(B-c))*g+(f=m-y*B),L>0&&m>h.actualMax?g=((m=h.actualMax)-f)/y:L<0&&m<h.actualMin&&(g=((m=h.actualMin)-f)/y),isValid(c)&&isValid(p)&&isValid(g)&&isValid(m)&&(V=new Point(r.convert(c),h.convert(p)),v=new Point(r.convert(g),h.convert(m)),o.drawLines([V.x,v.x],[V.y,v.y],null,u),this.labelPosition!=LabelPosition.None)){w=Globalize.format(P,"p1"),k=o.measureString(w,null,null,d),b=180*Math.atan((v.y-V.y)/(v.x-V.x))/Math.PI,x=v.clone(),v.x=X>0?v.x-k.width:v.x;var C,D=b*Math.PI/180,S=new Point,A=new Point,Y=new Point,T=new Point,O=h.convert(h.actualMin),N=h.convert(h.actualMax),W=r.convert(r.actualMin),z=r.convert(r.actualMax),R=x.clone();switch(this.labelPosition){case LabelPosition.Center:v.y+=.5*k.height,R.y+=.5*k.height;break;case LabelPosition.Bottom:v.y+=k.height}X>0?(this.labelPosition===LabelPosition.Top||this.labelPosition===LabelPosition.Center?(T=R.clone(),Y.x=T.x+k.height*Math.sin(D),Y.y=T.y-k.height*Math.cos(D),S.x=T.x-k.width*Math.cos(D)+k.height*Math.sin(D),S.y=T.y-k.width*Math.sin(D)-k.height*Math.cos(D),A.x=T.x-k.width*Math.cos(D),A.y=T.y-k.width*Math.sin(D)):this.labelPosition===LabelPosition.Bottom&&(Y=R.clone(),S.x=Y.x-k.width*Math.cos(D),S.y=Y.y-k.width*Math.sin(D),A.x=S.x-k.height*Math.sin(D),A.y=S.y+k.height*Math.cos(D),T.x=S.x+k.width*Math.cos(D)-k.height*Math.sin(D),T.y=S.y+k.width*Math.sin(D)+k.height*Math.cos(D)),L>0?(Y.y<N&&(y=(h.convertBack(Y.y)-h.convertBack(S.y))/(r.convertBack(Y.x)-r.convertBack(S.x)),f=h.convertBack(Y.y)-y*r.convertBack(Y.x),C=r.convert((h.actualMax-f)/y),v.x-=Math.abs(Y.x-C)),T.x>z&&(v.x-=Math.abs(z-T.x))):L<0&&(T.y>O&&(y=(h.convertBack(A.y)-h.convertBack(T.y))/(r.convertBack(A.x)-r.convertBack(T.x)),f=h.convertBack(T.y)-y*r.convertBack(T.x),C=r.convert((h.actualMin-f)/y),v.x-=Math.max(Math.abs(C-T.x),Math.abs(O-T.y))),Y.x>z&&(v.x-=Math.abs(z-Y.x)))):X<0&&(this.labelPosition===LabelPosition.Top||this.labelPosition===LabelPosition.Center?(A=R.clone(),S.x=A.x+k.height*Math.sin(D),S.y=A.y-k.height*Math.cos(D),T.x=A.x+k.width*Math.cos(D),T.y=A.y+k.width*Math.sin(D),Y.x=S.x+k.width*Math.cos(D),Y.y=S.y+k.width*Math.sin(D)):this.labelPosition===LabelPosition.Bottom&&(S=R.clone(),Y.x=S.x+k.width*Math.cos(D),Y.y=S.y+k.width*Math.sin(D),A.x=S.x-k.height*Math.sin(D),A.y=S.y+k.height*Math.cos(D),T.x=S.x+k.width*Math.cos(D)-k.height*Math.sin(D),T.y=S.y+k.width*Math.sin(D)+k.height*Math.cos(D)),L>0?(S.y<N&&(y=(h.convertBack(S.y)-h.convertBack(Y.y))/(r.convertBack(S.x)-r.convertBack(Y.x)),f=h.convertBack(S.y)-y*r.convertBack(S.x),C=r.convert((h.actualMax-f)/y),v.x+=Math.abs(S.x-C)),A.x<W&&(v.x+=Math.abs(W-A.x))):L<0&&(A.y>O&&(y=(h.convertBack(T.y)-h.convertBack(A.y))/(r.convertBack(T.x)-r.convertBack(A.x)),f=h.convertBack(A.y)-y*r.convertBack(A.x),C=r.convert((h.actualMin-f)/y),v.x+=Math.max(Math.abs(C-A.x),Math.abs(O-A.y))),S.x<W&&(v.x+=Math.abs(W-S.x)))),0===b?o.drawString(w,v,null,d):o.drawStringRotated(w,v,x,b,null,d)}o.stroke=null,o.strokeWidth=null,o.textFill=null,o.endGroup()}}_getX(t){var e=null;return 0===t&&this.start?e=this.start.x:1===t&&this.end&&(e=this.end.x),isDate(e)&&(e=asDate(e).valueOf()),e}_getY(t){var e=null;return 0===t&&this.start?e=this.start.y:1===t&&this.end&&(e=this.end.y),e}_getChartType(){return ChartType.Line}};export class FibonacciTimeZones extends SeriesBase{constructor(t){super(),this._levels=[0,1,2,3,5,8,13,21,34],this._labelPosition=LabelPosition.Right,this.rendering.addHandler(this._render,this),this.initialize(t)}get startX(){return this._startX}set startX(t){t!==this.startX&&(isDate(t)?this._startX=asDate(t):this._startX=asNumber(t),this._invalidate())}get endX(){return this._endX}set endX(t){t!==this.endX&&(isDate(t)?this._endX=asDate(t):this._endX=asNumber(t),this._invalidate())}get levels(){return this._levels}set levels(t){t!==this._levels&&(this._levels=asArray(t,!1),this._invalidate())}get labelPosition(){return this._labelPosition}set labelPosition(t){(t=asEnum(t,LabelPosition))!==this.labelPosition&&(this._labelPosition=t,this._invalidate())}_render(t,e){e.cancel=!0,this._updateLevels();var s=this._getX(0),i=this._getX(1);if(!(super._getLength()<=1)&&isValid(s)&&isValid(i)){var a,l,r,h,n=i-s,o=this._getAxisX(),_=this._getAxisY(),u=this._chart.series.indexOf(this),d=e.engine,c=this._getSymbolStroke(u),g=_BasePlotter.cloneStyle(this.style,["fill"]),p=_BasePlotter.cloneStyle(this.style,["stroke"]),m=_.convert(_.actualMin),V=_.convert(_.actualMax),v=this.chart._plotrectId;if(d.stroke=c,d.strokeWidth=2,d.textFill=c,0!==n){d.startGroup(null,v);for(var x=0;x<this.levels.length;x++)if(!((l=n*(a=this.levels[x])+s)<o.actualMin||o.actualMax<l)&&isValid(l)&&(l=o.convert(l),d.drawLine(l,m,l,V,null,g),this.labelPosition!==LabelPosition.None)){switch(h=Globalize.format(a,"n0"),r=d.measureString(h,null,null,p),this.labelPosition){case LabelPosition.Left:l-=r.width+2;break;case LabelPosition.Center:l-=r.width/2;break;case LabelPosition.Right:l+=2;break;default:l=n<0?l-r.width-2:l+2}d.drawString(h,new Point(l,m),null,p)}d.stroke=null,d.strokeWidth=null,d.textFill=null,d.endGroup()}}}_updateLevels(){var t=this.chart._getPlotter(this),e=super.getValues(1)||t.dataInfo.getXVals();if(!(super._getLength()<=1)){var s=this._getX(0),i=this._getX(1),a=isNumber(s)&&isNumber(i);a||e?!a&&e&&(this._startX=e[0],this._endX=e[1]):(this._startX=0,this._endX=1)}}_getX(t){var e=null;return 0===t?e=this.startX:1===t&&(e=this.endX),isDate(e)&&(e=asDate(e).valueOf()),e}_getChartType(){return ChartType.Line}};export class OverlayIndicatorBase extends SeriesBase{constructor(t){super(t),this._seriesCount=1}get _hitTester(){return this._plotter&&!this.__hitTester&&(this.__hitTester=this._plotter.hitTester),this.__hitTester}_getChartType(){return ChartType.Line}_getXValues(){return super.getValues(1)||this._plotter.dataInfo.getXVals()}_getDataPoint(t,e,s,i,a,l){var r=new _DataPoint(s,i,t,e);return r.y=e,r.yfmt=l._formatValue(e),r.x=t,r.xfmt=a._formatValue(t),r}_shouldCalculate(){return!0}_init(){}_calculate(){}_clearValues(){super._clearValues(),this.__hitTester=null}_getName(t){var e=void 0;if(this.name)if(this.name.indexOf(",")){var s=this.name.split(",");s&&s.length-1>=t&&(e=s[t].trim())}else e=this.name;return e}_getStyles(t){var e=null;if(t<0||null===this._styles)return e;var s=0;for(var i in this._styles){if(s===t&&this._styles.hasOwnProperty(i)){e=this._styles[i];break}s++}return e}legendItemLength(){return this._seriesCount}measureLegendItem(t,e){var s=this._getName(e),i=new Size(0,0);return s&&(i=this._measureLegendItem(t,this._getName(e))),i}drawLegendItem(t,e,s){var i=this._getStyles(s)||this.style;this._getName(s)&&this._drawLegendItem(t,e,this._getChartType(),this._getName(s),i,this.symbolStyle)}};export class SingleOverlayIndicatorBase extends OverlayIndicatorBase{constructor(t){super(t),this._period=14}get period(){return this._period}set period(t){t!==this._period&&(this._period=asInt(t,!1,!0),this._clearValues(),this._invalidate())}getValues(t){var e=null;return super._getLength()<=0?e:(this._shouldCalculate()&&(this._init(),this._calculate()),0===t?e=this._yvals:1===t&&(e=this._xvals),e)}getDataRect(t,e){if(e)return e;var s=null;if(super._getLength()<=0)return s;this._shouldCalculate()&&(this._init(),this._calculate());var i=_minimum(this._xvals),a=_maximum(this._xvals),l=_minimum(this._yvals),r=_maximum(this._yvals);return _DataInfo.isValid(i)&&_DataInfo.isValid(a)&&_DataInfo.isValid(l)&&_DataInfo.isValid(r)&&(s=new Rect(i,l,a-i,r-l)),s}_clearValues(){super._clearValues(),this._xvals=null,this._yvals=null}_shouldCalculate(){return!this._yvals||!this._xvals}_init(){super._init(),this._yvals=[],this._xvals=[]}_getItem(t){return super._getLength()<=0?super._getItem(t):(this._shouldCalculate()&&(this._init(),this._calculate()),t=super._getLength()-_minimum(this._yvals.length,this._xvals.length)+t,super._getItem(t))}};export class WilliamsR extends SingleOverlayIndicatorBase{constructor(t){super(),this.period=14,this.initialize(t)}_calculate(){var t=super._getLength();if(!(t<=0)){var e=super._getBindingValues(0),s=super._getBindingValues(1),i=super._getBindingValues(3),a=this._getXValues();this._yvals=_williamsR(e,s,i,this.period),this._xvals=a?a.slice(this.period-1):_range(this.period-1,t-1)}}};export function _williamsR(t,e,s,i){asArray(t,!1),asArray(e,!1),asArray(s,!1),asInt(i,!1,!0);var a,l=_minimum(t.length,e.length,s.length),r=[],h=[],n=[];for(assert(l>i&&i>1,"Williams %R period must be an integer less than the length of the data and greater than one."),a=i;a<=t.length;a++)r.push(_maximum(t.slice(a-i,a))),h.push(_minimum(e.slice(a-i,a)));for(s.splice(0,i-1),a=0;a<r.length;a++)n.push((r[a]-s[a])/(r[a]-h[a])*-100);return n};export class Stochastic extends OverlayIndicatorBase{constructor(t){super(),this._kPeriod=14,this._dPeriod=3,this._smoothingPeriod=1,this._seriesCount=2,this.rendering.addHandler(this._rendering,this),this.initialize(t)}get kPeriod(){return this._kPeriod}set kPeriod(t){t!==this._kPeriod&&(this._kPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get dPeriod(){return this._dPeriod}set dPeriod(t){t!==this._dPeriod&&(this._dPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get smoothingPeriod(){return this._smoothingPeriod}set smoothingPeriod(t){t!==this._smoothingPeriod&&(this._smoothingPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get styles(){return this._styles}set styles(t){t!==this._styles&&(this._styles=t,this._invalidate())}getDataRect(t,e){if(e)return e;var s=null;if(super._getLength()<=0)return s;this._shouldCalculate()&&(this._init(),this._calculate());var i=this._kVals.concat(this._dVals),a=this._kXVals.concat(this._dXVals),l=_minimum(a),r=_maximum(a),h=_minimum(i),n=_maximum(i);return _DataInfo.isValid(l)&&_DataInfo.isValid(r)&&_DataInfo.isValid(h)&&_DataInfo.isValid(n)&&(s=new Rect(l,h,r-l,n-h)),s}_clearValues(){super._clearValues(),this._kVals=null,this._kXVals=null,this._dVals=null,this._dXVals=null}_shouldCalculate(){return!(this._kVals&&this._kXVals&&this._dVals&&this._dXVals)}_init(){super._init(),this._kVals=[],this._kXVals=[],this._dVals=[],this._dXVals=[]}_calculate(){var t=super._getLength();if(!(super._getLength()<=0)){var e=super._getBindingValues(0),s=super._getBindingValues(1),i=super._getBindingValues(3),a=this._getXValues(),l=_stochastic(e,s,i,this.kPeriod,this.dPeriod,this.smoothingPeriod);this._kVals=l.ks,this._dVals=l.ds,this._kXVals=a?a.slice(this.kPeriod-1):_range(this.kPeriod-1,t-1),this.smoothingPeriod&&this.smoothingPeriod>1&&(this._kXVals=this._kXVals.slice(this._kXVals.length-this._kVals.length,this._kXVals.length)),this._dXVals=this._kXVals.slice(this._kXVals.length-this._dVals.length,this._kXVals.length)}}_rendering(t,e){if(e.cancel=!0,!(super._getLength()<=0)){this._shouldCalculate()&&(this._init(),this._calculate());var s=this.chart.series.indexOf(this),i=e.engine,a=this._getAxisX(),l=this._getAxisY(),r=_BasePlotter.cloneStyle(this.style,["fill"]),h=this._getSymbolStroke(s),n=this.chart._plotrectId,o=null,_=h,u=2,d=null,c=h,g=2;this.styles&&isObject(this.styles)&&(this.styles.kLine&&isObject(this.styles.kLine)&&(_=(o=_BasePlotter.cloneStyle(this.styles.kLine,["fill"])).stroke?o.stroke:h,u=o.strokeWidth?o.strokeWidth:2),this.styles.dLine&&isObject(this.styles.dLine)&&(c=(d=_BasePlotter.cloneStyle(this.styles.dLine,["fill"])).stroke?d.stroke:h,g=d.strokeWidth?d.strokeWidth:2));var p,m,V,v,x=[],y=[],f=[],P=[],w=this._getLength();for(V=0;V<this._kVals.length;V++)v=w-this._kVals.length+V,y.push(a.convert(this._kXVals[V])),x.push(l.convert(this._kVals[V])),(p=this._getDataPoint(this._kXVals[V],this._kVals[V],s,v,a,l)).name=this._getName(0),(m=new _CircleArea(new Point(y[V],x[V]),.5*i.strokeWidth)).tag=p,this._hitTester.add(m,s);for(this._hitTester.add(new _LinesArea(y,x),s),i.stroke=_,i.strokeWidth=u,i.drawLines(y,x,null,r,n),V=0;V<this._dVals.length;V++)v=w-this._dVals.length+V,P.push(a.convert(this._dXVals[V])),f.push(l.convert(this._dVals[V])),(p=this._getDataPoint(this._dXVals[V],this._dVals[V],s,v,a,l)).name=this._getName(1),(m=new _CircleArea(new Point(P[V],f[V]),.5*i.strokeWidth)).tag=p,this._hitTester.add(m,s);this._hitTester.add(new _LinesArea(P,f),s),i.stroke=c,i.strokeWidth=g,i.drawLines(P,f,null,r,n)}}getCalculatedValues(t){t=asString(t,!1);var e=[],s=0;if(super._getLength()<=0)return e;switch(this._shouldCalculate()&&(this._init(),this._calculate()),t){case"kLine":for(;s<this._kVals.length;s++)e.push({x:this._kXVals[s],y:this._kVals[s]});break;case"dLine":for(;s<this._dVals.length;s++)e.push({x:this._dXVals[s],y:this._dVals[s]})}return e}};export function _stochastic(t,e,s,i,a,l){asArray(t,!1),asArray(e,!1),asArray(s,!1),asInt(i,!1,!0),asInt(a,!1,!0),asInt(l,!0,!0);var r,h=[],n=[],o=[];for(r=i;r<=t.length;r++)h.push(_maximum(t.slice(r-i,r))),n.push(_minimum(e.slice(r-i,r)));for(s=s.slice(i-1),r=0;r<s.length;r++)o.push((s[r]-n[r])/(h[r]-n[r])*100);return l&&l>1&&(o=_sma(o,l)),{ks:o,ds:_sma(o,a)}};export class RSI extends SingleOverlayIndicatorBase{constructor(t){super(),this.period=14,this.initialize(t)}_calculate(){var t=super._getLength();if(!(t<=0)){var e=super._getBindingValues(0),s=this._getXValues();this._yvals=_rsi(e,this.period),this._xvals=s?s.slice(this.period):_range(this.period,t)}}};export function _rsi(t,e){asArray(t,!1),asInt(e,!0,!1),assert(t.length>e&&e>1,"RSI period must be an integer less than the length of the data and greater than one.");var s,i,a,l,r=[],h=[],n=[],o=[];for(l=1;l<t.length;l++)r.push(t[l]-t[l-1]);for(s=r.map(t=>t>0?t:0),i=r.map(t=>t<0?Math.abs(t):0),l=e;l<=r.length;l++)l===e?(h.push(_sum(s.slice(l-e,l))/e),n.push(_sum(i.slice(l-e,l))/e)):(h.push((s[l-1]+h[l-e-1]*(e-1))/e),n.push((i[l-1]+n[l-e-1]*(e-1))/e)),a=h[l-e]/n[l-e],a=isFinite(a)?a:0,o.push(100-100/(1+a));return o};export class MacdBase extends OverlayIndicatorBase{constructor(t){super(t),this._fastPeriod=12,this._slowPeriod=26,this._smoothingPeriod=9}get fastPeriod(){return this._fastPeriod}set fastPeriod(t){t!==this._fastPeriod&&(this._fastPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get slowPeriod(){return this._slowPeriod}set slowPeriod(t){t!==this._slowPeriod&&(this._slowPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get smoothingPeriod(){return this._smoothingPeriod}set smoothingPeriod(t){t!==this._smoothingPeriod&&(this._smoothingPeriod=asInt(t,!1,!0),this._clearValues(),this._invalidate())}_clearValues(){super._clearValues(),this._macdVals=null,this._macdXVals=null,this._signalVals=null,this._signalXVals=null,this._histogramVals=null,this._histogramXVals=null}_shouldCalculate(){return!(this._macdVals&&this._macdXVals&&this._signalVals&&this._signalXVals&&this._histogramVals&&this._histogramXVals)}_init(){super._init(),this._macdVals=[],this._macdXVals=[],this._signalVals=[],this._signalXVals=[],this._histogramVals=[],this._histogramXVals=[]}_calculate(){var t=super._getLength();if(!(t<=0)){var e=super.getValues(0),s=this._getXValues(),i=_macd(e,this.fastPeriod,this.slowPeriod,this.smoothingPeriod);this._macdVals=i.macds,this._signalVals=i.signals,this._histogramVals=i.histograms,this._macdXVals=s?s.slice(t-this._macdVals.length,t):_range(t-this._macdVals.length,t-1),this._signalXVals=s?s.slice(t-this._signalVals.length,t):_range(t-this._signalVals.length,t-1),this._histogramXVals=s?s.slice(t-this._histogramVals.length,t):_range(t-this._histogramVals.length,t-1)}}};export class Macd extends MacdBase{constructor(t){super(),this._seriesCount=2,this.rendering.addHandler(this._rendering,this),this.initialize(t)}get styles(){return this._styles}set styles(t){t!==this._styles&&(this._styles=t,this._invalidate())}legendItemLength(){return this.name.indexOf(",")>-1?2:1}getDataRect(t,e){if(e)return e;var s=null;if(super._getLength()<=0)return s;this._shouldCalculate()&&(this._init(),this._calculate());var i=[],a=[];a.push.apply(a,this._macdXVals),a.push.apply(a,this._signalXVals),i.push.apply(i,this._macdVals),i.push.apply(i,this._signalVals);var l=_minimum(a),r=_maximum(a),h=_minimum(i),n=_maximum(i);return _DataInfo.isValid(l)&&_DataInfo.isValid(r)&&_DataInfo.isValid(h)&&_DataInfo.isValid(n)&&(s=new Rect(l,h,r-l,n-h)),s}_rendering(t,e){if(e.cancel=!0,!(super._getLength()<=0)){this._shouldCalculate()&&(this._init(),this._calculate());var s=this.chart.series.indexOf(this),i=e.engine,a=this._getAxisX(),l=this._getAxisY(),r=_BasePlotter.cloneStyle(this.style,["fill"]),h=this._getSymbolStroke(s),n=this.chart._plotrectId,o=null,_=h,u=2,d=null,c=h,g=2;this.styles&&isObject(this.styles)&&(this.styles.macdLine&&isObject(this.styles.macdLine)&&(_=(o=_BasePlotter.cloneStyle(this.styles.macdLine,["fill"])).stroke?o.stroke:h,u=o.strokeWidth?o.strokeWidth:2),this.styles.signalLine&&isObject(this.styles.signalLine)&&(c=(d=_BasePlotter.cloneStyle(this.styles.signalLine,["fill"])).stroke?d.stroke:h,g=d.strokeWidth?d.strokeWidth:2));var p,m,V,v,x=[],y=[],f=[],P=[],w=this._getLength();for(V=0;V<this._macdVals.length;V++)v=w-this._macdVals.length+V,y.push(a.convert(this._macdXVals[V])),x.push(l.convert(this._macdVals[V])),(p=this._getDataPoint(this._macdXVals[V],this._macdVals[V],s,v,a,l)).name=this._getName(0),(m=new _CircleArea(new Point(y[V],x[V]),.5*i.strokeWidth)).tag=p,this._hitTester.add(m,s);for(this._hitTester.add(new _LinesArea(y,x),s),i.stroke=_,i.strokeWidth=u,i.drawLines(y,x,null,r,n),V=0;V<this._signalVals.length;V++)v=w-this._signalVals.length+V,P.push(a.convert(this._signalXVals[V])),f.push(l.convert(this._signalVals[V])),(p=this._getDataPoint(this._signalXVals[V],this._signalVals[V],s,v,a,l)).name=this._getName(1),(m=new _CircleArea(new Point(P[V],f[V]),.5*i.strokeWidth)).tag=p,this._hitTester.add(m,s);this._hitTester.add(new _LinesArea(P,f),s),i.stroke=c,i.strokeWidth=g,i.drawLines(P,f,null,r,n)}}getCalculatedValues(t){t=asString(t,!1);var e=[],s=0;if(super._getLength()<=0)return e;switch(this._shouldCalculate()&&(this._init(),this._calculate()),t){case"macdLine":for(;s<this._macdVals.length;s++)e.push({x:this._macdXVals[s],y:this._macdVals[s]});break;case"signalLine":for(;s<this._signalVals.length;s++)e.push({x:this._signalXVals[s],y:this._signalVals[s]})}return e}};export class MacdHistogram extends MacdBase{constructor(t){super(t)}getValues(t){var e=null;return super._getLength()<=0?e:(this._shouldCalculate()&&(this._init(),this._calculate()),0===t?e=this._histogramVals:1===t&&(e=this._histogramXVals),e)}getDataRect(t,e){if(e)return e;var s=null;if(super._getLength()<=0)return s;this._shouldCalculate()&&(this._init(),this._calculate());var i=_minimum(this._histogramXVals),a=_maximum(this._histogramXVals),l=_minimum(this._histogramVals),r=_maximum(this._histogramVals);return _DataInfo.isValid(i)&&_DataInfo.isValid(a)&&_DataInfo.isValid(l)&&_DataInfo.isValid(r)&&(s=new Rect(i,l,a-i,r-l)),s}_getChartType(){return ChartType.Column}_getItem(t){return t=super._getLength()-_minimum(this._histogramVals.length,this._histogramXVals.length)+t,super._getItem(t)}};export function _macd(t,e,s,i){asArray(t,!1),asInt(e,!1,!0),asInt(s,!1,!0),asInt(i,!1,!0);var a,l=e>s;l&&(a=s,s=e,e=a);var r,h,n=_ema(t,e),o=_ema(t,s),_=[],u=[];for(n.splice(0,s-e),h=0;h<n.length;h++)a=n[h]-o[h],l&&(a*=-1),_.push(a);r=_ema(_,i);var d=_.slice(_.length-r.length,_.length);for(h=0;h<d.length;h++)u.push(d[h]-r[h]);return{macds:_,signals:r,histograms:u}};export var MovingAverageType;!function(t){t[t.Simple=0]="Simple",t[t.Exponential=1]="Exponential"}(MovingAverageType||(MovingAverageType={}));export class Envelopes extends OverlayIndicatorBase{constructor(t){super(),this._period=20,this._type=MovingAverageType.Simple,this._size=.025,this.rendering.addHandler(this._rendering,this),this.initialize(t)}get period(){return this._period}set period(t){t!==this._period&&(this._period=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get type(){return this._type}set type(t){(t=asEnum(t,MovingAverageType,!1))!==this._type&&(this._type=t,this._clearValues(),this._invalidate())}get size(){return this._size}set size(t){t!==this._size&&(this._size=asNumber(t,!1,!0),this._clearValues(),this._invalidate())}getDataRect(t,e){if(e)return e;var s=null;if(super._getLength()<=0)return s;this._shouldCalculate()&&(this._init(),this._calculate());var i=this._upperYVals.concat(this._lowerYVals),a=_minimum(this._xVals),l=_maximum(this._xVals),r=_minimum(i),h=_maximum(i);return _DataInfo.isValid(a)&&_DataInfo.isValid(l)&&_DataInfo.isValid(r)&&_DataInfo.isValid(h)&&(s=new Rect(a,r,l-a,h-r)),s}_clearValues(){super._clearValues(),this._upperYVals=null,this._lowerYVals=null,this._xVals=null}_init(){super._init(),this._upperYVals=[],this._lowerYVals=[],this._xVals=[]}_shouldCalculate(){return!this._upperYVals||!this._lowerYVals||!this._xVals}_calculate(){if(!(super._getLength()<=0)){var t,e=super.getValues(0),s=this._getXValues();switch(this.type){case MovingAverageType.Exponential:t=_ema(e,this.period);break;case MovingAverageType.Simple:default:t=_sma(e,this.period)}this._xVals=s?s.slice(this.period-1):_range(this.period-1,super._getLength()-1),this._upperYVals=t.map(t=>t+t*this.size),this._lowerYVals=t.map(t=>t-t*this.size)}}_rendering(t,e){if(e.cancel=!0,!(super._getLength()<=0)){this._shouldCalculate()&&(this._init(),this._calculate());var s=this.chart.series.indexOf(this),i=e.engine,a=this._getAxisX(),l=this._getAxisY(),r=_minimum(this._upperYVals.length,this._lowerYVals.length,this._xVals.length),h=_BasePlotter.cloneStyle(this.style,["fill"]),n=this._getSymbolStroke(s),o=this.chart._plotrectId;if(r&&!(r<=0)){i.stroke=n,i.strokeWidth=2;for(var _,u,d,c=[],g=[],p=[],m=this._getLength(),V=0;V<r;V++)d=m-r+V,c.push(a.convert(this._xVals[V])),g.push(l.convert(this._upperYVals[V])),_=this._getDataPoint(this._xVals[V],this._upperYVals[V],s,d,a,l),(u=new _CircleArea(new Point(c[V],g[V]),.5*i.strokeWidth)).tag=_,this._hitTester.add(u,s),p.push(l.convert(this._lowerYVals[V])),_=this._getDataPoint(this._xVals[V],this._lowerYVals[V],s,d,a,l),(u=new _CircleArea(new Point(c[V],p[V]),.5*i.strokeWidth)).tag=_,this._hitTester.add(u,s);this._hitTester.add(new _LinesArea(c,g),s),this._hitTester.add(new _LinesArea(c,p),s),i.drawLines(c,g,null,h,o),i.drawLines(c,p,null,h,o)}}}getCalculatedValues(t){t=asString(t,!1);var e=[],s=0;if(super._getLength()<=0)return e;switch(this._shouldCalculate()&&(this._init(),this._calculate()),t){case"upperEnvelope":for(;s<this._upperYVals.length;s++)e.push({x:this._xVals[s],y:this._upperYVals[s]});break;case"lowerEnvelope":for(;s<this._lowerYVals.length;s++)e.push({x:this._xVals[s],y:this._lowerYVals[s]})}return e}};export class CCI extends SingleOverlayIndicatorBase{constructor(t){super(),this._constant=.015,this.period=20,this.initialize(t)}get constant(){return this._constant}set constant(t){t!==this._constant&&(this._constant=asNumber(t,!1),this._clearValues(),this._invalidate())}_calculate(){var t=super._getLength();if(!(t<=0)){var e=super._getBindingValues(0),s=super._getBindingValues(1),i=super._getBindingValues(3),a=this._getXValues();this._yvals=_cci(e,s,i,this.period,this.constant),this._xvals=a?a.slice(this.period-1):_range(this.period-1,t-1)}}};export function _cci(t,e,s,i,a){asArray(t,!1),asArray(e,!1),asArray(s,!1),asInt(i,!1,!0),asNumber(a,!1,!0);var l,r,h,n=_minimum(t.length,e.length,s.length),o=[],_=[],u=[];for(assert(n>i&&i>1,"CCI period must be an integer less than the length of the data and greater than one."),r=0;r<n;r++)o.push(_average(t[r],e[r],s[r]));for(l=_sma(o,i),r=0;r<l.length;r++)h=o.slice(r,i+r).reduce((t,e)=>t+Math.abs(l[r]-e),0),_.push(h/i);for(o.splice(0,i-1),r=0;r<l.length;r++)u.push((o[r]-l[r])/(a*_[r]));return u};export class BollingerBands extends OverlayIndicatorBase{constructor(t){super(),this._period=20,this._multiplier=2,this.rendering.addHandler(this._rendering,this),this.initialize(t)}get period(){return this._period}set period(t){t!==this._period&&(this._period=asInt(t,!1,!0),this._clearValues(),this._invalidate())}get multiplier(){return this._multiplier}set multiplier(t){t!==this._multiplier&&(this._multiplier=asNumber(t,!1,!0),this._clearValues(),this._invalidate())}getDataRect(t,e){if(e)return e;if(super._getLength()<=0)return null;this._shouldCalculate()&&(this._init(),this._calculate());var s=this._upperYVals.concat(this._lowerYVals),i=_minimum(this._xVals),a=_maximum(this._xVals),l=_minimum(s),r=_maximum(s);return _DataInfo.isValid(i)&&_DataInfo.isValid(a)&&_DataInfo.isValid(l)&&_DataInfo.isValid(r)?new Rect(i,l,a-i,r-l):null}_clearValues(){super._clearValues(),this._upperYVals=null,this._middleYVals=null,this._lowerYVals=null,this._xVals=null}_shouldCalculate(){return!(this._upperYVals&&this._middleYVals&&this._lowerYVals&&this._xVals)}_init(){super._init(),this._upperYVals=[],this._middleYVals=[],this._lowerYVals=[],this._xVals=[]}_calculate(){var t=super._getLength();if(!(t<=0)){var e=super.getValues(0),s=this._getXValues(),i=_bollingerBands(e,this.period,this.multiplier);this._upperYVals=i.uppers,this._middleYVals=i.middles,this._lowerYVals=i.lowers,this._xVals=s?s.slice(this.period-1):_range(this.period-1,t-1)}}_rendering(t,e){if(e.cancel=!0,!(super._getLength()<=0)){this._shouldCalculate()&&(this._init(),this._calculate());var s=this.chart.series.indexOf(this),i=e.engine,a=this._getAxisX(),l=this._getAxisY(),r=_minimum(this._upperYVals.length,this._middleYVals.length,this._lowerYVals.length,this._xVals.length),h=_BasePlotter.cloneStyle(this.style,["fill"]),n=this._getSymbolStroke(s),o=this.chart._plotrectId;if(r&&!(r<=0)){i.stroke=n,i.strokeWidth=2;for(var _,u,d,c=[],g=[],p=[],m=[],V=this._getLength(),v=0;v<r;v++)d=V-r+v,c.push(a.convert(this._xVals[v])),g.push(l.convert(this._upperYVals[v])),_=this._getDataPoint(this._xVals[v],this._upperYVals[v],s,d,a,l),(u=new _CircleArea(new Point(c[v],g[v]),.5*i.strokeWidth)).tag=_,this._hitTester.add(u,s),p.push(l.convert(this._middleYVals[v])),_=this._getDataPoint(this._xVals[v],this._middleYVals[v],s,d,a,l),(u=new _CircleArea(new Point(c[v],p[v]),.5*i.strokeWidth)).tag=_,this._hitTester.add(u,s),m.push(l.convert(this._lowerYVals[v])),_=this._getDataPoint(this._xVals[v],this._lowerYVals[v],s,d,a,l),(u=new _CircleArea(new Point(c[v],m[v]),.5*i.strokeWidth)).tag=_,this._hitTester.add(u,s);this._hitTester.add(new _LinesArea(c,g),s),this._hitTester.add(new _LinesArea(c,p),s),this._hitTester.add(new _LinesArea(c,m),s),i.drawLines(c,g,null,h,o),i.drawLines(c,p,null,h,o),i.drawLines(c,m,null,h,o)}}}getCalculatedValues(t){t=asString(t,!1);var e=[],s=0;if(super._getLength()<=0)return e;switch(this._shouldCalculate()&&(this._init(),this._calculate()),t){case"upperBand":for(;s<this._upperYVals.length;s++)e.push({x:this._xVals[s],y:this._upperYVals[s]});break;case"middleBand":for(;s<this._middleYVals.length;s++)e.push({x:this._xVals[s],y:this._middleYVals[s]});break;case"lowerBand":for(;s<this._lowerYVals.length;s++)e.push({x:this._xVals[s],y:this._lowerYVals[s]})}return e}};export function _bollingerBands(t,e,s){asArray(t,!1),asInt(e,!1,!0),asNumber(s,!1,!0),assert(t.length>e&&e>1,"Bollinger Bands period must be an integer less than the length of the data and greater than one.");var i,a=_sma(t,e),l=[];for(i=e;i<=t.length;i++)l.push(_stdDeviation(t.slice(i-e,i)));var r=a,h=a.map((t,e)=>t+l[e]*s);return{lowers:a.map((t,e)=>t-l[e]*s),middles:r,uppers:h}};export class ATR extends SingleOverlayIndicatorBase{constructor(t){super(),this.period=14,this.initialize(t)}_calculate(){if(!(super._getLength()<=0)){var t=super._getBindingValues(0),e=super._getBindingValues(1),s=super._getBindingValues(3),i=this._getXValues();this._yvals=_avgTrueRng(t,e,s,this.period),this._xvals=i?i.slice(this.period-1):_range(this.period-1,t.length)}}};_registerModule("wijmo.chart.finance.analytics",selfModule);