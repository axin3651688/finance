/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{WjDirective,WjLink,MetaFactory,_registerNgModule,softRefGrid,softRefGridDetail,softRefInput}from"wijmo/wijmo.angular.base";import{Control,closest,CollectionViewGroup,isNullOrWhiteSpace,contains,getActiveElement,isArray,isString,hasClass,setCss,asNumber,isIE}from"wijmo/wijmo";import*as mNg from"angular";import*as wjcGrid from"wijmo/wijmo.grid";var wjNg=mNg;const wijmoGridName="wj.grid";export const ngModuleName="wj.grid";var wijmoGrid=_registerNgModule("wj.grid");softRefGrid()&&softRefGrid().FlexGrid&&(wijmoGrid.directive("wjFlexGrid",["$compile","$interpolate",function(e,t){return new WjFlexGrid(e,t)}]),wijmoGrid.directive("wjFlexGridColumn",["$compile",function(e){return new WjFlexGridColumn(e)}]),wijmoGrid.directive("wjFlexGridCellTemplate",[function(){return new WjFlexGridCellTemplate}]));export class WjFlexGrid extends WjDirective{constructor(e,t){super(),this._$compile=e,this._$interpolate=t;this.transclude=!0,this.template="<div ng-transclude />"}get _controlConstructor(){return wjcGrid.FlexGrid}_createLink(){return new WjFlexGridLink}_initProps(){var e=MetaFactory.findProp("childItemsPath",this._props);e.scopeBindingMode="@",e.customHandler=function(e,t,l,i,r){if(l&&(l=l.trim())&&"["===l[0]){var o=e.$parent.$eval(l);return t.childItemsPath=o,!0}return!1}}};class WjFlexGridLink extends WjLink{_initControl(){var e=super._initControl();return new DirectiveCellFactory(e,this),e}}var gridModule=wjcGrid&&wjcGrid.CellFactory;gridModule||(window.wijmo.grid={},window.wijmo.grid.CellFactory=function(){});class DirectiveCellFactory extends wjcGrid.CellFactory{constructor(e,t){if(super(),this._lastApplyTimeStamp=0,this._noApplyLag=!1,this._startingEditing=!1,this._cellStampCounter=0,this._composing=!1,this._grid=e,this._gridLink=t,this._rowHeightUpdates=new _RowHeightUpdateQueue(this),!DirectiveCellFactory._templateTypes)for(var l in DirectiveCellFactory._templateTypes=[],CellTemplateType)isNaN(l)&&DirectiveCellFactory._templateTypes.push(l);var i=this;this._baseCf=e.cellFactory,e.cellFactory=this,this._evtInput=document.createEvent("HTMLEvents"),this._evtInput.initEvent("input",!0,!1),this._evtChange=document.createEvent("HTMLEvents"),this._evtChange.initEvent("change",!0,!1),this._evtBlur=document.createEvent("HTMLEvents"),this._evtBlur.initEvent("blur",!1,!1),e.prepareCellForEdit.addHandler(function(e,t){i._noApplyLag=!0}),e.cellEditEnded.addHandler(function(t,l){(l.range.col<0||!e.columns[l.range.col][WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType.CellEdit)])&&(i._editChar=null),setTimeout(function(){i._noApplyLag=!1},300)}),e.beginningEdit.addHandler(function(e,t){!t.data||t.data instanceof KeyboardEvent&&!(t.data.charCode<=32)||(i._editChar=null),i._startingEditing=!0}),e.hostElement.addEventListener("keydown",function(e){i._startingEditing=!1},!0),e.hostElement.addEventListener("keypress",function(t){var l=t.charCode>32?String.fromCharCode(t.charCode):null;l&&closest(t.target,".wj-flexgrid")===e.hostElement&&(!e.activeEditor||i._startingEditing?i._editChar=l:i._editChar&&(i._editChar+=l))},!0),e.hostElement.addEventListener("compositionstart",function(e){i._composing=!0},!0),e.hostElement.addEventListener("compositionend",function(e){i._composing=!1},!0)}updateCell(e,t,l,i,r){this._cellStampCounter=(this._cellStampCounter+1)%1e7;let o=i[DirectiveCellFactory._cellStampProp]=this._cellStampCounter;i.style.overflow&&(i.style.overflow="");let n=t,a=l;r&&!r.isSingleCell&&(t=r.row,l=r.col);let s,c=this,p=e.grid,d=p.editRange,u=e.rows[t],m=u.dataItem,C=!1,h=!1,_=!1,T=!1;switch(e.cellType){case wjcGrid.CellType.Cell:if(d&&d.row===t&&d.col===l)s=CellTemplateType.CellEdit,h=_=!0;else if(u instanceof wjcGrid.GroupRow){var v=!((T=m instanceof CollectionViewGroup)||u.hasChildren);l==e.columns.firstVisibleIndex?s=v?CellTemplateType.Cell:CellTemplateType.GroupHeader:(s=v?CellTemplateType.Cell:CellTemplateType.Group,h=!0)}else softRefGridDetail()&&softRefGridDetail().DetailRow&&u instanceof softRefGridDetail().DetailRow||(s=CellTemplateType.Cell);break;case wjcGrid.CellType.ColumnHeader:s=CellTemplateType.ColumnHeader;break;case wjcGrid.CellType.RowHeader:s=p.collectionView&&p.collectionView.currentEditItem===m?CellTemplateType.RowHeaderEdit:CellTemplateType.RowHeader,C=!0;break;case wjcGrid.CellType.TopLeft:s=CellTemplateType.TopLeft,C=!0;break;case wjcGrid.CellType.ColumnFooter:s=CellTemplateType.ColumnFooter,h=!0;break;case wjcGrid.CellType.BottomLeft:s=CellTemplateType.BottomLeft,C=!0}var f=!1;if(null!=s){var g=T&&s==CellTemplateType.GroupHeader?p.getColumn(m.groupDescription.propertyName):l>=0&&l<e.columns.length?e.columns[l]:null;if(g){var w=WjFlexGridCellTemplate._getTemplContextProp(s),y=(C?p:g)[w];if(y||(s===CellTemplateType.RowHeaderEdit?(s=CellTemplateType.RowHeader,w=WjFlexGridCellTemplate._getTemplContextProp(s),y=p[w]):s!==CellTemplateType.Group&&s!==CellTemplateType.GroupHeader||T||(s=CellTemplateType.Cell,w=WjFlexGridCellTemplate._getTemplContextProp(s),y=g[w])),y){var j,E=c._getCellTemplate(y.cellTemplate),G=y.cellStyle,F=y.cellClass,x=!isNullOrWhiteSpace(E),L=!isNullOrWhiteSpace(G),S=!isNullOrWhiteSpace(F);if(h&&(j=e.getCellData(t,l,!1)),x){var W=i.getAttribute(wjcGrid.FlexGrid._WJS_MEASURE),H=W&&"true"===W.toLowerCase();f=!0,_&&this._baseCf.updateCell(e,n,a,i,r,!0);var $=i[w]||{},D=$.column!==g||!$.cellScope||!$.cellScope.$root,R=_&&this._composing&&p.imeEnabled,k=$.cellScope;D&&(this._doDisposeCell(i),$.cellScope=k=y.templLink.scope.$parent.$new(),$.column=g,i[w]=$);var I=k.$row!==u||k.$col!==g||k.$item!==m||k.$value!==j;I&&c._initCellScope(k,u,g,m,j);var A=y.cellLink;A||(A=y.cellLink=this._gridLink.directive._$compile('<div style="display:none"'+(L?' ng-style="'+G+'"':"")+(S?' ng-class="'+F+'"':"")+">"+E+"</div>"));var P=$.clonedElement;if(D){var N=k.$watch(function(t){if(P&&(N(),P[0].style.display="",e.cellType===wjcGrid.CellType.ColumnHeader||e.cellType===wjcGrid.CellType.TopLeft)){var l=P[0].style,i=l.outlineColor,r=l.outlineWidth;l.outlineColor="white",l.outlineWidth="0px",setTimeout(function(){l.outlineColor=i,l.outlineWidth=r},0)}});$.clonedElement=P=A(k,function(e,t){})}H&&(P[0].style.display="");var b=!1;if(_){var M=i.firstElementChild;M&&(R||i.focus(),M.style.display="none")}else(b=1==i.childNodes.length)||(i.textContent="");b?P[0]!==i.firstChild&&i.replaceChild(P[0],i.firstChild):i.appendChild(P[0]),y.cellOverflow&&(i.style.overflow=y.cellOverflow);if(this._closingApplyTimeOut&&clearTimeout(this._closingApplyTimeOut),c._rowHeightUpdates.add({panel:e,cell:i,rng:r,cellStamp:o,templateContext:y}),H||d||this._noApplyLag||I&&Date.now()-this._lastApplyTimeStamp>40?(clearTimeout(this._closingApplyTimeOut),k.$root&&!k.$root.$$phase&&k.$apply(),d||H||c._rowHeightUpdates.execute(),this._lastApplyTimeStamp=Date.now()):(clearTimeout(this._closingApplyTimeOut),this._closingApplyTimeOut=setTimeout(function(){clearTimeout(this._closingApplyTimeOut),k.$root&&!k.$root.$$phase&&k.$apply(),c._rowHeightUpdates.execute()},10)),R?_&&setTimeout(()=>{R?this._initImeEditInput($,y):this._initEditInput($,y,null)},0):setTimeout(function(){if(c._updateRowHeight(e,i,r,o,y)){if(_){c._rowHeightUpdates.clear();let e=c._isFullEdit();return p.refresh(),void p.startEditing(e)}}else _&&c._initEditInput($,y,null)},0),_){c._cellEditorScope=k;var O=function(r,o){if(p.cellEditEnding.removeHandler(O),!o.stayInEditMode){var n=getActiveElement();n&&n.dispatchEvent(c._evtBlur),contains(i,getActiveElement())&&i.focus()}o.cancel||o.stayInEditMode||(o.cancel=!0,e.grid.setCellData(t,l,k.$value));var a=i.querySelectorAll(".wj-dropdown");[].forEach.call(a,function(e){var t=Control.getControl(e);t&&softRefInput()&&t instanceof softRefInput().DropDown&&(t.isDroppedDown=!1)})};p.cellEditEnding.addHandler(O),p.cellEditEnded.addHandler(()=>{c._cellEditorScope=null})}else this._baseCf.updateCell(e,n,a,i,r,!1)}}}}if(f||(this._doDisposeCell(i),this._baseCf.updateCell(e,n,a,i,r)),!x&&(L||S)){var U=c._initCellScope({},u,g,m,j),q=L?this._gridLink.scope.$parent.$eval(G,U):null,B=S?this._gridLink.scope.$parent.$eval(F,U):null;if(q||B){for(var V=document.createElement("div");i.firstChild;)V.appendChild(i.firstChild);if(i.appendChild(V),q)for(var z in q)V.style[z]=q[z];if(B){for(var Q=isArray(B)?B:[B],J="",K=0;K<Q.length;K++){var X=Q[K];if(X)if(isString(X))J+=" "+X;else for(var Y in X)X[Y]&&(J+=" "+Y)}V.className=J}}}}getEditorValue(e){return this._cellEditorScope?this._cellEditorScope.$value:super.getEditorValue(e)}disposeCell(e){this._doDisposeCell(e)}_doDisposeCell(e){for(var t=DirectiveCellFactory._templateTypes,l=0;l<t.length;l++){var i=WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType[t[l]]),r=e[i];r&&r.cellScope&&r.cellScope.$root&&(r.cellScope.$destroy(),r.clonedElement&&(r.clonedElement.remove(),r.clonedElement=null),e[i]=null)}}_updateRowHeight(e,t,l,i,r){if(r.autoSizeRows){var o=t.scrollHeight,n=e.rows,a=l&&l.rowSpan||1;if(i===t[DirectiveCellFactory._cellStampProp]&&n.defaultSize*a<o)return n.defaultSize=o/a,!0}return!1}_initCellScope(e,t,l,i,r){return e.$row=t,e.$col=l,e.$item=i,e.$value=r,e}_getCellTemplate(e){return e&&(e=(e=(e=e.replace(/ class\=\"ng\-scope\"( \"ng\-binding\")?/g,"")).replace(/<span>\s*<\/span>/g,"")).trim()),e}_isFullEdit(){let e=this._grid;return!e.activeEditor||e._edtHdl._fullEdit}_setFullEdit(e){let t=this._grid;e.forceFullEdit&&t.activeEditor&&(t._edtHdl._fullEdit=!0)}_initEditInput(e,t,l){this._setFullEdit(t);var i=this._findInitialInput(e);if(i){let e=()=>{i.removeEventListener("focus",e),setTimeout(()=>{let e=null!=l?l:this._editChar;e&&(i.value=e,this._editChar=null,DirectiveCellFactory._setSelectionRange(i,e.length,e.length),!DirectiveCellFactory.isNgIE||hasClass(i,"wj-form-control")||i.getAttribute("wj-part")?i.dispatchEvent(this._evtInput):i.dispatchEvent(this._evtChange))},DirectiveCellFactory._FOCUS_INTERVAL)};i.addEventListener("focus",e),i.focus()}}_initImeEditInput(e,t){let l=getActiveElement();if(l&&l instanceof HTMLInputElement&&hasClass(l,"wj-grid-ime")){let i=r=>{l.removeEventListener("compositionend",i),setCss(l,wjcGrid._ImeHandler._cssHidden),this._initEditInput(e,t,l.value)};l.addEventListener("compositionend",i);let r=this._findInitialInput(e);if(r){let e=r.getBoundingClientRect(),t=l.getBoundingClientRect(),i=window.getComputedStyle(l),o=parseFloat(i.left),n=parseFloat(i.top);setCss(l,{left:o+e.left-t.left+"px",top:n+e.top-t.top+"px",width:e.width+"px",height:e.height+"px"})}}}_findInitialInput(e){let t=e.clonedElement[0].querySelectorAll("input,textarea");if(t)for(var l=0;l<t.length;l++){var i=t[l],r=window.getComputedStyle(i);if("none"!==r.display&&"visible"===r.visibility)return i}return null}static _setSelectionRange(e,t,l=t){if(contains(document.body,e)&&!e.disabled&&"none"!=e.style.display)try{e.setSelectionRange(asNumber(t),asNumber(l),isIE()?null:"backward"),e.focus()}catch(e){}}}DirectiveCellFactory._cellStampProp="__wjCellStamp",DirectiveCellFactory._FOCUS_INTERVAL=Control._FOCUS_INTERVAL+20,DirectiveCellFactory.isNgIE=!!document.documentMode;class _RowHeightUpdateQueue{constructor(e){this._requests=[],this._timeOuts=[],this._cellFactory=e}add(e){this._requests.push(e)}execute(){for(var e=this._requests;e.length>0;){var t=this,l=function(e){return setTimeout(function(){if(t._cellFactory._updateRowHeight(e.panel,e.cell,e.rng,e.cellStamp,e.templateContext))t.clear();else{var i=t._timeOuts.indexOf(l);i>-1&&t._timeOuts.splice(i,1)}},0)}(this._requests.shift());this._timeOuts.push(l)}}clear(){this._requests.splice(0,this._requests.length),this._clearTimeouts()}_clearTimeouts(){for(var e=this._timeOuts,t=0;t<e.length;t++)clearTimeout(e[t]);e.splice(0,e.length)}}gridModule||(window.wijmo.grid=null);export class WjFlexGridColumn extends WjDirective{constructor(e){super(),this._$compile=e,this.scope.dataMap+="map",this.scope.dataType+="type",this.require="^wjFlexGrid",this.terminal=!0,WjDirective._dynaTemplates?(this.transclude=!1,this.priority=100,this.template=function(e,t){return t[WjFlexGridColumn._colTemplateProp]=e[0].innerHTML,'<div class="wjGridColumn"/>'}):(this.transclude=!0,this.template='<div class="wjGridColumn" ng-transclude/>')}get _controlConstructor(){return wjcGrid.Column}_initControl(e){return new wjcGrid.Column}_createLink(){return new WjFlexGridColumnLink}};WjFlexGridColumn._colTemplateProp="$__wjColTemplate",WjFlexGridColumn._colWjLinkProp="$__wjLink",WjFlexGridColumn._cellCtxProp="$_cellCtxProp";class WjFlexGridColumnLink extends WjLink{_initParent(){var e=this.parent.control;e.autoGenerateColumns&&(e.autoGenerateColumns=!1,this._safeApply(this.scope,"autoGenerateColumns",!1),e.columns.clear()),super._initParent();var t=WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType.Cell),l=this.control[t],i=this[WjFlexGridColumn._cellCtxProp];!l&&i&&(this.control[t]=i),this.control[WjFlexGridColumn._colWjLinkProp]=this}_link(){var e=this.tElement[0],t=this.tAttrs[WjFlexGridColumn._colTemplateProp],l=null!=t?t:WjDirective._removeTransclude(e.innerHTML),i={};if(!isNullOrWhiteSpace(l)){var r=document.createElement("div");r.innerHTML=l;var o,n=[];[].forEach.call(r.children,function(e){n.push(e)});for(var a=0;a<n.length;a++){var s=n[a];s.tagName.toLocaleLowerCase()===WjFlexGridCellTemplate._tagName&&(o||(o=this.scope.$parent.$new()),r.removeChild(s),e.appendChild(s),this.directive._$compile(s)(o))}var c=r.innerHTML;isNullOrWhiteSpace(c)||(i.cellTemplate=c)}var p=this.tAttrs.ngStyle,d=this.tAttrs.ngClass;p&&(i.cellStyle=p),d&&(i.cellClass=d),(i.cellTemplate||i.cellStyle||i.cellClass)&&(i.templLink=this,this[WjFlexGridColumn._cellCtxProp]=i),super._link()}}export var CellTemplateType;!function(e){e[e.Cell=0]="Cell",e[e.CellEdit=1]="CellEdit",e[e.ColumnHeader=2]="ColumnHeader",e[e.RowHeader=3]="RowHeader",e[e.RowHeaderEdit=4]="RowHeaderEdit",e[e.TopLeft=5]="TopLeft",e[e.GroupHeader=6]="GroupHeader",e[e.Group=7]="Group",e[e.ColumnFooter=8]="ColumnFooter",e[e.BottomLeft=9]="BottomLeft"}(CellTemplateType||(CellTemplateType={}));export class WjFlexGridCellTemplate extends WjDirective{constructor(){super(),this.require=["?^wjFlexGridColumn","?^wjFlexGrid"],this.terminal=!0,WjDirective._dynaTemplates?(this.transclude=!1,this.priority=100,this.template=function(e,t){return t[WjFlexGridColumn._colTemplateProp]=e[0].innerHTML,"<div />"}):(this.transclude=!0,this.template="<div ng-transclude/>")}static _getTemplContextProp(e){return"$__cellTempl"+CellTemplateType[e]}_initControl(e){return{}}_createLink(){return new WjFlexGridCellTemplateLink}_getMetaDataId(){return"FlexGridCellTemplate"}};WjFlexGridCellTemplate._tagName="wj-flex-grid-cell-template";class WjFlexGridCellTemplateLink extends WjLink{_initParent(){super._initParent();var e,t=this.scope.cellType;if(!t)return;e=CellTemplateType[t];var l=this.tAttrs[WjFlexGridColumn._colTemplateProp],i=null!=l?l:WjDirective._removeTransclude(this.tElement[0].innerHTML),r=this.control;isNullOrWhiteSpace(i)||(r.cellTemplate=i);var o=this.tAttrs.ngStyle,n=this.tAttrs.ngClass;o&&(r.cellStyle=o),n&&(r.cellClass=n),this.tAttrs.forceFullEdit||(r.forceFullEdit=!0);let a=this.tAttrs.autoSizeRows;if(r.autoSizeRows=null==a||"true"===a,r.cellTemplate||r.cellStyle||r.cellClass){r.templLink=this;let t=this.parent.control;t[WjFlexGridCellTemplate._getTemplContextProp(e)]=r,t instanceof wjcGrid.Column&&t._setFlag(wjcGrid.RowColFlags.HasTemplate,!0)}WjFlexGridCellTemplateLink._invalidateGrid(this.parent.control)}_destroy(){var e=this.parent&&this.parent.control,t=this.scope.cellType;super._destroy(),t&&(e[WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType[t])]=void 0,WjFlexGridCellTemplateLink._invalidateGrid(e))}static _invalidateGrid(e){var t=e;t&&(t instanceof wjcGrid.Column&&(t=t.grid),t&&t.invalidate())}}