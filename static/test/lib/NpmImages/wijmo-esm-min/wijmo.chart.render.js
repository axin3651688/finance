/*!
    *
    * Wijmo Library 5.20191.603
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{Event,Color,isString,Size,Point,_registerModule}from"wijmo/wijmo";import{_SvgRenderEngine,_Spline,FlexChartBase}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.render";var _CanvasRenderEngine=function(){function t(t,e){void 0===e&&(e=!1),this._strokeWidth=1,this._fontSize=null,this._fontFamily=null,this._applyCanvasClip=function(t,e){var n=this._canvasRect[e];n&&(t.beginPath(),t.rect(n.left,n.top,n.width,n.height),t.clip(),t.closePath())},this._applyCanvasStyles=function(t,e,n,i,s){var o,r,a,l=this._canvas.getContext("2d"),h=this.stroke,p=this.fill,f=this.strokeWidth;e&&void 0!==e.stroke&&(h=e.stroke),e&&void 0!==e.fill&&(p=this._getOpacityColor(e.fill,e["fill-opacity"])),t&&(r=window.getComputedStyle(t),a=t.getBBox()),s?r?(l.fillStyle=r.fill,o=r.fontStyle+" "+r.fontSize+" "+r.fontFamily,l.font=o,l.font.replace(/\"/g,"'")!==o.replace(/\"/g,"'")&&(o=r.fontStyle+" "+r.fontSize+" "+(l.font.split(" ")[1]||"sans-serif"),l.font=o)):this.fontSize?(l.fillStyle=this.textFill,l.font=this.fontSize+" "+(this.fontFamily||"sans-serif")):this._canvasDefaultFont&&(l.fillStyle=this._canvasDefaultFont.textFill,o=this._canvasDefaultFont.fontSize+" "+this._canvasDefaultFont.fontFamily,l.font=o,l.font.replace(/\"/g,"'")!==o.replace(/\"/g,"'")&&(o=this._canvasDefaultFont.fontSize+" "+(l.font.split(" ")[1]||"sans-serif"),l.font=o)):(r&&(h=r.stroke&&"none"!==r.stroke?r.stroke:h,p=r.fill&&"none"!==r.fill?this._getOpacityColor(r.fill,r["fill-opacity"]):p,f=r.strokeWidth?r.strokeWidth:f),"none"!==h&&null!=h&&(this._applyColor("strokeStyle",h,a),l.lineWidth=+f.replace(/px/g,""),l.stroke()),i&&null!=p&&"transparent"!==p&&"none"!==p&&(this._applyColor("fillStyle",p,a),l.fill()))};this._element=t,this._canvas=document.createElement("canvas"),this._svgEngine=new _SvgRenderEngine(t),this._element.appendChild(this._canvas),this._applyCSSStyles=e}return t.prototype.beginRender=function(){var t,e=this._svgEngine.element,n=this._element;this._applyCSSStyles&&(this._svgEngine.beginRender(),n=e),this._element.appendChild(e),this._canvasRect={},t=window.getComputedStyle(n),this._canvasDefaultFont={fontSize:t.fontSize,fontFamily:t.fontFamily,textFill:t.color}},t.prototype.endRender=function(){this._applyCSSStyles&&this._svgEngine.endRender(),this._svgEngine.element.parentNode.removeChild(this._svgEngine.element)},t.prototype.setViewportSize=function(t,e){var n,i,s=this._canvas,o=(s.getContext("2d"),this.fill);this._applyCSSStyles&&this._svgEngine.setViewportSize(t,e),s.width=t,s.height=e,n=window.getComputedStyle(this._element).backgroundColor,i=this.stroke,n&&(this.stroke=null,this.fill=n,this.drawRect(0,0,t,e),this.fill=o,this.stroke=i)},Object.defineProperty(t.prototype,"element",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fill",{get:function(){return this._fill},set:function(t){this._svgEngine.fill=t,this._fill=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._svgEngine.fontSize=t;var e=null==t||isNaN(t)?t:t+"px";this._fontSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){this._svgEngine.fontFamily=t,this._fontFamily=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stroke",{get:function(){return this._stroke},set:function(t){this._svgEngine.stroke=t,this._stroke=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"strokeWidth",{get:function(){return this._strokeWidth},set:function(t){this._svgEngine.strokeWidth=t,this._strokeWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textFill",{get:function(){return this._textFill},set:function(t){this._svgEngine.textFill=t,this._textFill=t},enumerable:!0,configurable:!0}),t.prototype.addClipRect=function(t,e){t&&e&&(this._applyCSSStyles&&this._svgEngine.addClipRect(t,e),this._canvasRect[e]=t.clone())},t.prototype.drawEllipse=function(t,e,n,i,s,o){var r,a=this._canvas.getContext("2d");return this._applyCSSStyles&&(r=this._svgEngine.drawEllipse(t,e,n,i,s,o)),a.save(),a.beginPath(),a.ellipse?a.ellipse(t,e,n,i,0,0,2*Math.PI):(a.translate(t,e),a.scale(1,i/n),a.translate(-t,-e),a.arc(t,e,n,0,2*Math.PI),a.scale(1,1)),this._applyCanvasStyles(r,o,s,!0),a.restore(),r},t.prototype.drawRect=function(t,e,n,i,s,o,r){var a,l=this._canvas.getContext("2d");return this._applyCSSStyles&&(a=this._svgEngine.drawRect(t,e,n,i,s,o,r)),l.save(),this._applyCanvasClip(l,r),l.beginPath(),l.rect(t,e,n,i),this._applyCanvasStyles(a,o,s,!0),l.restore(),a},t.prototype.drawLine=function(t,e,n,i,s,o){var r,a=this._canvas.getContext("2d");return this._applyCSSStyles&&(r=this._svgEngine.drawLine(t,e,n,i,s,o)),a.save(),a.beginPath(),a.moveTo(t,e),a.lineTo(n,i),this._applyCanvasStyles(r,o,s),a.restore(),r},t.prototype.drawLines=function(t,e,n,i,s){if(t&&e&&0!==t.length&&0!==e.length){var o,r,a=this._canvas.getContext("2d"),l=Math.min(t.length,e.length);for(this._applyCSSStyles&&(o=this._svgEngine.drawLines([0,1],[1,0],n,i,s)),a.save(),this._applyCanvasClip(a,s),a.beginPath(),a.moveTo(t[0],e[0]),r=1;r<l;r++)a.lineTo(t[r],e[r]);return this._applyCanvasStyles(o,i,n),a.restore(),o}},t.prototype.drawSplines=function(t,e,n,i,s){if(t&&e&&0!==t.length&&0!==e.length){var o,r,a=this._canvas.getContext("2d"),l=new _Spline(t,e).calculate(),h=l.xs,p=l.ys,f=Math.min(h.length,p.length);for(this._applyCSSStyles&&(o=this._svgEngine.drawSplines([0,1],[1,0],n,i,s)),a.save(),this._applyCanvasClip(a,s),a.beginPath(),a.moveTo(h[0],p[0]),r=1;r<f;r++)a.lineTo(h[r],p[r]);return this._applyCanvasStyles(o,i,n),a.restore(),o}},t.prototype.drawPolygon=function(t,e,n,i,s){if(t&&e&&0!==t.length&&0!==e.length){var o,r,a=this._canvas.getContext("2d"),l=Math.min(t.length,e.length);for(this._applyCSSStyles&&(o=this._svgEngine.drawPolygon(t,e,n,i,s)),a.save(),this._applyCanvasClip(a,s),a.beginPath(),a.moveTo(t[0],e[0]),r=1;r<l;r++)a.lineTo(t[r],e[r]);return a.closePath(),this._applyCanvasStyles(o,i,n,!0),a.restore(),o}},t.prototype.drawPieSegment=function(t,e,n,i,s,o,r,a){var l,h=this._canvas.getContext("2d"),p=i,f=i+s;return this._applyCSSStyles&&(l=this._svgEngine.drawPieSegment(t,e,n,i,s,o,r,a)),h.save(),this._applyCanvasClip(h,a),h.beginPath(),h.moveTo(t,e),h.arc(t,e,n,p,f,!1),h.lineTo(t,e),this._applyCanvasStyles(l,r,o,!0),h.restore(),l},t.prototype.drawDonutSegment=function(t,e,n,i,s,o,r,a,l){var h,p,f,y=this._canvas.getContext("2d"),c=s,g=s+o;return this._applyCSSStyles&&(h=this._svgEngine.drawDonutSegment(t,e,n,i,s,o,r,a,l)),(p=new Point(t,e)).x+=i*Math.cos(c),p.y+=i*Math.sin(c),(f=new Point(t,e)).x+=i*Math.cos(g),f.y+=i*Math.sin(g),y.save(),this._applyCanvasClip(y,l),y.beginPath(),y.moveTo(p.x,p.y),y.arc(t,e,n,c,g,!1),y.lineTo(f.x,f.y),y.arc(t,e,i,g,c,!0),this._applyCanvasStyles(h,a,r,!0),y.restore(),h},t.prototype.drawString=function(t,e,n,i){var s,o=this._canvas.getContext("2d");return this._applyCSSStyles&&(s=this._svgEngine.drawString(t,e,n,i)),o.save(),o.textBaseline="bottom",this._applyCanvasStyles(s,i,n,!0,!0),o.fillText(t,e.x,e.y),o.restore(),s},t.prototype.drawStringRotated=function(t,e,n,i,s,o){var r,a=this._canvas.getContext("2d");a.measureText(t);return this._applyCSSStyles&&(r=this._svgEngine.drawStringRotated(t,e,n,i,s,o)),a.save(),a.textBaseline="bottom",a.translate(n.x,n.y),a.rotate(Math.PI/180*i),a.translate(-n.x,-n.y),this._applyCanvasStyles(r,o,s,!0,!0),a.fillText(t,e.x,e.y),a.restore(),r},t.prototype.measureString=function(t,e,n,i){var s,o=o=this._canvas.getContext("2d");return this._applyCSSStyles?this._svgEngine.measureString(t,e,n,i):(this._applyCanvasStyles(null,null,e,!0,!0),s=o.measureText(t).width,new Size(s,1.5*parseInt(o.font)))},t.prototype.startGroup=function(t,e,n){void 0===n&&(n=!1);var i,s=this._canvas.getContext("2d");return this._applyCSSStyles&&(i=this._svgEngine.startGroup(t,e,n)),s.save(),this._applyCanvasClip(s,e),i},t.prototype.endGroup=function(){this._applyCSSStyles&&this._svgEngine.endGroup(),this._canvas.getContext("2d").restore()},t.prototype.drawImage=function(t,e,n,i,s){var o,r=this._canvas.getContext("2d"),a=new Image;return this._applyCSSStyles&&(o=this._svgEngine.drawImage(t,e,n,i,s)),a.onload=function(){r.drawImage(a,e,n,i,s)},a.src=t,o},t.prototype._getOpacityColor=function(t,e){var n=new Color(t);return t.indexOf("url")>-1?this.fill:t.indexOf("-")>-1?(this.fill=t,t):(null!=e&&1===n.a&&(n.a=isNaN(e)?1:Number(e)),n.toString())},t.prototype._applyColor=function(t,e,n){var i=_GradientColorUtil.tryParse(e),s=this._canvas.getContext("2d");if(null!=i)if(isString(i)||null==n)s[t]=i;else{var o;if(null!=i.x1)o=i.relative?s.createLinearGradient(n.x+i.x1*n.width,n.y+i.y1*n.height,n.x+i.x2*n.width,n.y+i.y2*n.height):s.createLinearGradient(i.x1,i.y1,i.x2,i.y2);else if(null!=i.r)if(i.relative){var r=n.x+i.cx*n.width,a=n.y+i.cy*n.height,l=i.r*n.width,h=i.r*n.height/l,p=n.x+(null==i.fx?i.cx:i.fx)*n.width,f=n.y+(null==i.fy?i.cy:i.fy)*n.height,y=(null==i.fr?0:i.fr)*n.width,c=(null==i.fr?0:i.fr)*n.height,g=Math.min(y,c);o=s.createRadialGradient(p,f/h,g,r,a/h,l),s.setTransform(1,0,0,h,0,0)}else o=s.createRadialGradient(null==i.fx?i.cx:i.fx,null==i.fy?i.cy:i.fy,i.fr||0,i.cx,i.cy,i.r);i.colors&&i.colors.length>0&&null!=o&&i.colors.forEach(function(t){var e=new Color("#000000");null!=t.color&&(e=t.color),null!=t.opacity&&(e.a=t.opacity),o.addColorStop(t.offset,e.toString())}),s[t]=o}},t}();export{_CanvasRenderEngine};var _GradientColorUtil=function(){function t(){}return t.tryParse=function(e){if(t.parsedColor[e])return t.parsedColor[e];if(null==e||-1===e.indexOf("-"))return e;var n,i=e.replace(/\s+/g,"").split(/\-/g),s=i[0][0],o=!1,r=i[0].match(/\(\S+\)/)[0].replace(/[\(\\)]/g,"").split(/\,/g);"l"===s||"L"===s?(n={x1:"0",y1:"0",x2:"0",y2:"0",colors:[]},"l"===s&&(o=!0),["x1","y1","x2","y2"].forEach(function(t,e){null!=r[e]&&(n[t]=+r[e])})):"r"!==s&&"R"!==s||(n={cx:"0",cy:"0",r:"0",colors:[]},"r"===s&&(o=!0),["cx","cy","r","fx","fy","fr"].forEach(function(t,e){null!=r[e]&&""!==r[e]&&(n[t]=+r[e])})),n.relative=o,t.parsedColor[e]=n;var a=i.length-1;return i.forEach(function(t,e){t.indexOf(")")>-1&&(t=t.match(/\)\S+/)[0].replace(")",""));var i=t.split(":"),s={color:new Color("#000000")};null!=i[0]&&(s.color=Color.fromString(i[0])),null!=i[1]?s.offset=+i[1]:s.offset=e/a,null!=i[2]&&(s.opacity=+i[2]),n.colors.push(s)}),n},t.parsedColor={},t}();if(FlexChartBase&&FlexChartBase.prototype&&FlexChartBase.prototype._exportToImage){var _exportFn=FlexChartBase.prototype._exportToImage;FlexChartBase.prototype._exportToImage=function(t,e){if("svg"!==t){var n,i,s=new _CanvasRenderEngine(this.hostElement,!0),o=this.rendered;this.rendered=new Event,this._render(s,!1),(i=s.element).parentNode.removeChild(i),n=i.toDataURL("image/"+t),e.call(null,n),i=null,s=null,this.rendered=o}else _exportFn.call(this,t,e)}}_registerModule("wijmo.chart.render",selfModule);