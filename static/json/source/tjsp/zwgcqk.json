
{
    "id":"0039",
    "text":"债务构成情况分析表",
    "showDims":["year","month","company","conversion"],
    "changeYearBefore": function (newyear, option) {
        option.closeTabTaget(newyear, option);
    }, //切换年的回调
    "changeMonthBefore": function (newmonth, option) {
        option.closeTabTaget(newmonth, option);
    }, //切换月份的回调
    "changeCompanyBefore": function (newcompany, option) {
        option.closeTabTaget(newcompany, option);
    }, //切换公司之前的回调
    "changeConversionBefore":function(newconversion, option){
        option.closeTabTaget(newconversion,option);
    },
    "__queryDataAfter":function(data,$vue){//数据的后置处理
        // debugger
        let bue = data.some(res => {
            return (res.scode=="2001" || res.scode=="2002" || res.scode=="2003") && res.bz && res.bz!=0 ;
        })
        if(bue){
            data.forEach(res => { if(res.scode=="20")res.bz=100.00; })
        }
        let me = this;
        me.items[0].updateView = $vue.updateView;
        me.items[0].$vue = $vue;
        return data;
    },
    "config":{
        //"sql": "WITH TMP AS( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, SUM(NVL(FACT_A,0)) AS FACT_A FROM DW_DIMFINANCE A LEFT JOIN ( SELECT :company AS DIM_COMPANY, DIM_FINANCE, SUM(NVL(FACT_A,0)) AS FACT_A FROM DW_FACTFINANCEDETAIL WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND :period BETWEEN SSTARTDATE AND SENDDATE GROUP BY DIM_FINANCE) B ON B.DIM_FINANCE LIKE A.SCODE||'%' WHERE ( SPCODE LIKE '10%' OR SCODE='10') GROUP BY SCODE, SPCODE, SNAME, NLEVEL, CISLEAF) , TMP1 AS ( SELECT scode, spcode, sname, nlevel, cisleaf, fact_a FROM TMP WHERE NLEVEL=1 ) , TMP2 AS ( SELECT scode, spcode, sname, nlevel, cisleaf, fact_a FROM TMP WHERE NLEVEL=2 ) , TMP3 AS ( SELECT scode, spcode, sname, nlevel, cisleaf, fact_a FROM TMP WHERE NLEVEL=3 ) , TMP4 AS ( SELECT scode, spcode, sname, nlevel, cisleaf, fact_a FROM TMP WHERE NLEVEL=4 ) , TMP0 AS ( SELECT SCODE, SNAME, NLEVEL, CISLEAF, NVL(ZHCB,0) AS ZHCB FROM TMP A LEFT JOIN ( SELECT DIM_FINANCE, ( CASE WHEN SUM(NVL(FACT_A,0))=0 THEN 0 ELSE ROUND((SUM(NVL(FACT_A,0)*NVL(FACT_C,0))/SUM(NVL(FACT_A,0))),4) END) AS ZHCB FROM DW_FACTFINANCEDETAIL A WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND :period BETWEEN SSTARTDATE AND SENDDATE GROUP BY DIM_FINANCE ) B ON A.SCODE=B.DIM_FINANCE ) , TMP5 AS ( SELECT '0' AS FLAG, A.SCODE, SNAME, NLEVEL, CISLEAF, JE, BZ*100 AS bz, NVL(ZHCB,0) AS ZHCB FROM ( SELECT SCODE, SNAME, NLEVEL, CISLEAF, ZHCB FROM TMP0) A INNER JOIN ( SELECT SCODE, FACT_A AS JE, 0 AS BZ FROM TMP1 UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP1 A INNER JOIN TMP2 B ON A.SCODE=B.SPCODE UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP2 A INNER JOIN TMP3 B ON A.SCODE=B.SPCODE UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP3 A INNER JOIN TMP4 B ON A.SCODE=B.SPCODE) B ON A.SCODE=B.SCODE ORDER BY A.SCODE ) , TMP6 AS ( SELECT :company AS DIM_COMPANY, DIM_FINANCE, SENDDATE,SSTARTDATE, (case when SENDDATE-SSTARTDATE<10000 then (nvl(FACT_A,0)) else 0 end) AS FACT_A1, (case when SENDDATE-SSTARTDATE>10000 and SENDDATE-SSTARTDATE<50000 then (nvl(FACT_A,0)) else 0 end) AS FACT_A15, (case when SENDDATE-SSTARTDATE>50000 then (nvl(FACT_A,0)) else 0 end) as fact_A16, (case when SENDDATE-SSTARTDATE<10000 then (nvl(FACT_c,0)) else 0 end) AS FACT_c1, (case when SENDDATE-SSTARTDATE>10000 and SENDDATE-SSTARTDATE<50000 then (nvl(FACT_c,0)) else 0 end) AS FACT_c15, (case when SENDDATE-SSTARTDATE>50000 then (nvl(FACT_c,0)) else 0 end) as fact_c16 FROM DW_FACTFINANCEDETAIL WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND :period BETWEEN SSTARTDATE AND SENDDATE ), tmp7 as ( select DIM_COMPANY, sum(FACT_A1) FACT_A1,sum(FACT_A15) FACT_A15, sum(FACT_A16) FACT_A16, sum(FACT_c1) FACT_c1,sum(FACT_c15) FACT_c15, sum(FACT_c16) FACT_c16 from tmp6 group by DIM_COMPANY ), tmp8 as ( select '2001' as scode,FACT_A1 as FACT_A, FACT_c1 FACT_c from tmp7 union all select '2002', FACT_A15 , FACT_c15 from tmp7 union all select '2003', FACT_A16, FACT_c16 from tmp7 ) , TMP9 AS ( SELECT '0' AS FLAG,C.SCODE,D.SNAME||'('||RZCBL*100||'%)' SNAME, NLEVEL,CISLEAF, JE, BZ, 0 AS ZHCB FROM( SELECT B.SCODE, ROUND(SUM((B.FACT_A*FACT_C)/FACT_ASUM),4) RZCBL, SUM(A.FACT_A) JE, ROUND(SUM(B.FACT_A/FACT_ASUM),4) BZ FROM TMP8 B LEFT JOIN (SELECT SUM(FACT_A) FACT_ASUM FROM TMP8) ON 1=1 LEFT JOIN (SELECT SCODE, FACT_A FROM TMP8) A ON A.SCODE=B.SCODE GROUP BY B.SCODE ) C LEFT JOIN DW_DIMFINANCE D ON C.SCODE=D.SCODE ) SELECT FLAG, SCODE, SNAME, NLEVEL, CISLEAF, JE, BZ, ZHCB FROM TMP5 UNION ALL SELECT FLAG, SCODE, SNAME, NLEVEL, CISLEAF, JE, BZ*100 as bz, ZHCB FROM TMP9 UNION ALL SELECT DISTINCT FLAG, '20' AS SCODE, '二、年化融资成本情况(融资性债务)' AS SNAME, 1 AS NLEVEL, '0' AS CISLEAF, (SELECT SUM(JE) FROM TMP9) JE, (SELECT SUM(BZ)*100 FROM TMP9) BZ, ZHCB FROM TMP9 ORDER BY SCODE ",
        "sql": " WITH TMP AS( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, SUM(NVL(FACT_A,0)) AS FACT_A FROM DW_DIMFINANCE A LEFT JOIN ( SELECT :company AS DIM_COMPANY, DIM_FINANCE, SUM(NVL(FACT_A,0)) AS FACT_A FROM DW_FACTFINANCEDETAIL WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND DIM_PERIOD = :period GROUP BY DIM_FINANCE) B ON B.DIM_FINANCE LIKE A.SCODE||'%' WHERE ( SPCODE LIKE '10%' OR SCODE='10') GROUP BY SCODE, SPCODE, SNAME, NLEVEL, CISLEAF), TMP1 AS ( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, FACT_A FROM TMP WHERE NLEVEL=1) , TMP2 AS ( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, FACT_A FROM TMP WHERE NLEVEL=2 ) , TMP3 AS ( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, FACT_A FROM TMP WHERE NLEVEL=3 ) , TMP4 AS ( SELECT SCODE, SPCODE, SNAME, NLEVEL, CISLEAF, FACT_A FROM TMP WHERE NLEVEL=4 ) , TMP0 AS ( SELECT SCODE, SNAME, NLEVEL, CISLEAF, NVL(ZHCB,0) AS ZHCB FROM TMP A LEFT JOIN ( SELECT DIM_FINANCE, ( CASE WHEN SUM(NVL(FACT_A,0))=0 THEN 0 ELSE ROUND((SUM(NVL(FACT_A,0)*NVL(FACT_C,0))/SUM(NVL(FACT_A,0))),4) END) AS ZHCB FROM DW_FACTFINANCEDETAIL A WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND DIM_PERIOD = :period GROUP BY DIM_FINANCE ) B ON A.SCODE=B.DIM_FINANCE ) , TMP5 AS ( SELECT '0' AS FLAG, A.SCODE, SNAME, NLEVEL, CISLEAF, JE, BZ*100 AS BZ, NVL(ZHCB,0) AS ZHCB FROM ( SELECT SCODE, SNAME, NLEVEL, CISLEAF, ZHCB FROM TMP0) A INNER JOIN ( SELECT SCODE, FACT_A AS JE, 0 AS BZ FROM TMP1 UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP1 A INNER JOIN TMP2 B ON A.SCODE=B.SPCODE UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP2 A INNER JOIN TMP3 B ON A.SCODE=B.SPCODE UNION ALL SELECT B.SCODE, B.FACT_A AS JE, ( CASE WHEN A.FACT_A=0 THEN 0 ELSE ROUND(B.FACT_A/A.FACT_A,4) END) AS BZ FROM TMP3 A INNER JOIN TMP4 B ON A.SCODE=B.SPCODE) B ON A.SCODE=B.SCODE ORDER BY A.SCODE ) , TMP6 AS ( SELECT :company AS DIM_COMPANY, DIM_FINANCE, SENDDATE,SSTARTDATE, (CASE WHEN SENDDATE-SSTARTDATE<=10000 THEN (NVL(FACT_A,0)) ELSE 0 END) AS FACT_A1, (CASE WHEN SENDDATE-SSTARTDATE>10000 AND SENDDATE-SSTARTDATE<=50000 THEN (NVL(FACT_A,0)) ELSE 0 END) AS FACT_A15, (CASE WHEN SENDDATE-SSTARTDATE>50000 THEN (NVL(FACT_A,0)) ELSE 0 END) AS FACT_A16, (CASE WHEN SENDDATE-SSTARTDATE<=10000 THEN (NVL(FACT_C,0)) ELSE 0 END) AS FACT_C1, (CASE WHEN SENDDATE-SSTARTDATE>10000 AND SENDDATE-SSTARTDATE<=50000 THEN (NVL(FACT_C,0)) ELSE 0 END) AS FACT_C15, (CASE WHEN SENDDATE-SSTARTDATE>50000 THEN (NVL(FACT_C,0)) ELSE 0 END) AS FACT_C16 FROM DW_FACTFINANCEDETAIL WHERE DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' START WITH SCODE= :company CONNECT BY PRIOR SCODE=SPCODE) AND DIM_PERIOD=:period), TMP8 AS( SELECT '2001' AS SCODE,FACT_A1 AS FACT_A, FACT_C1 FACT_C FROM TMP6 UNION ALL SELECT '2002', FACT_A15 , FACT_C15 FROM TMP6 UNION ALL SELECT '2003', FACT_A16, FACT_C16 FROM TMP6 ) , TMP9 AS ( SELECT '0' AS FLAG,D.SCODE,CASE WHEN RZCBL IS NULL THEN D.SNAME||'('||0||'%)' ELSE D.SNAME||'('||TO_CHAR(RZCBL,'0.99')||'%)' END SNAME, NLEVEL,CISLEAF, JE, BZ, 0 AS ZHCB FROM ( SELECT B.SCODE,CASE WHEN SUM(NVL(FACT_A,0))=0 THEN 0 ELSE ROUND(SUM(FACT_A*FACT_C)/SUM(FACT_A),2) END RZCBL,SUM(FACT_A) JE, CASE WHEN AVG(NVL(FACT_ASUM,0))=0 THEN 0 ELSE ROUND(SUM(B.FACT_A)/AVG(FACT_ASUM),4) END BZ FROM TMP8 B LEFT JOIN (SELECT SUM(FACT_A) FACT_ASUM FROM TMP8) ON 1=1 GROUP BY B.SCODE) C RIGHT JOIN (SELECT SCODE,SNAME,NLEVEL,CISLEAF FROM DW_DIMFINANCE WHERE SPCODE LIKE '20%') D ON C.SCODE=D.SCODE) SELECT FLAG, SCODE, SNAME, NLEVEL, CISLEAF, NVL(JE,0) je, NVL(BZ,0) bz, ZHCB FROM TMP5 UNION ALL SELECT FLAG, SCODE, SNAME, NLEVEL, CISLEAF, NVL(JE,0), NVL(BZ*100,0) AS BZ, ZHCB FROM TMP9 UNION ALL SELECT DISTINCT FLAG, '20' AS SCODE, '二、年化融资成本情况(融资性债务)' AS SNAME, 1 AS NLEVEL, '0' AS CISLEAF, (SELECT SUM(NVL(JE,0)) FROM TMP9) JE, (SELECT SUM(NVL(BZ,0))*100 FROM TMP9) BZ, ZHCB FROM TMP9 ORDER BY SCODE",
        "_cube":{
          "subject":"0007",
          "cubeId":4
        },
        
        "mainDim":"itemperiod",
        "needDims":["year","month","company","conversion"],
        "random":{"min":100,"max":100000},
        "type":1
          
     },
     "layout": {
        "xtype": "tab"
    },
    "columns":[
        {
            "id": "zhcb",
            "type": "decimal",
            "text": "加权平均融资成本"
        },
      {
        "id": "xh",
        "type": "index",
        "text": "序号",
        "width":"60px"
      },
      {
        "id": "sname",
        "type": "string",
        "fixed": true,
        "text": "项目",
        "width":"260px"
      }, {
        "id": "je",
        "type": "decimal",
        "text": "金额"
    }, {
        "id": "bz",
        "type": "decimal",
        "text": "比重（%）",
        "conversion":"%"

    }
    ],
    "rows":[
  ],
  "items":[
    {
        "xtype": "bi-table",
        "id":"zwgc",
        "text":"债务构成情况分析表",
        "queryDataAfter":function(data){
            let bue = data.some(res => {
                return (res.scode=="2001" || res.scode=="2002" || res.scode=="2003") && res.bz && res.bz!=0 ;
            })
            if(bue){
                data.forEach(res => { if(res.scode=="20")res.bz=100.00; })
            }
            return data ;
        },
        "toolbar":[
            {
                "id":"1",
                "text":"刷新",
                "xtype":"button",
                "cellStyle":{
                    // "color":"black",
                    //    "background-color":"#189271"
                    // "background-color":"#fff"
                },
                "handler":function(vue,btn){
                    vue.item.updateView("company");
                }
            }, {
                "id":"2",
                "text":"导出",
                "cellStyle":{
                    // "color":"black",
                    //    "background-color":"#189271"
                    // "background-color":"#fff"
                },
                "handler":function(vue,btn){
                        vue.handleDownload(vue);
                }
            }
        ],
        "drillProperties":["sname"],//有钻取，给蓝色
        "levelProperties":{"sname":"nlevel"},//加缩进
        "cellStyle": function (row) {
            let datas = this.datas;
            let record = [];
            record = datas[row.rowIndex];
            let css = "padding: 4px 0;";
            let pro = row.column.property; //列id
            if (!pro) {
                return css;
            }
            let levelProperties = this.levelProperties;//行缩进
            let textIndent = "";
            let levelPro = levelProperties[pro];
            if (levelPro && record[levelPro]) {//行缩进处理
                let level = record[levelPro] || 1;
                textIndent = level > 1 ? "text-indent: " + (level - 1) * 20 + "px;" : ";";
            }
            let drillProperties = this.drillProperties; //钻取列获取
            if (drillProperties.indexOf(pro) != -1) { //匹配需要下钻的列
                if (record.cisleaf && ((record.je && record.je != 0) || (record.bz && record.bz != 0) || (record.rzcb && record.rzcb != 0) )) { //有数据时才显示蓝色，并且可以下钻(合计行不能下钻)
                    let drill = "text-decoration: none;color: #428bca;cursor: pointer;"; //可以下钻的科目的颜色的设置
                    css = css + "font-weight:bold;" + textIndent + drill;
                    datas[row.rowIndex].drill = true; //下钻设置
                    return css;
                } else {
                    return css + textIndent;
                }
            } else {
                return css + textIndent;
            }
        },
        "onCellClick": function (row, column, cell, event, option) {
            let datas = this.datas;
            let data = datas.filter(function(item){
                    return item.id == row.id;
            });
            let row2 = data[0];
            let cv = column.property + ""; //下钻行的标识
            let listener = row._drill || row.drill;
            if (listener && cv == "sname") {
                let text = row.sname; //下钻显示的标题
                // let id = row.id;
                let id = row.scode;
                option.commonHandler({
                    "type": "click", //事件类型
                    "way": "addTab", //调用的公共方法
                    "sourceApi": "/cnbi/json/source/tjsp/zwgcqkDrill.json", //下钻json路径
                    "handler": ($vue, params) => { //自定义的回调

                        console.info(params);
                        // let pp = {id:params.xxx,xxx};
                        //  $vue.popop = pp;
                    }
                }, {
                    row: row,
                    column: column,
                    cell: cell,
                    event: event
                }, {
                    id: id,
                    text: text
                });
            }
        }
    }
  ]
  }
  














