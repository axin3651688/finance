{
    "layout": {
        "xtype": "column"
    },
    "text": "应收账款",
    "id": "66601",
    "children": [{
            "xtype": "bi-table",
            "id": "yszk",
            "text": "应收账款",
            "show": false,
            "width": 6,
            "tableBefore": true,
            "queryDataBefore": function(params, config, $vue) {
                let me = this;
                let selectPeriod = $vue.$store.selectPeriod;
                if (selectPeriod) {
                    let year = selectPeriod.substring(0, 4);
                    let month = selectPeriod.substring(4, 6);
                    if (year) {
                        params.year = year;
                    }
                    if (month) {
                        params.month = month;
                    }
                    params.period = selectPeriod;
                }
                return params;
            },
            "tableBeforeFun": function($vue, params) {
                // debugger;
                let me = this;
                let period = $vue.$store.selectPeriod;
                let year = period.substring(0, 4);
                let month = period.substring(4, 6);
                let company = $vue.$store.getters.companyName;
                // let unit = "单位：元";
                let pStyle = "height:30px;line-height:30px;font-weight:bold;";
                let snStyle = "padding:5px 10px;";
                let currentUnit = "元";
                let html = "<p style='" + pStyle + "'><span style='" + snStyle + "'>" + company + "</span><span  style='" + snStyle + "'>(期间：" + year + "年" + month + "月" + "</span><span>单位：" + currentUnit + ")</span></p>";
                return html;
            },
            "showFun": function($store) {
                // debugger
                if ($store.getters.treeInfo.nisleaf) {
                    return true;
                } else {
                    return false;
                }
            },
            "queryDataAfter": function(data, $vue) {
                // debugger
                let datas = [];
                let datax = [];
                data.forEach(item => {
                    if ((item.balance && item.balance != 0) || (item.oneyear && item.oneyear != 0) ||
                        (item.twoyear && item.twoyear != 0) || (item.threeyear && item.threeyear != 0) ||
                        (item.fouryear && item.fouryear != 0)) {
                        datas.push(item);
                    } else {
                        datax.push(item);
                    }
                    if (item.scode == '9') item.scode = '';
                });
                if (datax.length > 0) {
                    datax.forEach(item => {
                        datas.push(item);
                    })
                }
                return data;
            },
            "config": {
                "sql": "SELECT NID, A.DIM_CUSUPPLIERNAME AS SK, FACT_BALANCE AS BALANCE, FACT_A AS ONEYEAR, FACT_B AS TWOYEAR, FACT_C AS THREEYEAR, FACT_D AS FOURYEAR, C.SNAME AS SKXZ,( CASE WHEN ISINSIDE is null then null when ISINSIDE='1' THEN '是' ELSE '否' END) AS SFNB, ( CASE WHEN ISNORMAL is null then null when ISNORMAL='1' THEN '是' ELSE '否' END) AS SFZC, A.SCONTENTA AS FZCFL, A.SCONTENTB AS ZWRZK, FACT_E AS KHSJE, FACT_F AS DNKHSJE, FACT_G AS YQZK, FACT_H AS SZXSSJE FROM ( SELECT NID, DIM_CUSUPPLIER, DIM_COMPANY, DIM_ITEM, FACT_BALANCE, FACT_A, FACT_B, FACT_C, FACT_D, ISNATURE, ISINSIDE, ISNORMAL, SCONTENTA, SCONTENTB, FACT_E, FACT_F, FACT_G, FACT_H,DIM_CUSUPPLIERNAME FROM DW_FACTAGEANALYSIS WHERE DIM_COMPANY=:company AND DIM_PERIOD=:period AND DIM_ITEM='1001' AND ISINSIDE IS NOT NULL) A LEFT JOIN ( SELECT SCODE, SNAME FROM DW_DIMDROPMENU WHERE SPCODE='10') C ON A.ISNATURE=C.SCODE LEFT JOIN ( SELECT SCODE, SNAME FROM DW_DIMDROPMENU WHERE SPCODE='11') D ON A.SCONTENTA=D.SCODE LEFT JOIN ( SELECT SCODE, SNAME FROM DW_DIMDROPMENU WHERE SPCODE='12') E ON A.SCONTENTB=E.SCODE ",
                "cube": {
                    "subject": "",
                    "cubeId": 4
                },
                "mainDim": "itemperiod",
                "needDims": ["year", "month", "company", "conversion"],
                "random": { "min": 100, "max": 100000 },
                "type": 1,
                "tableHeads": true,
                "columns": [{
                        "id": "szxssje",
                        "type": "decimal",
                        "width": "180px",
                        "text": "已形成实质性损失金额"
                    },
                    {
                        "id": "",
                        "type": "index",
                        "width": "60",
                        "text": "序号"
                    },
                    {
                        "id": "sk",
                        "type": "string",
                        "width": "330",
                        "fixed": true,
                        "text": "客商"
                    },
                    {
                        "id": "balance",
                        "type": "decimal",
                        "text": "余额"
                    },
                    {
                        "id": "zq",
                        "type": "string",
                        "text": "账期",
                        "children": [{
                                "id": "oneyear",
                                "type": "decimal",
                                "text": "1年以内"
                            },
                            {
                                "id": "twoyear",
                                "type": "decimal",
                                "text": "1-2年以内"
                            },
                            {
                                "id": "threeyear",
                                "type": "decimal",
                                "text": "2-3年以内"
                            },
                            {
                                "id": "fouryear",
                                "type": "decimal",
                                "text": "3年以上"
                            }
                        ]
                    },
                    {
                        "id": "skxz",
                        "type": "string",
                        "align": "center",
                        "text": "客商性质*"
                    },
                    {
                        "id": "sfnb",
                        "type": "string",
                        "align": "center",
                        "text": "是否内部*"
                    },
                    {
                        "id": "sfzc",
                        "type": "string",
                        "align": "center",
                        "text": "是否正常*"
                    },
                    {
                        "id": "fzcfl",
                        "type": "string",
                        "text": "非正常分类*"
                    },
                    {
                        "id": "zwrzk",
                        "type": "string",
                        "text": "债务人情况*"
                    },
                    {
                        "id": "khsje",
                        "type": "decimal",
                        "text": "可收回金额*"
                    },
                    {
                        "id": "dnkhsje",
                        "type": "decimal",
                        "width": "180px",
                        "text": "其中:当年可收回金额*"
                    },
                    {
                        "id": "yqzk",
                        "type": "decimal",
                        "text": "逾期账款"
                    }
                ],
                "rows": []

            }
        },
        {
            // "xtype": "STreeGrid",
            "xtype": "elementTree",
            "id": "yszkej",
            "text": "应收账款二级",
            "show": false,
            "tableBefore": true,
            "showFun": function($store) {
                if ($store.getters.treeInfo.nisleaf) {
                    return false;
                } else {
                    return true;
                }
            },
            "queryDataBefore": function(params, config, $vue) {
                // debugger;
                let me = this;
                let selectPeriod = $vue.$store.selectPeriod;
                if (selectPeriod) {
                    let year = selectPeriod.substring(0, 4);
                    let month = selectPeriod.substring(4, 6);
                    if (year) {
                        params.year = year;
                    }
                    if (month) {
                        params.month = month;
                    }
                    params.period = selectPeriod;
                }
                //上年12月的数据。
                params.oneYearBefore = params.year - 1 + "12";
                if (params.company == '1001') {
                    config.sql = config.sql1;
                } else {
                    config.sql = config.sql2;
                }
                // 预警比例请求
                let _sql = me.config.riskrangeSql;
                let user = $vue.$store.getters.user.user.userName;
                _sql = _sql.replace(/:company/g, "'" + params.company + "'").replace(/:period/g, "'" + params.period + "'").replace(/:suser/g, "'" + user + "'");
                let shuju = {
                    cubeId: 4,
                    sql: _sql
                }
                $vue.riskrangeRequest(shuju);
                // 
                return params;
            },
            "queryDataAfter": function(data, $vue) {
                // debugger
                let riskrangeData = $vue.riskrangeData;
                let first, second;
                if (riskrangeData.length == 0) {
                    first = 0;
                    second = 0;
                } else {
                    riskrangeData.forEach(qwe => {
                        if (qwe.sratiotype == 1) first = qwe.fact_a;
                        if (qwe.sratiotype == 2) second = qwe.fact_a;
                    })
                }
                // 循环
                data.forEach(res => {
                    if (first && first != 0 && res.zjl && res.zjl <= first) res.riskrange = "安全";
                    if (second && second != 0 && res.zjl && res.zjl >= second) res.riskrange = "预警";
                    if (first && first != 0 && second && second != 0 && res.zjl && res.zjl > first && res.zjl < second) res.riskrange = "提示";
                    if (first == 0 && second == 0) res.riskrange = "";
                    if (!res.zjl || res.zjl == 0) res.riskrange = "";
                })
                return data;
            },
            "config": {
                "sql2": 7,
                "sql1": 9,
                "sql": "",
                "riskrangeSql": " SELECT SRATIOTYPE, FACT_A, DIM_ITEM, SUSER FROM DW_FACTAGEANALYSIS_PERCENT where DIM_COMPANY=:company and DIM_PERIOD=:period and SUSER=:suser and DIM_ITEM='1001'",
                "_cube": {
                    "subject": "",
                    "cubeId": 4
                },
                "generateVar": {
                    "periodCount": 2,
                    "compareType": "-1&0",
                    "reverse": true
                },
                "mainDim": "itemperiod",
                "needDims": ["year", "month", "company", "conversion"],
                "random": { "min": 100, "max": 100000 },
                "type": 1,
                "tableHeads": true,
                "columns": [
                    // {
                    //     "text": "已形成实质性损失金额",
                    //     "type": "decimal",
                    //     "width": "180px",
                    //     "align": "right",
                    //     "id": "www4"
                    // },
                    // {
                    //     "text": "",
                    //     "type": "string",
                    //     "id": "",
                    //     "isTree": true
                    // },
                    {
                        "text": "公司编码",
                        "type": "string",
                        "fixed": true,
                        "width": "160",
                        "id": "gsbm"
                    },
                    {
                        "text": "公司名称",
                        "width": "360px",
                        "type": "string",
                        "fixed": true,
                        "id": "gsmc"
                    },
                    {
                        "text": "口径",
                        "type": "string",
                        "width": "120",
                        "align": "center",
                        "id": "kj"
                    },
                    {
                        "text": "余额",
                        "type": "decimal",
                        "width": "160",
                        "align": "right",
                        "id": "ye"
                    },
                    {
                        "text": "与年初相比增减额",
                        "type": "decimal",
                        "width": "160",
                        "align": "right",
                        "id": "zje"
                    },
                    {
                        "text": "与年初相比增减率（%）",
                        "type": "decimal",
                        "conversion": "%",
                        "align": "right",
                        "width": "180px",
                        "id": "zjl"
                    },
                    {
                        "text": "预警等级",
                        "type": "string",
                        "width": "120",
                        "id": "riskrange"
                    },
                    {
                        "id": "",
                        "type": "string",
                        "text": "账期",
                        "children": [{
                                "text": "1年以内",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "oneYear"
                            },
                            {
                                "text": "1-2年",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "twoYear"
                            },
                            {
                                "text": "2-3年",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "threeYear"
                            },
                            {
                                "text": "3年以上",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "allYear"
                            }
                        ]
                    },
                    {
                        "text": "正常金额",
                        "type": "decimal",
                        "width": "160",
                        "align": "right",
                        "id": "zcje"
                    },
                    {
                        "id": "",
                        "type": "string",
                        "text": "非正常金额",
                        "children": [{
                                "text": "向系统外出借资金",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "fff1"
                            },
                            {
                                "text": "成本费用挂账",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "fff2"
                            },
                            {
                                "text": "通过融资性贸易、赊销业务、虚假贸易等虚增应收",
                                "type": "decimal",
                                "width": "330px",
                                "align": "right",
                                "id": "fff3"
                            },
                            {
                                "text": "为其他企业代偿金融机构的贷款",
                                "type": "decimal",
                                "width": "230px",
                                "align": "right",
                                "id": "fff4"
                            },
                            {
                                "text": "长期挂账、未及时清理",
                                "type": "decimal",
                                "width": "180px",
                                "align": "right",
                                "id": "fff5"
                            },
                            {
                                "text": "核算不规范",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "fff6"
                            },
                            {
                                "text": "其他",
                                "type": "decimal",
                                "width": "160",
                                "align": "right",
                                "id": "fff7"
                            }
                        ]
                    },
                    {
                        "text": "可收回金额",
                        "type": "decimal",
                        "width": "160",
                        "align": "right",
                        "id": "www1"
                    },
                    {
                        "text": "其中：当年可收回金额",
                        "type": "decimal",
                        "width": "180px",
                        "align": "right",
                        "id": "www2"
                    },
                    {
                        "text": "逾期账款",
                        "type": "decimal",
                        "width": "160",
                        "align": "right",
                        "id": "www3"
                    },
                    {
                        "text": "已形成实质性损失金额",
                        "type": "decimal",
                        "width": "180px",
                        "align": "right",
                        "id": "www4"
                    }
                ],
                "rows": []
            },
            // proportion:[
            //     {
            //         "id": "1",
            //         "text": "安全比例",
            //         "placeholder": "请输入安全比例%",
            //         "cellStyle": {
            //             "width": "340px"
            //         },
            //         "input3": "",
            //         "show": false,
            //         "value": 0,                           
            //         "icon": "≤"
            //     },
            //     {
            //         "id": "2",
            //         "text": "预警比例",
            //         "placeholder": "请输入预警比例%",
            //         "cellStyle": {
            //             "width": "340px"
            //         },
            //         "input3": "",
            //         "value": 0,
            //         "show": false,
            //         "icon": "≥"
            //     }
            // ],
            "drillProperties": ["riskrange", "gsmc"],
            "__onRowClick": function(row, column, e, $this) {
                debugger
                let id = row.gsbm,
                    text = row.gsmc;
                if (this.drillProperties[1].indexOf(column.property) != -1) {
                    if (row.gsmc != "" && row.gsmc != undefined) {
                        if (this.config.sql == 9) { //一级公司下钻
                            let str = text;
                            let regex = /\(|\)|（|）/g;
                            let is = regex.test(text);
                            if (is) {
                                $this.commonHandler({
                                    "type": "click", //事件类型
                                    "way": "addTab", //调用的公共方法
                                    "sourceApi": "/cnbi/json/source/tjsp/yszkej.json",
                                    "handler": ($vue, params) => { //自定义的回调
                                        console.info(params);
                                        debugger;
                                    }
                                }, { row: row, column: column, e: e }, { id: id, text: text });
                            } else {
                                $this.commonHandler({
                                    "type": "click", //事件类型
                                    "way": "addTab", //调用的公共方法
                                    "sourceApi": "/cnbi/json/source/tjsp/yszkmxb.json",
                                    "handler": ($vue, params) => { //自定义的回调
                                        console.info(params);
                                        debugger;
                                    }
                                }, { row: row, column: column, e: e }, { id: id, text: text });
                            }
                        } else {
                            $this.commonHandler({
                                "type": "click", //事件类型
                                "way": "addTab", //调用的公共方法
                                "sourceApi": "/cnbi/json/source/tjsp/yszkmxb.json",
                                "handler": ($vue, params) => { //自定义的回调
                                    console.info(params);
                                    debugger;
                                }
                            }, { row: row, column: column, e: e }, { id: id, text: text });
                        }
                    }
                }
            },
            "levelProperties": { scode: "_level" }, //加缩进 可选 table
            "cellStyle": function(row, obj) {
                debugger

                let css = "padding: 4px 0;";

                let pro = row.column.property;
                if (!pro) {
                    return css;
                }

                let levelProperties = this.levelProperties; //缩进列获取
                let textIndent = "";
                let levelPro = levelProperties[pro];
                if (levelPro && row.row[levelPro]) {
                    let level = row.row[levelPro] || 1;
                    textIndent = "text-indent: " + (level * 20) + "px";
                }

                let record = row.row;
                let drillProperties = this.drillProperties;
                if (drillProperties.indexOf(pro) != -1) {
                    if (record.riskrange && record.riskrange == "安全" && pro != "gsmc") {
                        let drill = "text-decoration: none;color: green;font-weight: bold;cursor: pointer;text-align: center;";
                        css = css + "font-weight:bold;" + textIndent + drill;
                        return css;
                    } else if (record.riskrange && record.riskrange == "提示" && pro != "gsmc") {
                        let drill = "text-decoration: none;color: #FF9900;font-weight: bold;cursor: pointer;text-align: center;";
                        css = css + "font-weight:bold;" + textIndent + drill;
                        return css;
                    } else if (record.riskrange && record.riskrange == "预警" && pro != "gsmc") {
                        let drill = "text-decoration: none;color: red;font-weight: bold;cursor: pointer;text-align: center;";
                        css = css + "font-weight:bold;" + textIndent + drill;
                        return css;
                    }
                    // else if (pro == "gsmc" && record.gsmc != "总计") {
                    //     let drill = "text-decoration: none;color: #428bca;font-weight: bold;cursor: pointer;";
                    //     css = css + "font-weight:bold;" + textIndent + drill;
                    //     return css;
                    // } 
                    else {
                        return css + textIndent;
                    }
                } else {
                    return css + textIndent;
                }
            }
        }
    ]
}