{
    "id":"1013",
    "text":"资金集中情况汇总表",
    
    "layout": {
      "xtype": "tab"
    },
    "changeYearBefore":function(newyear,option){
        option.closeTabTaget(newyear,option);
    },
    "changeMonthBefore":function(newmonth,option){
        option.closeTabTaget(newmonth,option);
    },
    "changeCompanyBefore":function(newcompany,option){
        option.closeTabTaget(newcompany,option);
    },
    "changeConversionBefore": function(newconversion, option) {
      // debugger
      option.closeTabTaget(newconversion, option);
    },
    "__queryDataAfter":function(data,$vue){//数据的后置处理
        // debugger
      let me = this;
      // let datas = [];//有数据的
      // let datax = [];//没有数据对
      me.items[0].updateView = $vue.updateView;
      me.items[0].$vue = $vue;
    //   data.forEach((item,index)=>{
    //     if((item.hbzj && item.hbzj!=0) || (item.yhck && item.yhck!=0) || (item.jzje && item.jzje!=0)){
    //         datas.push(item);
    //     }else{
    //         datax.push(item); 
    //     }
    //   }); 
    //   if(datax.length>0){
    //     datax.forEach(item => {
    //         datas.push(item);  
    //     });
    //   }   
    //   return datas;
    return data ;
  },
    "showDims": ["year","month","company","conversion"],
    "config":{
      "sql": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE='1' CONNECT BY PRIOR SCODE = SPCODE) , T2 AS ( SELECT ROOT_SCODE, SCODE FROM T1 WHERE ROOT_SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' START WITH SCODE=:company CONNECT BY PRIOR SCODE = SPCODE ) ) , T3 AS ( SELECT ROOT_SCODE, COUNT(*) JZHS FROM ( ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) A1 INNER JOIN ( SELECT DISTINCT DIM_COMPANY FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period AND fact_c <>'0' ) A2 ON A1.SCODE = A2.DIM_COMPANY) GROUP BY ROOT_SCODE ) , T4 AS ( SELECT ROOT_SCODE, COUNT(*) HS FROM ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) GROUP BY ROOT_SCODE ) , T5 AS ( SELECT T2.ROOT_SCODE, HS, NVL(JZHS,0) JZHS, SUM(NVL(FACT_A,0)) AS HBZJ, SUM(NVL(FACT_B,0)) AS YHCK, SUM(NVL(FACT_C,0)) AS JZJE FROM T2 LEFT JOIN ( SELECT DIM_COMPANY , SUM(NVL(fact_a,0)) fact_a, SUM(case WHEN DIM_ACCOUNTBANKS='SH' THEN 0 ELSE fact_b END) fact_b, SUM(NVL(fact_c,0)) fact_c FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period AND DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL = 'N' AND STYPE='1' START WITH SCODE=:company CONNECT BY prior scode=spcode ) GROUP BY DIM_COMPANY ) A ON T2.SCODE=A.DIM_COMPANY LEFT JOIN T4 ON T2.ROOT_SCODE=T4.ROOT_SCODE LEFT JOIN T3 ON T2.ROOT_SCODE=T3.ROOT_SCODE GROUP BY T2.ROOT_SCODE, HS, JZHS ) SELECT t5.ROOT_SCODE AS scode, t5.ROOT_SCODE AS gsbm, spcode, TA.SNAME, HS, JZHS, CASE WHEN HS=0 THEN 0 ELSE ROUND(JZHS/HS*100, 4) END AS GKM, HBZJ, YHCK, JZJE, CASE WHEN HBZJ+JZJE=0 THEN 0 ELSE ROUND(JZJE/(HBZJ+JZJE)*100,4) END AS JZD FROM T5 LEFT JOIN DW_DIMCOMPANY TA ON TA.SCODE=T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE",
      // "sql": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE='1' CONNECT BY PRIOR SCODE = SPCODE) , T2 AS ( SELECT ROOT_SCODE, SCODE FROM T1 WHERE ROOT_SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' START WITH SCODE=:company CONNECT BY PRIOR SCODE = SPCODE ) ) , T3 AS ( SELECT ROOT_SCODE, COUNT(*) JZHS FROM ( ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) A1 INNER JOIN ( SELECT DISTINCT DIM_COMPANY FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period AND fact_c <>'0' ) A2 ON A1.SCODE = A2.DIM_COMPANY) GROUP BY ROOT_SCODE ) , T4 AS ( SELECT ROOT_SCODE, COUNT(*) HS FROM ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) GROUP BY ROOT_SCODE ) , T5 AS ( SELECT T2.ROOT_SCODE, HS, NVL(JZHS,0) JZHS, SUM(NVL(FACT_A,0)) AS HBZJ, SUM(NVL(FACT_B,0)) AS YHCK, SUM(NVL(FACT_C,0)) AS JZJE FROM T2 LEFT JOIN ( SELECT DIM_COMPANY , SUM(NVL(fact_a,0)) fact_a, SUM(NVL(fact_b,0)) fact_b, SUM(NVL(fact_c,0)) fact_c FROM DW_FACTCAPITALDETAIL WHERE DIM_BANKNAME IS NOT NULL AND DIM_PERIOD=:period AND NVL(DIM_ACCOUNTBANKS,0)<>'SH' AND DIM_COMPANY IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL = 'N' AND STYPE='1' START WITH SCODE=:company CONNECT BY prior scode=spcode ) GROUP BY DIM_COMPANY ) A ON T2.SCODE=A.DIM_COMPANY LEFT JOIN T4 ON T2.ROOT_SCODE=T4.ROOT_SCODE LEFT JOIN T3 ON T2.ROOT_SCODE=T3.ROOT_SCODE GROUP BY T2.ROOT_SCODE, HS, JZHS ) SELECT t5.ROOT_SCODE AS scode, t5.ROOT_SCODE AS gsbm, spcode AS pid, TA.SNAME, HS, JZHS, CASE WHEN HS=0 THEN 0 ELSE ROUND(JZHS/HS*100, 4) END AS GKM, HBZJ, YHCK, JZJE, CASE WHEN HBZJ+JZJE=0 THEN 0 ELSE ROUND(JZJE/(HBZJ+JZJE)*100,4) END AS JZD FROM T5 LEFT JOIN DW_DIMCOMPANY TA ON TA.SCODE=T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE",
      // "sql": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE='1' CONNECT BY PRIOR SCODE = SPCODE) , T2 AS ( SELECT ROOT_SCODE, SCODE FROM T1 WHERE ROOT_SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' START WITH SCODE=:company CONNECT BY PRIOR SCODE = SPCODE ) ) , T3 AS ( SELECT ROOT_SCODE, COUNT(*) JZHS FROM ( ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) A1 INNER JOIN ( SELECT DISTINCT DIM_COMPANY FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period AND fact_c <>'0' ) A2 ON A1.SCODE = A2.DIM_COMPANY) GROUP BY ROOT_SCODE ) , T4 AS ( SELECT ROOT_SCODE, COUNT(*) HS FROM ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) GROUP BY ROOT_SCODE ) , T5 AS ( SELECT T2.ROOT_SCODE, HS, NVL(JZHS,0) JZHS, SUM(NVL(FACT_A,0)) AS HBZJ, SUM(NVL(FACT_B,0)) AS YHCK, SUM(NVL(FACT_C,0)) AS JZJE FROM T2 LEFT JOIN ( select DIM_COMPANY ,sum(nvl(fact_a,0)) fact_a,sum(nvl(fact_b,0)) fact_b,sum(nvl(fact_c,0)) fact_c FROM DW_FACTCAPITALDETAIL WHERE DIM_BANKNAME is not null AND DIM_PERIOD=:period and nvl(DIM_ACCOUNTBANKS,0)<>'SH' and DIM_COMPANY in ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL = 'N' AND STYPE='1' start with SCODE=:company connect by prior scode=spcode ) group by DIM_COMPANY ) A ON T2.SCODE=A.DIM_COMPANY LEFT JOIN T4 ON T2.ROOT_SCODE=T4.ROOT_SCODE LEFT JOIN T3 ON T2.ROOT_SCODE=T3.ROOT_SCODE GROUP BY T2.ROOT_SCODE, HS, JZHS ) SELECT t5.ROOT_SCODE AS scode, t5.ROOT_SCODE AS gsbm, spcode AS pid, TA.SNAME, HS, JZHS, CASE WHEN HS=0 THEN 0 ELSE ROUND(JZHS/HS*100, 4) END AS GKM, HBZJ, YHCK, JZJE, CASE WHEN t5.ROOT_SCODE='1001' THEN ( CASE WHEN HBZJ=0 THEN 0 ELSE ROUND(JZJE/HBZJ*100,4) END) ELSE ( CASE WHEN YHCK+JZJE=0 THEN 0 ELSE ROUND(JZJE/(YHCK+JZJE)*100,4) END) END AS JZD FROM T5 LEFT JOIN DW_DIMCOMPANY TA ON TA.SCODE=T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE",
      // "sql":"WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE='1' CONNECT BY PRIOR SCODE = SPCODE) , T2 AS ( SELECT ROOT_SCODE, SCODE FROM T1 WHERE ROOT_SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' START WITH SCODE=:company CONNECT BY PRIOR SCODE = SPCODE ) ) , T3 AS ( SELECT ROOT_SCODE, COUNT(*) JZHS FROM ( ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) A1 INNER JOIN ( SELECT DISTINCT DIM_COMPANY FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period and fact_c <>'0' ) A2 ON A1.SCODE = A2.DIM_COMPANY) GROUP BY ROOT_SCODE ) , T4 AS ( SELECT ROOT_SCODE, COUNT(*) HS FROM ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) GROUP BY ROOT_SCODE ) , T5 AS ( SELECT T2.ROOT_SCODE, HS, NVL(JZHS,0) JZHS, SUM(NVL(FACT_A,0)) AS HBZJ, SUM(NVL(FACT_B,0)) AS YHCK, SUM(NVL(FACT_C,0)) AS JZJE FROM T2 LEFT JOIN ( SELECT DIM_COMPANY, fact_a, fact_b, fact_c FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period AND DIM_ACCOUNTBANKS='SH') A ON T2.SCODE=A.DIM_COMPANY LEFT JOIN T4 ON T2.ROOT_SCODE=T4.ROOT_SCODE LEFT JOIN T3 ON T2.ROOT_SCODE=T3.ROOT_SCODE GROUP BY T2.ROOT_SCODE, HS, JZHS ) SELECT t5.ROOT_SCODE AS scode, t5.ROOT_SCODE AS gsbm, spcode AS pid, TA.SNAME, HS, JZHS, CASE WHEN HS=0 THEN 0 ELSE ROUND(JZHS/HS*100, 4) END AS GKM, HBZJ, YHCK, JZJE, CASE WHEN t5.ROOT_SCODE='1001' THEN ( CASE WHEN HBZJ=0 THEN 0 ELSE ROUND(JZJE/HBZJ*100,4) END) ELSE ( CASE WHEN YHCK+JZJE=0 THEN 0 ELSE ROUND(JZJE/(YHCK+JZJE)*100,4) END) END AS JZD FROM T5 LEFT JOIN DW_DIMCOMPANY TA ON TA.SCODE=T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE",
      // "sql": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE='1' CONNECT BY PRIOR SCODE = SPCODE) , T2 AS ( SELECT ROOT_SCODE, SCODE FROM T1 WHERE ROOT_SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' START WITH SCODE=:company CONNECT BY PRIOR SCODE = SPCODE ) ) , T3 AS ( SELECT ROOT_SCODE, COUNT(*) JZHS FROM ( ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) A1 INNER JOIN ( SELECT DISTINCT DIM_COMPANY FROM DW_FACTCAPITALDETAIL WHERE DIM_PERIOD=:period) A2 ON A1.SCODE = A2.DIM_COMPANY) GROUP BY ROOT_SCODE ) , T4 AS ( SELECT ROOT_SCODE, COUNT(*) HS FROM ( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE STYPE='1' AND CISDEL='N' CONNECT BY PRIOR SCODE = SPCODE) GROUP BY ROOT_SCODE ) , T5 AS ( SELECT T2.ROOT_SCODE, HS, NVL(JZHS,0) JZHS, SUM(NVL(FACT_A,0)) AS HBZJ, SUM(NVL(FACT_B,0)) AS YHCK, SUM(NVL(FACT_C,0)) AS JZJE FROM T2 LEFT JOIN (select DIM_COMPANY, fact_a, fact_b, fact_c from DW_FACTCAPITALDETAIL where DIM_PERIOD=:period and DIM_ACCOUNTBANKS='SH') A ON T2.SCODE=A.DIM_COMPANY LEFT JOIN T4 ON T2.ROOT_SCODE=T4.ROOT_SCODE LEFT JOIN T3 ON T2.ROOT_SCODE=T3.ROOT_SCODE GROUP BY T2.ROOT_SCODE, HS, JZHS ) SELECT t5.ROOT_SCODE AS scode, t5.ROOT_SCODE AS gsbm, spcode AS pid, TA.SNAME, HS, JZHS, CASE WHEN HS=0 THEN 0 ELSE ROUND(JZHS/HS*100, 4) END AS GKM, HBZJ, YHCK, JZJE, CASE WHEN t5.ROOT_SCODE='1001' THEN ( CASE WHEN HBZJ=0 THEN 0 ELSE ROUND(JZJE/HBZJ*100,4) END) ELSE ( CASE WHEN YHCK+JZJE=0 THEN 0 ELSE ROUND(JZJE/(YHCK+JZJE)*100,4) END) END AS JZD FROM T5 LEFT JOIN DW_DIMCOMPANY TA ON TA.SCODE=T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ",
      "_cube":{
        "subject":"0001",
        "cubeId":5
      },
      "mainDim":"itempoint",
      "needDims":["year","month","company","conversion"],
      "random":{"min":100,"max":100000},
      "type":1     
    },
    "columns": [
      // {
      //   "text": "集中度（%）",
      //   "type":"decimal",
      //   "conversion":"%",
      //   "width":"120",
      //   "align":"right",
      //   "id": "jzd"
      // },
      // {
      //     "text": "",
      //     "type":"string",
      //     "id": "",
      //     "width":"120",
      //     "isTree":true
      // },
      {
          "text": "公司编码",
          "type":"string",
          // "fixed": true,
          "width":"180",
          "id": "scode"
      },
      {
          "text": "公司名称",
          "type":"string",
          "width":"360",
          // "fixed": true,
          "id": "sname"
        },
        {
          "text": "下级户数",
          "type":"number",
          "width":"120",
          "align":"center",
          "id": "hs"
        },
        {
          "text": "下级集中户数",
          "width":"150",
          "align":"center",
          "type":"number",
          "id": "jzhs"
        },
        {
          "text": "管控面（%）",
          "type":"decimal",
          "width":"160",
          "align":"right",
          "conversion":"%",
          "id": "gkm"
        },
        {
          "text": "货币金额",
          "type":"decimal",
          "width":"200px",
          "align":"right",
          "id": "hbzj"
        },
        {
          "text": "其中：银行存款",
          "type":"decimal",
          "width":"200px",
          "align":"right",
          "id": "yhck"
        },
        {
          "text": "集中金额",
          "type":"decimal",
          "width":"200px",
          "align":"right",
          "id": "jzje"
        },
        {
          "text": "集中度（%）",
          "type":"decimal",
          "conversion":"%",
          "width":"160",
          "align":"right",
          "id": "jzd"
        }
        
    ],
    "rows":[],
    "items": [{
      // "xtype": "STreeGrid",
      "xtype": "elementTree",
      "isUnfold": true,// 自动展开的配置
      "id": "zjjzqkhz",
      "text": "资金集中情况汇总表",
      "toolbar":[{
        "id":"1",
        "text":"刷新",
        "xtype":"button",
        "cellStyle":{
            // "color":"black",
            // "background-color":"#fff"
        },
        "handler":function(vue,btn){
            // debugger
            // console.log(vue);
            let $vue = vue.item.$vue;
            $vue.closeTabTaget({}, $vue);
            vue.item.updateView("company");
        }
    }
    , {
       "id":"2",
       "text":"导出",
       "xtype":"button",
       "cellStyle":{
            // "color":"black",
            // "background-color":"#fff"
        },
       "handler":function(vue,btn){
          //  debugger
          //  console.log(vue);
           vue.handleDownload(vue);
       }
    }
  ],
      "onRowClick":function(row,e,col,$vue){
          // debugger
          let id = row.scode, text = row.sname ;
          if(this.drillProperties.indexOf(col.property) != -1){
            if(row.jzhs && row.jzhs>0){  
                $vue.commonHandler(
                    {
                      "type":"click",
                      "way":"addTab",
                      "sourceApi":"/cnbi/json/source/tjsp/zjjzqkmxb.json",
                      "handler":($vue,params)=>{
                          // console.info(params);
                          // debugger; 
                      } 
                    },
                    { row: row, e: e, col: col },
                    { id: id, text: text }
                );
            }      
            
          } 
      },
      "drillProperties":["jzhs"],//有钻取，给蓝色 可选 table
      "levelProperties":{scode:"_level"},//加缩进 可选 table
      "cellStyle":function(row,obj){
        
        let css = "padding: 4px 0;";
        let pro = row.column.property;
        if (!pro) {
            return css;
        }
        
        let levelProperties = this.levelProperties;//缩进列获取
        let textIndent ="";
        let levelPro = levelProperties[pro];
        if (levelPro && row.row[levelPro]) {
            let level = row.row[levelPro] || 1;
            textIndent = "text-indent: " + (level*20) + "px" ; 
        }
        
        let record = row.row;  //获取的行数据  
        let drillProperties = this.drillProperties;//给那一列赋予蓝色
        if(drillProperties.indexOf(pro) != -1){
            if(record.jzhs && record.jzhs>0){
              // return ;
              let drill = "text-decoration: none;color: #428bca;cursor: pointer;";
              css = css + "font-weight:bold;" + textIndent + drill;
              return css;
            }else{
              return css+textIndent;
            }
        }else{
            return css+textIndent;
        }
      }
      
  }],
  "code":200,"msg":"查询数据源【company】维度成功！"
  }