{
	"layout": {
		"xtype":"column"
	},
	"id": "888",
	"text": "指标分析",
	"items": [
		{
			"xtype": "chart",
			"id": "1403100000",
			"text": "前五行业效果图",
			"weight": 24,
			
			"closable": true,
			"show": true,
			"jdugeData":function(item){
				for(let key in item){
					if(item[key] && typeof(item[key]) == "number" && item[key] > 0){
						return true;
					}
				}
				return false;
			},
			"queryDataBefore":function(params,config,$vue){
				let me = this;
				let itemscode = $vue.$store.itemscode;
				if(itemscode){
					params.itemscode = itemscode;
				}
				return params;
			},
			"queryDataAfter":function(data){
				debugger;
				let me = this,otherData,flag = false;
				if(data.length < 6){
					data = data.filter(function(item,index){
						return item.indscode != '999'
					});
				}else{
					otherData = data.filter(function(item,index){
						return item.indscode == '999'
					});
					flag = me.jdugeData(otherData[0]);
					if(!flag){
						data = data.filter(function(item,index){
							return item.indscode != '999'
						});
					};
				};
				return data;
			},
			"config": {
				"sql":"WITH TMP AS(SELECT T.SINDCODE AS INDSCODE,C.SNAME AS HYMC,(CASE WHEN T.DIM_ITEMPERIOD='1416001' THEN NVL(D.FACT_A,0) ELSE NVL(D.FACT_B,0) END) AS BNJY, LJWC,SNLJWC FROM (SELECT SCODE,SINDCODE,DIM_ITEMPERIOD, SUM(CASE WHEN B.DIM_PERIOD=:period THEN NVL(B.FACT_B,0) ELSE 0 END) AS LJWC, SUM(CASE WHEN B.DIM_PERIOD=:comparePeriod THEN NVL(B.FACT_B,0) ELSE 0 END) AS SNLJWC FROM DW_DIMCOMPANY A INNER JOIN DW_FACTFINANCEPERIOD B ON B.DIM_COMPANY=A.SCODE AND B.DIM_PERIOD IN(:period,:comparePeriod) AND DIM_ITEMPERIOD=:itemscode WHERE A.SCODE IN (SELECT SCODE FROM DW_DIMCOMPANY WHERE SINDCODE IS NOT NULL START WITH SCODE=:company CONNECT BY PRIOR SCODE=SPCODE) GROUP BY SCODE,SINDCODE,DIM_ITEMPERIOD)T INNER JOIN DW_DIMINDUSTRY C ON T.SINDCODE=C.SCODE LEFT JOIN DW_FACTTARGETASSESSMENT D ON T.SCODE=D.DIM_COMPANY AND D.DIM_PERIOD =:period), TMP0 AS (SELECT ROWNUM AS XH,INDSCODE,HYMC,BNJY,LJWC,(CASE WHEN BNJY=0 THEN 0 ELSE ROUND(LJWC/BNJY*100,2) END) AS LJWCL, SNLJWC, LJWC-SNLJWC AS TBZJE,(CASE WHEN SNLJWC=0 THEN 0 ELSE ROUND((LJWC-SNLJWC)/SNLJWC*100,2) END) AS TBZJL FROM TMP) SELECT INDSCODE,HYMC,BNJY,LJWC,LJWCL,SNLJWC,TBZJE,TBZJL FROM TMP0 WHERE XH<=5 UNION ALL SELECT '999' AS INDSCODE,'其他' AS HYMC,NVL(SUM(BNJY),0) AS BNJY,NVL(SUM(LJWC),0) AS LJWC, (CASE WHEN SUM(BNJY)=0 THEN 0 ELSE NVL(ROUND(SUM(LJWC)/SUM(BNJY)*100,2),0) END) AS LJWCL, NVL(SUM(SNLJWC),0) AS SNLJWC,NVL((SUM(LJWC)-SUM(SNLJWC)),0) AS TBZJE, (CASE WHEN SUM(SNLJWC)=0 THEN 0 ELSE NVL((ROUND((SUM(LJWC)-SUM(SNLJWC))/SUM(SNLJWC)*100,2)),0) END ) AS TBZJL FROM TMP0 WHERE XH>5 ",
				"_cube": {
					"subject": "0001",
					"cubeId": 4
				},
				"mainDim": "itempoint",
				"needDims": [
					"year",
					"month",
					"company"
				],
				"random": {
					"min": 100,
					"max": 100000
				},
				"type": 1,
				"generateVar":{
					"periodCount":2,
					"compareType":"-1&0",
					"reverse":true
				},
				"columns": [
					{
						"id": "tbzjl",
						"type": "decimal",
						"text": "同比增减率"
					},
					{
						"id": "hymc",
						"type": "string",
						"text": "行业名称"
					},
					{
						"id": "mbjy",
						"type": "decimal",
						"text": "全年考核目标建议值"
					},
					{
						"id": "ljwc",
						"type": "decimal",
						"text": "累计完成"
					},
					{
						"id": "ljwcl",
						"type": "decimal",
						"text": "累计完成率"
					},
					{
						"id": "snljwc",
						"type": "decimal",
						"text": "上年同期"
					},
					{
						"id": "tbzje",
						"type": "decimal",
						"text": "同比增减额"
					}	
				],
				"rows": []
			},
			"listeners":[
				{
					"type":"click",
					"way":"addTab",
					"clickBefore":function(listener,$vue,params){
						let me = this;
						let id = "",text = params.name;
						let drillConfigNo = {};
						if(text == "其他"){
							debugger;
							$vue.$notify({
								title: '提示',
								message: '这个节点不提供下钻！',
								type: 'warning'
							});
							listener.drillChartNo = true;
							return listener;
						}
						listener.drillChartNo = false;
						let textObj = {id:id,text:text};
						listener.textObj = textObj;
						return listener;
					},
					"sourceApi":"/cnbi/json/source/tjsp/ybpTreeDebug.json",
					"handler": ($vue,params) =>{
						let me = this;
						let name = params.name;
						let data;
						if(name){
							data = $vue.item.datas.filter(function(it,indx){
								return it.hymc == name;
							})
						}
						$vue.$store.chartData = data;
						console.log(params);
					}
				}
			],
			"options": {
				"type": "advancechart",
				"subType": "pie",
				"getData": {
					"type": 2,
					"columns": [
						{
							"id": "hymc",
							 "prop":"name"
						},
						{
							"id": "ljwc",
							 "prop":"value"
						}
					],
					"sign":"pie",
					"scope": true
				}
			},
			"chartOptions": {
				"dd": "this.item.text",
				"height_s":"400px",
				"unitObj":{
					"mult":10000,
					"unitName":"万元"
				},
                "title": {
                    "text": "this.item.text",
                    "x": "center"
                },
                "tooltip": {
					"trigger": "item",
					"confine": true,
                    "formatter": "{b} : {c} ({d}%)"
				},
                "series": [{
                    "name": "",
                    "type": "pie",
                    "radius": "55%",
                    "center": ["50%", "50%"],
					"data": "this.item.options.datas",
					"label":{
						"formatter":function(params){
							return params.name + "：" + Math.decimalToLocalString(params.value/10000) + "万元 (" + params.percent + "%)";
						}
					},
                    "itemStyle": {
                        "emphasis": {
                            "shadowBlur": 10,
                            "shadowOffsetX": 0,
                            "shadowColor": "rgba(0, 0, 0, 0.5)"
                        }
                    }
				}],
				"legend": {
					"bottom": 10,
					"left": "center",
                    // "orient": "vertical",
                    // "left": "5%",
                    // "top": "10%",
                    "data": "[this.item.chartOptions.series[0].data.map(item=>{return item.name; })]"
                }
               
            }
		},
		{
			"xtype": "bi-table",
			"id": "1400111",
			"text": "这个也是钻取过来的表",
			"weight": 24,
			"unit":10000,
			// "height":400,
			"show": true,
			"jdugeData":function(item){
				for(let key in item){
					if(item[key] && typeof(item[key]) == "number" && item[key] > 0){
						return true;
					}
				}
				return false;
			},
			"conversionUnit":function(unit){
				let me = this;
				let unitObjs = [
					{"text":"万元","value":10000},
					{"text":"千元","value":1000},
					{"text":"百元","value":100},
					{"text":"十元","value":10},
					{"text":"元","value":1}
				];
				if(!unit){
					unit = me.unit;
				}
				if(!unit){
					unit = "元";
				}
				for(let i = 0;i < unitObjs.length;i ++){
					let unitItem = unitObjs[i];
					if(unitItem.text == unit){
						return unitItem.value;
					}
				}
				return 1;
			},
			"queryDataBefore":function(params,config,$vue){
				let me = this;
				let itemscode = $vue.$store.itemscode;
				if(itemscode){
					params.itemscode = itemscode;
				}
				return params;
			},
			"queryDataAfter":function(data){
				let me = this,otherData,flag = false;
				let columns = me.config.columns;
				let unit = me.unit;
				if(!unit){
					unit = 1;
				}
				if(data.length < 7){
					data = data.filter(function(item,index){
						return item.indscode != '999'
					});
				}else{
					otherData = data.filter(function(item,index){
						return item.indscode == '999'
					});
					flag = me.jdugeData(otherData[0]);
					if(!flag){
						data = data.filter(function(item,index){
							return item.indscode != '999'
						});
					};
				};
				if(columns && columns.length > 0){
					for(let i = 0;i < data.length;i ++){
						let dataItem = data[i];
						for(let j = 0;j < columns.length;j ++){
							let columnItem = columns[j];
							if(columnItem.unit && columnItem.unit == "万元"){
								let columnId = columnItem.id;
								if(dataItem[columnId]){
									dataItem[columnId] = dataItem[columnId]/(unit? unit:10000);
								}
							}
						}
					}
				}
				return data;
			},
			"listeners":[
				{
					"type":"click",
					"way":"addTab",
					"sourceApi":"/cnbi/json/source/tjsp/ybpTreeDebug.json",
					"handler": ($vue,params) =>{
						let me = this;
						let name = params.name;
						let data;
						if(name){
							data = $vue.item.datas.filter(function(it,indx){
								return it.hymc == name;
							})
						};
						$vue.$store.chartData = data;
						console.log(params);
					}
				}
			],
			"cellStyle":function(row,that){
				let me = this;
				if(row.columnIndex == 0 && row.row.hymc != "合计" && row.row.hymc != "其他"){
					let css = "color: #428bca;cursor: pointer;";
					return css;
				}
			},
			"onCellClick":function(row, column, cell, event, option){
				debugger;
				let me = this;
				if(cell.cellIndex != 0 || cell.innerText == "合计" || cell.innerText == "其他"){
					return;
				};
				let listeners = this.listeners[0];	
				let params = {name:row.hymc},id = row.id,text = row.hymc;
				let textObj = {id:id,text:text};
				option.commonHandler(listeners,params,textObj);
			},
			"config": {
				"sql":"WITH TMP AS(SELECT T.SINDCODE AS INDSCODE,C.SNAME AS HYMC,(CASE WHEN T.DIM_ITEMPERIOD='1416001' THEN NVL(D.FACT_A,0) ELSE NVL(D.FACT_B,0) END) AS BNJY, LJWC,SNLJWC FROM (SELECT SCODE,SINDCODE,DIM_ITEMPERIOD, SUM(CASE WHEN B.DIM_PERIOD=:period THEN NVL(B.FACT_B,0) ELSE 0 END) AS LJWC, SUM(CASE WHEN B.DIM_PERIOD=:comparePeriod THEN NVL(B.FACT_B,0) ELSE 0 END) AS SNLJWC FROM DW_DIMCOMPANY A INNER JOIN DW_FACTFINANCEPERIOD B ON B.DIM_COMPANY=A.SCODE AND B.DIM_PERIOD IN(:period,:comparePeriod) AND DIM_ITEMPERIOD=:itemscode WHERE A.SCODE IN (SELECT SCODE FROM DW_DIMCOMPANY WHERE SINDCODE IS NOT NULL START WITH SCODE=:company CONNECT BY PRIOR SCODE=SPCODE) GROUP BY SCODE,SINDCODE,DIM_ITEMPERIOD)T INNER JOIN DW_DIMINDUSTRY C ON T.SINDCODE=C.SCODE LEFT JOIN DW_FACTTARGETASSESSMENT D ON T.SCODE=D.DIM_COMPANY AND D.DIM_PERIOD =:period), TMP0 AS (SELECT ROWNUM AS XH,INDSCODE,HYMC,BNJY,LJWC,(CASE WHEN BNJY=0 THEN 0 ELSE ROUND(LJWC/BNJY*100,2) END) AS LJWCL, SNLJWC, LJWC-SNLJWC AS TBZJE,(CASE WHEN SNLJWC=0 THEN 0 ELSE ROUND((LJWC-SNLJWC)/SNLJWC*100,2) END) AS TBZJL FROM TMP) SELECT INDSCODE,HYMC,BNJY,LJWC,LJWCL,SNLJWC,TBZJE,TBZJL FROM TMP0 WHERE XH<=5 UNION ALL SELECT '999' AS INDSCODE,'其他' AS HYMC,NVL(SUM(BNJY),0) AS BNJY,NVL(SUM(LJWC),0) AS LJWC, (CASE WHEN SUM(BNJY)=0 THEN 0 ELSE NVL(ROUND(SUM(LJWC)/SUM(BNJY)*100,2),0) END) AS LJWCL, NVL(SUM(SNLJWC),0) AS SNLJWC,NVL((SUM(LJWC)-SUM(SNLJWC)),0) AS TBZJE, (CASE WHEN SUM(SNLJWC)=0 THEN 0 ELSE NVL((ROUND((SUM(LJWC)-SUM(SNLJWC))/SUM(SNLJWC)*100,2)),0) END ) AS TBZJL FROM TMP0 WHERE XH>5 UNION ALL SELECT '9999' AS INDSCODE,'合计' AS HYMC,SUM(BNJY) AS BNJY,SUM(LJWC) AS LJWC,(CASE WHEN SUM(BNJY)=0 THEN 0 ELSE ROUND(SUM(LJWC)/SUM(BNJY)*100,2) END) AS LJWCL, SUM(SNLJWC) AS SNLJWC, SUM(LJWC)-SUM(SNLJWC) AS TBZJE,(CASE WHEN SUM(SNLJWC)=0 THEN 0 ELSE ROUND((SUM(LJWC)-SUM(SNLJWC))/SUM(SNLJWC)*100,2) END ) AS TBZJL FROM TMP",
				"_cube": {
					"subject": "0001",
					"cubeId": 4
				},
				"mainDim": "itempoint",
				"needDims": [
					"year",
					"month",
					"company"
				],
				"random": {
					"min": 100,
					"max": 100000
				},
				"type": 1,
				"generateVar":{
					"periodCount":2,
					"compareType":"-1&0",
					"reverse":true
				},
				"columns": [
					{
						"id": "tbzjl",
						"type": "decimal",
						"text": "同比增减率"
					},
					{
						"id": "hymc",
						"type": "string",
						"text": "行业名称",
						"width":"300px"
					},
					{
						"id": "bnjy",
						"type": "decimal",
						"text": "全年考核目标建议值",
						"unit":"万元"
					},
					{
						"id": "ljwc",
						"type": "decimal",
						"text": "累计完成",
						"unit":"万元"
					},
					{
						"id": "ljwcl",
						"type": "decimal",
						"text": "累计完成率"
					},
					{
						"id": "snljwc",
						"type": "decimal",
						"text": "上年同期",
						"unit":"万元"
					},
					{
						"id": "tbzje",
						"type": "decimal",
						"text": "同比增减额",
						"unit":"万元"
					}	
				],
				"rows": []
			}
		}
	]
}