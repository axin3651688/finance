{
    "id": "0014253678",
    "text": "集团年度目标考核建议值",
    "layout": {
        "xtype": "tab"
    },
    "showDims": ["year", "month", "company", "conversion"],
    "queryDataBefore": function(params, config, $vue) {
        // debugger
        if ($vue.id === "0014253678") {
            let yearBefore = params.year - 1;
            config.sql = config.sql2.replace(/:yearBefore/g, "'" + yearBefore + "'");
        }
        return params;
    },
    "__queryDataAfter": function(data, $vue) { //数据的后置处理
        let me = this;
        me.items[0].updateView = $vue.updateView;
        me.items[0].$vue = $vue;
        return data;
    },
    "config": {
        "sql": "",
        "sql2": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE IN ('1', 'R') START WITH SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) , t2 AS ( SELECT T6.ROOT_SCODE AS GSBM, T6.SNAME AS GSMC, A AS YEWC, B AS YEMB, ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL, C AS LRWC, D AS LRMB, LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE, SUM(NVL(T2.FACT_B,0)) AS fact_b, SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B, 0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B, 0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_PERIOD=:period AND DIM_COMPANY IN ( SELECT SCODE FROM T1) GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE, SNAME, C, D, ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12' , FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13' , FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ) SELECT GSBM as scode, GSMC, B.SPCODE, YEWC, a.fact_a YEMB, round((case when YEWC=0 then 0 else (a.fact_a-YEWC)*100/YEWC end),4) as YETBZJL, LRWC, a.fact_b LRMB, round((case when LRWC=0 then 0 else (a.fact_b-LRWC)*100/LRWC end),4) as LRTBZJL FROM t2 LEFT JOIN DW_FACTTARGETASSESSMENT a ON a.DIM_COMPANY=GSBM AND SUBSTR(a.DIM_PERIOD,0,4)=SUBSTR(:period,0,4) LEFT JOIN DW_DIMCOMPANY B ON GSBM=B.SCODE ORDER BY gsbm",
        // "sql2": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE IN ('1', 'R') START WITH SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) , t2 AS ( SELECT T6.ROOT_SCODE AS GSBM, T6.SNAME AS GSMC, A AS YEWC, B AS YEMB, ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL, C AS LRWC, D AS LRMB, LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE, SUM(NVL(T2.FACT_B,0)) AS fact_b, SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_PERIOD=:period AND DIM_COMPANY IN ( SELECT SCODE FROM T1) GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE, SNAME, C, D, ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12', FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13', FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ) SELECT GSBM, GSMC, B.SPCODE pid, YEWC, a.fact_a YEMB, (a.fact_a-YEWC) as YETBZJL, LRWC, a.fact_b LRMB, LRTBZJL FROM t2 LEFT JOIN DW_FACTTARGETASSESSMENT a ON a.DIM_COMPANY=GSBM AND substr(a.DIM_PERIOD,0,4)=substr(:period,0,4) LEFT JOIN DW_DIMCOMPANY B ON GSBM=B.SCODE ORDER BY gsbm",
        // "sql2": "with T1 as( select CONNECT_BY_ROOT SCODE as ROOT_SCODE, SCODE from DW_DIMCOMPANY where CISDEL='N' and STYPE in ('1', 'R') start with SCODE in ( select SCODE from DW_DIMCOMPANY start with SCODE = :company connect by PRIOR SCODE = SPCODE) connect by PRIOR SCODE = SPCODE ) , t2 as ( select T6.ROOT_SCODE as GSBM, T6.SNAME as GSMC, A as YEWC, B as YEMB, round(decode(A,0,0,(B-A)/A),4)*100 as YETBZJL, C as LRWC, D as LRMB, LRTBZJL from ( select ROOT_SCODE, SNAME, sum(FACT_B) A, sum(YEKHMB) B from ( select T1.ROOT_SCODE, sum(nvl(T2.FACT_B,0)) as fact_b, sum(nvl(T3.YEKHMB,0)) as YEKHMB from T1 left join ( select DIM_COMPANY, decode(JS,1,B2,B1) as FACT_B from ( select A.DIM_COMPANY, B1, B2, nvl(JS,0) as JS from ( ( select DIM_COMPANY, sum(decode(DIM_PERIOD,'2017'||'12',FACT_B,0)) as B1, sum(decode(DIM_PERIOD,'2017'||'13',FACT_B,0)) as B2 from DW_FACTFINANCEPERIOD where DIM_ITEMPERIOD ='1416001' and DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD in ('2017'||'12', '2017'||'13') group by DIM_COMPANY)A left join ( select DIM_COMPANY, count(DIM_PERIOD) as JS from DW_FACTFINANCEPERIOD where DIM_ITEMPERIOD ='1416001' and DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD='2017'||'13' group by DIM_COMPANY)B on A.DIM_COMPANY=B.DIM_COMPANY) )) T2 on T1.SCODE = T2.DIM_COMPANY left join ( select DIM_COMPANY, sum(nvl(FACT_A,0)) as YEKHMB from DW_FACTTARGETASSESSMENT where DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD=concat(:year,'00') group by DIM_COMPANY) T3 on T1.SCODE = T3.DIM_COMPANY group by T1.ROOT_SCODE )T4 inner join ( select SCODE, SNAME from DW_DIMCOMPANY) TNAME on T4.ROOT_SCODE = TNAME.SCODE group by ROOT_SCODE, SNAME ) T6 left join ( select ROOT_SCODE, SNAME, C, D, round(decode(C,0,0,(D-C)/C),4)*100 as LRTBZJL from ( select ROOT_SCODE, SNAME, sum(FACT_B) C, sum(YEKHMB) D from ( select T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB from T1 left join ( select DIM_COMPANY, decode(JS,1,B2,B1) as FACT_B from ( select A.DIM_COMPANY, B1, B2, nvl(JS,0) as JS from ( ( select DIM_COMPANY, sum(decode(DIM_PERIOD,'2017'||'12', FACT_B,0)) as B1, sum(decode(DIM_PERIOD,'2017'||'13', FACT_B,0)) as B2 from DW_FACTFINANCEPERIOD where DIM_ITEMPERIOD ='1403100' and DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD in ('2017'||'12', '2017'||'13') group by DIM_COMPANY)A left join ( select DIM_COMPANY, count(DIM_PERIOD) as JS from DW_FACTFINANCEPERIOD where DIM_ITEMPERIOD ='1403100' and DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD='2017'||'13' group by DIM_COMPANY)B on A.DIM_COMPANY=B.DIM_COMPANY) ))T2 on T1.SCODE = T2.DIM_COMPANY left join ( select DIM_COMPANY, sum(nvl(FACT_B,0)) as YEKHMB from DW_FACTTARGETASSESSMENT where DIM_COMPANY in ( select SCODE from T1) and DIM_PERIOD=concat(:year,'00') group by DIM_COMPANY) T3 on T1.SCODE = T3.DIM_COMPANY )T4 inner join ( select SCODE, SNAME from DW_DIMCOMPANY) TNAME on T4.ROOT_SCODE = TNAME.SCODE group by ROOT_SCODE, SNAME ) ) T5 on T6.ROOT_SCODE = T5.ROOT_SCODE order by T5.ROOT_SCODE ) , T3 as ( select GSBM, GSMC, B.SPCODE, YEWC, a.fact_a YEMB, YETBZJL, LRWC, a.fact_b LRMB, LRTBZJL from t2 left join DW_FACTTARGETASSESSMENT a on a.DIM_COMPANY=GSBM and a.DIM_PERIOD=concat(:year,'00') left join DW_DIMCOMPANY B on GSBM=B.SCODE order by gsbm ) , t4 as ( select scode, sname from ( select scode, sname, '1' sflag from DW_DIMCOMPANY where CISDEL='N' and ( scode='1001' or spcode='1001') union all select scode, sname, '2' sflag from DW_DIMCOMPANY where CISDEL='N' start with scode=:company connect by prior scode=spcode) where sflag=decode(:company,'1001',1,2) ) select gsbm, GSMC, YEWC, YEMB, YETBZJL, LRWC, LRMB, LRTBZJL from t3 right join t4 on t3.gsbm=t4.scode order by t4.scode",
        // "sql2": " WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE IN ('1', 'R') START WITH SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) , t2 AS ( SELECT T6.ROOT_SCODE AS GSBM, T6.SNAME AS GSMC, A AS YEWC, B AS YEMB, ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL, C AS LRWC, D AS LRMB, LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE, SUM(NVL(T2.FACT_B,0)) AS fact_b, SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,'2018'||'12',FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,'2018'||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN ('2018'||'12', '2018'||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD='2018'||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE, SNAME, C, D, ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,'2018'||'12', FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,'2018'||'13', FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN ('2018'||'12', '2018'||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD='2018'||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ) SELECT GSBM, GSMC, B.SPCODE pid, YEWC, a.fact_a YEMB, YETBZJL, LRWC, a.fact_b LRMB, LRTBZJL FROM t2 LEFT JOIN DW_FACTTARGETASSESSMENT a ON a.DIM_COMPANY=GSBM AND a.DIM_PERIOD=:period LEFT JOIN DW_DIMCOMPANY B ON GSBM=B.SCODE ORDER BY gsbm ",
        // "sql2": " WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE IN ('1', 'R') START WITH SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) , t2 AS ( SELECT T6.ROOT_SCODE AS GSBM, T6.SNAME AS GSMC, A AS YEWC, B AS YEMB, ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL, C AS LRWC, D AS LRMB, LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE, SUM(NVL(T2.FACT_B,0)) AS fact_b, SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE, SNAME, C, D, ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12', FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13', FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ), T3 AS ( SELECT GSBM, GSMC, B.SPCODE, YEWC, a.fact_a YEMB, YETBZJL, LRWC, a.fact_b LRMB, LRTBZJL FROM t2 LEFT JOIN DW_FACTTARGETASSESSMENT a ON a.DIM_COMPANY=GSBM AND a.DIM_PERIOD=:period LEFT JOIN DW_DIMCOMPANY B ON GSBM=B.SCODE ORDER BY gsbm ) , t4 as ( select scode,sname from( select scode,sname,'1' sflag from DW_DIMCOMPANY where CISDEL='N' and (scode='1001' or spcode='1001') union all select scode,sname,'2' sflag from DW_DIMCOMPANY where CISDEL='N' start with scode=:company connect by prior scode=spcode) where sflag=decode(:company,'1001',1,2) ) SELECT gsbm, GSMC, YEWC,YEMB,YETBZJL,LRWC,LRMB,LRTBZJL FROM t3 right join t4 on t3.gsbm=t4.scode order by t4.scode",
        // "sql2": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE IN ('1', 'R') START WITH SCODE IN ( SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) , t2 as ( SELECT T6.ROOT_SCODE AS GSBM, T6.SNAME AS GSMC, A AS YEWC, B AS YEMB, ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL, C AS LRWC, D AS LRMB, LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE, SUM(NVL(T2.FACT_B,0)) AS fact_b, SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE, SNAME, C, D, ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE, SNAME, SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE, T2.FACT_B, T3.YEKHMB FROM T1 LEFT JOIN ( SELECT DIM_COMPANY, DECODE(JS,1,B2,B1) AS FACT_B FROM ( SELECT A.DIM_COMPANY, B1, B2, NVL(JS,0) AS JS FROM ( ( SELECT DIM_COMPANY, SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1, SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12', :yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN ( SELECT DIM_COMPANY, COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN ( SELECT DIM_COMPANY, SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN ( SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN ( SELECT SCODE, SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE, SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE ORDER BY T5.ROOT_SCODE ) select GSBM, GSMC,YEWC, a.fact_a YEMB, YETBZJL,LRWC, a.fact_b LRMB,LRTBZJL from t2 left join DW_FACTTARGETASSESSMENT a on a.DIM_COMPANY=GSBM and a.DIM_PERIOD=:period order by gsbm",
        // "sql2": "WITH T1 AS( SELECT CONNECT_BY_ROOT SCODE AS ROOT_SCODE, SCODE FROM DW_DIMCOMPANY WHERE CISDEL='N' AND STYPE in ('1','R') START WITH SCODE IN (SELECT SCODE FROM DW_DIMCOMPANY START WITH SCODE = :company CONNECT BY PRIOR SCODE = SPCODE) CONNECT BY PRIOR SCODE = SPCODE ) SELECT T6.ROOT_SCODE AS GSBM,T6.SNAME AS GSMC,A AS YEWC,B AS YEMB,ROUND(DECODE(A,0,0,(B-A)/A),4)*100 AS YETBZJL,C AS LRWC,D AS LRMB,LRTBZJL FROM ( SELECT ROOT_SCODE,SNAME,SUM(FACT_B) A, SUM(YEKHMB) B FROM ( SELECT T1.ROOT_SCODE,SUM(NVL(T2.FACT_B,0)) AS fact_b,SUM(NVL(T3.YEKHMB,0)) AS YEKHMB FROM T1 LEFT JOIN (SELECT DIM_COMPANY,DECODE(JS,1,B2,B1) AS FACT_B FROM( SELECT A.DIM_COMPANY, B1, B2,NVL(JS,0) AS JS FROM( (SELECT DIM_COMPANY,SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1,SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12',:yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN (SELECT DIM_COMPANY,COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1416001' AND DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) )) T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN (SELECT DIM_COMPANY,SUM(NVL(FACT_A,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY GROUP BY T1.ROOT_SCODE )T4 INNER JOIN (SELECT SCODE,SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE,SNAME ) T6 LEFT JOIN ( SELECT ROOT_SCODE,SNAME,C,D,ROUND(DECODE(C,0,0,(D-C)/C),4)*100 AS LRTBZJL FROM ( SELECT ROOT_SCODE,SNAME,SUM(FACT_B) C, SUM(YEKHMB) D FROM ( SELECT T1.ROOT_SCODE,T2.FACT_B,T3.YEKHMB FROM T1 LEFT JOIN (SELECT DIM_COMPANY,DECODE(JS,1,B2,B1) AS FACT_B FROM( SELECT A.DIM_COMPANY, B1, B2,NVL(JS,0) AS JS FROM( (SELECT DIM_COMPANY,SUM(DECODE(DIM_PERIOD,:yearBefore||'12',FACT_B,0)) AS B1,SUM(DECODE(DIM_PERIOD,:yearBefore||'13',FACT_B,0)) AS B2 FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD IN (:yearBefore||'12',:yearBefore||'13') GROUP BY DIM_COMPANY)A LEFT JOIN (SELECT DIM_COMPANY,COUNT(DIM_PERIOD) AS JS FROM DW_FACTFINANCEPERIOD WHERE DIM_ITEMPERIOD ='1403100' AND DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD=:yearBefore||'13' GROUP BY DIM_COMPANY)B ON A.DIM_COMPANY=B.DIM_COMPANY) ))T2 ON T1.SCODE = T2.DIM_COMPANY LEFT JOIN (SELECT DIM_COMPANY,SUM(NVL(FACT_B,0)) AS YEKHMB FROM DW_FACTTARGETASSESSMENT WHERE DIM_COMPANY IN (SELECT SCODE FROM T1) AND DIM_PERIOD=:period GROUP BY DIM_COMPANY) T3 ON T1.SCODE = T3.DIM_COMPANY )T4 INNER JOIN (SELECT SCODE,SNAME FROM DW_DIMCOMPANY) TNAME ON T4.ROOT_SCODE = TNAME.SCODE GROUP BY ROOT_SCODE,SNAME ) ) T5 ON T6.ROOT_SCODE = T5.ROOT_SCODE order by T5.ROOT_SCODE",
        "cube": {
            "cubeId": 4,
            "subject": "1005"
        },
        "mainDim": "itemperiod",
        "needDims": ["year", "month", "company", "conversion"],
        "random": { "min": 100, "max": 100000 },
        "type": 1,
        "tableHeads": true,
        "generateVar": { //生成变量rows
            "periodCount": 2,
            "compareType": "-1&0",
            "reverse": true
        }
    },
    "columns": [
        
        {
            "id": "scode",
            "type": "string",
            "text": "公司编码",
            // "fixed": true,
            "align": "left",
            "width": "200px"
        },
        {
            "id": "gsmc",
            "type": "string",
            "text": "公司名称",
            // "fixed": true,
            "align": "left",
            "width": "395px"
        },
        {
            "id": "",
            "type": "string",
            "text": "营业收入",
            "children": [{
                    "id": "yewc",
                    "type": "decimal",
                    "text": "上年实际完成",
                    "align": "right",
                    "width": "200px"
                },
                {
                    "id": "yemb",
                    "type": "decimal",
                    "align": "right",
                    "text": "本年目标考核值",
                    "width": "200px"
                },
                {
                    "id": "yetbzjl",
                    "type": "decimal",
                    "text": "同比增减率%",
                    "align": "right",
                    "width": "150px"
                }
            ]
        },
        {
            "id": "",
            "type": "string",
            "text": "利润总额",
            "children": [{
                    "id": "lrwc",
                    "type": "decimal",
                    "text": "上年实际完成",
                    "align": "right",
                    "width": "200px"
                },
                {
                    "id": "lrmb",
                    "type": "decimal",
                    "text": "本年目标考核值",
                    "align": "right",
                    "width": "200px"
                },
                {
                    "id": "lrtbzjl",
                    "type": "decimal",
                    "text": "同比增减率%",
                    "align": "right",
                    "conversion": "%",
                    "width": "150px"
                }
            ]
        }
    ],
    "rows": [],
    "items": [{
        "xtype": "elementTree",
        "id": "nmbkhjyz",
        "isUnfold": true,// 自动展开的配置
        "stype": false,
        "text": "集团年度目标考核建议值",
        "queryDataBefore": function(params, config, $vue) {
            // debugger
            if ($vue.id === "0014253678") {
                let yearBefore = params.year - 1;
                config.sql = config.sql2.replace(/:yearBefore/g, "'" + yearBefore + "'");
            }
            return params;
        },
        "toolbar": [{
            "id": "1",
            "text": "刷新",
            "xtype": "button",
            "cellStyle": {
                // "color": "black",
                // "background-color":"#189271"
                // "background-color": "#fff"
            },
            "handler": function(vue, btn) {
                // debugger
                console.log(vue);
                let $vue = vue.item.$vue;
                $vue.closeTabTaget({}, $vue);
                vue.item.updateView("company");
            }
        }, {
            "id": "2",
            "text": "导出",
            "xtype": "button",
            "cellStyle": {
                // "color": "black",
                // "background-color":"#189271"
                // "background-color": "#fff"
            },
            "handler": function(vue, btn) {
                // debugger
                console.log(vue);
                vue.handleDownload(vue);
            }
        }]
    }]
}